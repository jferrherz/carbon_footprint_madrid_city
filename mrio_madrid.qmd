---
title: "Local drivers and global suppliers of GHG emissions from the city of Madrid, 2010-2021"
draft: Chapter Two
format:
  aft-pdf:
    keep-tex: true 
  aft-html: default
latex-auto-install: true
date: last-modified
date-format: full
template-partials:
  - title.tex
  - before-body.tex
  - after-body.tex
  - _authors.tex
include-in-header: 
      text: |
        \usepackage{multirow}
        \usepackage{array}
        \usepackage{longtable}
        \usepackage{multicol}
        \usepackage{caption}
        \usepackage{rotating}
        \usepackage{pdflscape}
        \usepackage{float}
        \usepackage{fontspec}
        \usepackage{threeparttable}
        \captionsetup{justification=justified,singlelinecheck=false}
        \usepackage[LGRgreek]{mathastext}
        \usepackage{mathtools}
#\usepackage[capitalise,noabbrev]{cleveref}
#template: Chapter_CoLC_v3.tex            
author:
  - name: Jacobo Ferrer
    affiliation: 
      name: Universidad Politécnica de Madrid
    email: jacobo.ferrer@upm.es
    orcid: 0000-0002-7873-6275
  - name: Sergio Alvarez
    affiliation: 
      name: Universidad Politécnica de Madrid
    email: sergio.alvarez@upm.es
    orcid: 0000-0001-7204-502X
disclaimer: To the best of my knowledge, I have no conflicts of interest to disclose.
#abstract: Urban consumption significantly contributes to global greenhouse gas (GHG) emissions, with direct emissions accounting for only one-third of the total when including emissions embedded in imports. Estimating scope-3 emissions of urban consumption and economic activity is challenging due to insufficient disaggregation in available Supply and Use Tables (SUTs). This limitation has led to various bottom-up and top-down strategies to address the information gap, often relying on the adoption of simplified, domestic input-output modeling approaches. This study presents the first comprehensive estimation of total GHG emissions resulting from consumption and economic activity in Madrid, Spain. By integrating municipal-level National Accounts data with regional SUTs, we construct a series of city-specific input-output tables from 2010 to 2021 and incorporate them into the FIGARO Global Multi-Regional Input-Output (GMRIO) framework. Our analysis reveals that the city's total carbon footprint in 2019 was 19,396 ktCO2eq, with only 20\% originating from within the city limits. The rest of Spain and the world contributed 40\% each, highlighting the global nature of urban emissions. We find significant emissions inequality among residents, with the top 20\% of the spending distribution emitting 3.8 times more than the bottom 20\%. Structural decomposition analysis shows that while efficiency improvements and technological advancements contributed to emissions reduction, these gains were largely offset by increases in consumption demand. Notably, our simulations demonstrate that reshaping consumption patterns of high-income households could potentially reduce emissions by up to 10.5\%. The study underscores the need for consumption-oriented mitigation strategies and highlights the importance of addressing emissions inequality in urban climate action plans
keywords: carbon footprint, input-output, cities, mitigation planning, scope 3
bibliography: Paper_references.bib
biblio-style: apalike
cite-style: authoryear
geometry:
  - top=2.5cm
  - bottom=2.5cm
  - left=1.5cm
  - right=1.5cm
  - heightrounded
number-sections: true
page-layout: article
classoption:
  - twocolumn
fontsize: 10pt
fig-cap-location: bottom
execute:
  echo: false
  warning: false
  cache: true
---
<!--quarto install tinytex-->
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
library(stringr);library(tidyr);library(magrittr);library(dplyr);library(tibble);
library(readr);library(readxl);library(ggplot2);library(openxlsx);library(kableExtra);library(dplyr)
#database_path <- "/Users/jacoboferrerhernandez/Dropbox/Databases"
#paper_path    <- "/Users/jacoboferrerhernandez/Dropbox/03 - UPM - Environmental/environmental-extentions"
#datasets_path <- "/Users/jacoboferrerhernandez/Dropbox/03 - UPM - Environmental/environmental-extentions/datasets"
database_path <- "C:/Users/TOPOGRAFIA/Documents/Databases"
paper_path    <- "C:/Users/TOPOGRAFIA/ownCloud - gi.aga@drive.upm.es/Jacobo Ferrer/Projects/evironmental-extentions"
datasets_path <- "C:/Users/TOPOGRAFIA/ownCloud - gi.aga@drive.upm.es/Jacobo Ferrer/Projects/evironmental-extentions/datasets"
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
  set.seed(123535)
  years         <- seq(2013,2019) # This need to be checked every time there is an update to the database
  year_str      <- years[1]
  year_str_io   <- 2010
  year_end      <- years[length(years)]
  year_end_io   <- 2022
  year_str_city <- 2010
  year_end_city <- 2021
  year_ghg_appl <- 2021
  cou_footprint <- "ES30"
  emissions_mod <- "GHG"
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  names_list <- function(string_n){string_n_list <- paste0(paste0(string_n[1:(length(string_n)-1)],
  collapse=", "),", and ",string_n[length(string_n)]);return(string_n_list)}
```

```{r}
  #co2vec <- "$\\text{CO}_2$" #"$\\CO_2$"
  co2vec <- "$\\text{CO}_2e$" #"$\\CO_2$"
  ktco2vec <- "$\\text{ktCO}_2e$" #"$\\CO_2$"
  kgGHGvec <- "$\\text{kgCO}_2e$" #"$\\CO_2$"
```

# Introduction {#sec-introduction}
According to the IPCC Sixth Assessment Report, policy implementation will likely fall short of the carbon dioxide ($CO_2$) emissions targets implied in the Nationally Determined Contributions (NDCs) of the Paris Agreement announced ahead of the UN Climate Change Conference (COP26) [@ipcc_summary_2022]. Under the current scenario, limiting global warming to below 2°C will require a rapid acceleration of mitigation efforts in overall fossil fuel use after 2030. Such transformation will require drastic reductions in industry emissions for which sector-specific interventions may prove insufficient without substantial changes to consumption and mobility patterns [@ipcc_summary_2023]. For this purpose, urban areas are uniquely positioned to contribute to this type of mitigation efforts. Cities are responsible for a significant proportion of `r co2vec` emissions [@ipcc_climate_2023;@wiedmann_city_2021;@hoornweg_cities_2011] and, with global urban population at 56% and projected to host more than 70% in 2050 [@un_world_2022], its weight on decarbonization responsabilities will only continue to grow.

In the European context, Madrid is the second-largest metropolitan area of the European Union with over 6 million people [@eurostat_population_2024]. It is also one of the fastest-growing economic regions in Southern Europe [@eurostat_gross_2024]. At the center is the city of Madrid, which in 2022 had a population of 3.28 million inhabitants (6.9% of the country and 48% of the region), reached a GDP of \euro{}168 billion (12.7% of the Spanish GDP), and a per capita GDP of \euro{}51466 [@am_areas_2023;@amMadridEconomia20232023]. The service sector dominates the local economy (88.3%), specially in industries such as professional business activities, tourism, and trade, and it hosts only a modest amount of manufacturing activity (7.4%) [@am_areas_2023;@am_estructura_2013;@amRoadmapClimateNeutrality2022;@amMadridEconomia20232023]. It has few sources of primary energy, with no fossil fuel reserves or energy transformation plants, but a substantial level of energy consumption [@perez_methodology_2019]. The economic and demographic scale of the city make its firms and households fundamental drivers of direct and indirect `r co2vec` emissions in Spain. 

The City Council has repeatedly stated its commitment to tackling climate change [@am_inventario_2021]. After several plans guiding mitigation and adaptation interventions, the City Council approved the *Roadmap towards Climate Neutrality for 2050* (the Roadmap, hereafter) [@amRoadmapClimateNeutrality2022], which lays out a comprehensive plan to meet the objectives of the Paris Agreement and the EU Climate Agenda [@JRC130230]. In particular, the "Roadmap aims at reducing emissions in the city of Madrid by 65% by 2030, as compared to 1990, and to achieve climate neutrality by 2050" [@amRoadmapClimateNeutrality2022,p.3]. If direct emissions totaled 12954 `r ktco2vec` in 1990, this means that they should fall below 4534 `r ktco2vec` by 2030 [@amRoadmapClimateNeutrality2022, 12]. To monitor this evolution, the City Council produced the local *Air Pollutant Emissions Inventory* in addition to the *Energy Balance* of the municipality of Madrid. The Air Emissions Inventory (AEI) provides information for over two decades on "direct emissions (scope 1) and indirect emissions due to electricity consumption and distribution losses (scopes 2 and 3), broken down by sector of activity" [@amRoadmapClimateNeutrality2022,p.6]. This complex piece of information has been a crucial contribution to the quantification of the city's responsability in climate change, as well as an indispensable tool to evaluate the implementation of mitigation policies, specifically the Roadmap. According to the Council, these data indicate that Madrid seems on track to meet its mitigation goals within a conservative 'sustainable' scenario [@JRC130230;@amRoadmapClimateNeutrality2022].

Consequently, the construction of a city scale AEI have been an invaluable first step toward achieving *direct* `r co2vec` emissions reduction in Madrid. Nevertheless, we know that *indirect* emissions tend not only to be larger than direct emissions, but also grow in time as countries or cities transition towards a highly tertiarize economy. In the 2010s, coinciding with a growing number of cities setting net-zero emissions targets and producing `r co2vec` inventories using standard protocols, a literature studying the carbon footprint (CF) of cities started to quantify the extent of transboundary emissions [@wiedmann_city_2021]. These studies have shown time and again that direct emissions are but a fraction of the total CF of any urban area [@wiedmann_threescope_2021;@wiedmann_city_2021;@c40_future_2019;@eea_environmental_2013]. Since cities have offshored most of its energy production and manufacturing activity, so it has the `r co2vec` emissions requirements embodied in those imports [@wiedmann_threescope_2021]. The notion of emissions scopes separates clearly the visible from the invisible part of any CF. If inventories account for scope-1 or direct emissions, scopes-2 and -3 reflect the full carbon responsability of economic and domestic choices. In particular, scope-3 or embedded emissions are the hardest to quantify, but they account for the lion's share of the contribution to climate change [@creutzig_demand-side_2022;@wiedmann_city_2021;@chen_urban_2020;@moran_carbon_2018;@ivanova_mapping_2017;@wiedmann_concept_2016;@kennedy_egregious_2014]. According to @c40_future_2019[p. 16], around 85% of the consumption-based GHG emissions of C40's 94 members are generated outside the city boundaries, which influeces close to 10% of global emissions. Thus, increasing our knowledge about the geographical distribution of outsourced emissions is crucial to properly quantify cities' indirect emissions [@wiedmann_threescope_2021;@eea_environmental_2013]. Furthermore, by differentiating the geographical origin of emissions, we can identify possible international constraints on decarbonization ambitions [@remond-tiedrez_eu_2019].

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  city_emissions_gdp <- readRDS(file.path(datasets_path,"city_emissions_gdp.rds"))
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  library(tidyverse);library(dplyr);library(magrittr)
  total_direct_gdp_co2_change <- city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
  names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30") %>% select(cou,code,
  obs_value,year) %>% group_by(year) %>% summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0)) %>%
  left_join(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
  values_to = "obs_value") %>% filter(cou=="ES30"&grepl("ES30",counter)) %>% 
  select(cou,code,obs_value,year) %>% group_by(year) %>% summarize_at(c("obs_value"),
  ~round(sum(.,na.rm=TRUE),0)),by=c("year")) %>% set_names(c("year","total","direct")) %>%
  mutate_at(c("total"),~.-direct) %>% mutate(ratio=total/direct)
```

```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  library(RColorBrewer)
  mycolors <- rev(colorRampPalette(brewer.pal(5,"BrBG"))(5))
  total_direct_gdp_co2_change %>% pivot_longer(`total`:`ratio`,names_to="scope",
  values_to="obs_value") %>% pivot_wider(names_from="year",values_from="obs_value") %>% 
  mutate(base=`2010`) %>% mutate_at(c(as.character(2010:2021)),~.*100/base) %>%
  select(-base) %>% pivot_longer(`2010`:`2021`,names_to="year",values_to="obs_value") %>%
  mutate_at(c("scope"),~case_when(.=="direct"~"Scope 1",.=="total"~"Scopes 2-3",
  .=="ratio"~"Ratio S2-S3 to S1")) %>%
   ggplot(aes(y = obs_value, x = year,group=factor(scope,levels=c("Scope 1","Scopes 2-3",
   "Ratio S2-S3 to S1")),colour=factor(scope,levels=c("Scope 1","Scopes 2-3",
   "Ratio S2-S3 to S1")))) + geom_line(size=1)  + labs(fill='') + ylab("") +
    xlab("") + ylab(TeX("Normalized $\\CO_2e$ emissions (2010=100)")) + guides(fill=guide_legend(nrow=2)) +
    scale_x_discrete(breaks = seq(2010, 2021, by = 2)) + #scale_colour_brewer(type = "div") +
    scale_color_manual(values=mycolors[c(2,4,5)])+
    theme(text = element_text(size = 25),axis.ticks.x=element_blank(),
    axis.ticks.y=element_blank(),legend.position = "bottom",legend.title = element_blank())
  ggsave(file.path(getwd(),"paper","graphics",paste0("total_direct_series.pdf")),height = 6,width = 8)
```

City CFs show a particularly large discrepancy between production-based and consumption-based estimations [@c40_future_2019]. In addition to being substantially more open than countries to cross-boundary exchanges of material and financial flows, cities are richer on average [@wiedmann_city_2021]. The level of per capita consumption is closely correlated with total consumption-based emissions [@wiedmann_threescope_2021;@lopez_how_2017;@eea_environmental_2013]. Inequality contributes to shape the urban emissions profile by introducing heterogeneity in demand [@chancelClimateInequalityReport2023;@lopez_how_2017]. A well-known stylized fact of consumption is that the weight of essentials on family budgets, such as the amount spent on food or heating, declines as a function of the level of real income [@browningEngelLaw2018;@kausEngelLawCrosscountry2013;@chaiBackEngelEvidence2013]. Hence, different levels of inequality will introduce non-linear variations in total emissions as real income grows [@levinsonEnvironmentalEngelCurves2015]. Urban consumption patterns are not only heterogenous but also distinctive vis-à-vis rural areas [@lopez_assessing_2016;@wiedmann_city_2021], which controlling for the level of spending tend to be less `r co2vec` intensive [@corcoles_carbon_2024;@lopez_assessing_2016]. This have been connected to household's private transport and heating/cooling use [@corcoles_carbon_2024], which, given the economies of scale of urban transport systems, invites further scrutiny over private mobility choices. The combination of lifestyles, municipal regulation, agglomeration economies, and infraestructure limitations shape the peculiar structure of urban economies. Understanding the sources of heterogeneity of consumption demand and economic activity in urban areas are, thus, crucial to properly design mitigation and adaptation policies [@ipcc_climate_2023].

Although input-output analysis has been applied to cities for a long time, the lack of tables at city scale have drawn many researchers to use national coefficient tables and non-survey methods [@wiedmann_concept_2016;@fry_assessing_2018;@wiedmann_city_2021;@moran_carbon_2018]. The substantial differences in the carbon intensity of city products and activities often lead to overestimation of production-based CFs depending on the weight of industrial activity in the city or the institutional sectors included in the calculation [@fry_assessing_2018]. On the other hand, the lack of city-scale global multi-regional input-output tables (GMRIO) further distorts the interconnections of the city with the rest of the world, increasing the, often downward, bias in the estimation of consumption-based CFs. Similarly to the literature working on regional CFs, this bias often stems from the data quality compromises required to produce simultaneously thousands of city footprints [@moran_carbon_2018;@caro_mapping_2017;@eea_environmental_2013;@ivanova_mapping_2017]. The ability to focus on a single case opens the possibility to treat sources more carefully, and bring external validation to more comprehensive studies. Despite the availability of studies presenting information for many cities including Madrid [@andradeImplementingCitylevelCarbon2018;@c40_consumption-based_2018;@wiedmann_threescope_2021], they either fail to exploit the full potential of available information to improve estimation precision, or lack continuity and timeliness by presenting out-of-date single-year estimations.

<!--For instance, we calculate that while in `r format(year_str_io, scientific=FALSE)` the direct (scope 1) emissions generated by the city's GDP were approximately equal to `r format(round(as.vector(unlist(total_direct_gdp_co2_change |> dplyr::filter(year==year_str_io) |> dplyr::select(direct))),0), scientific=FALSE)` `r ktco2vec`, total indirect emissions (scopes 2 and 3) amounted to `r format(round(as.vector(unlist(total_direct_gdp_co2_change |> dplyr::filter(year==year_str_io) |> dplyr::select(total))),0), scientific=FALSE)` `r ktco2vec`. This is `r format(round(as.vector(unlist(total_direct_gdp_co2_change |> dplyr::filter(year==year_str_io) |> dplyr::select(ratio))),1), scientific=FALSE)` times higher. In `r format(year_end_city, scientific=FALSE)`, direct and indirect emissions totaled `r format(round(as.vector(unlist(total_direct_gdp_co2_change |> dplyr::filter(year==year_end_city) |> dplyr::select(direct))),0), scientific=FALSE)` `r ktco2vec` and `r format(round(as.vector(unlist(total_direct_gdp_co2_change |> dplyr::filter(year==year_end_city) |> dplyr::select(total))),0), scientific=FALSE)` `r ktco2vec`, respectively, or `r format(round(as.vector(unlist(total_direct_gdp_co2_change |> dplyr::filter(year==year_end_city) |> dplyr::select(ratio))),1), scientific=FALSE)` times more. -->

<!--To illustrate the importance of indirect emissions, @fig-evolution charts the growth of direct and indirect emissions from 2010 to 2021. We can see that, first, direct and indirect emissions have tended to compensate each other's fluctuations, which suggests that their drivers are different to some extent. Secondly, ratio of indirect to direct emissions indicates a more rapid decarbonization of imports than domestic production. Given the exceptionality of 2020, we need more recent information to form a proper judgement about the current trend in emissions.In general, even if we ignore the total `r ktco2vec` generated by the city's economy in 1990, we can be certain that a 65% reduction of the 3-scope total will not equal 4534 `r ktco2vec` in 2030, but a substantially higher figure that is incompatible with the carbon neutrality commitment by 2050.--> 

<!--![Evolution of direct $CO_2e$ emissions (scope 1), indirect $CO_2e$ emissions (scopes 2-3), and the ratio of the two in the city of Madrid. Source: Authors' own elaboration.](graphics/total_direct_series.pdf){#fig-evolution fig-pos='!ht'}-->

No coherent decarbonization target can be reached by offshoring the emissions we are responsible for. Ignoring the accounting gap is unacceptable given the committment displayed by the European Comission, e.g. the European Green Deal. Therefore, if local authorities are comitted to come to grips with their decarbonization targets, they need to quantify and factor the full scope of indirect emissions into their mitigation planning. If indirect emissions are not factored into decarbonization scenarios, we can be certain that a 65% reduction of emissions will not equal 4534 `r ktco2vec` in 2030, but a substantially higher figure that is incompatible with the carbon neutrality commitment by 2050. In this connection, the paper presents the most precise and complete estimation to date of the structure and evolution of Madrid's CF by looking at the supply and demand of `r co2vec` emissions along the entire global value chain. It aims to contribute to the growing literature on urban CFs by exemplifying the analytical potential of using city-augmented models in combination with household surveys to track the origin and characteristics of emissions generation from the supply and the demand side [@wiedmann_city_2021;@chen_urban_2020;@moran_carbon_2018;@c40_consumption-based_2018]. <!--We present the most precise and detailed consumption-based estimation of scope-3 `r co2vec` emissions to date for the city of Madrid within a global multi-regional input-output (GMRIO) framework and using a derived city emissions account. -->It aims to estimate and characterize the 3-scope CF of the city and to break down its drivers and suppliers by geographical area, industry, consumption purpose, and socio-demographic grouping. To do this, we project a city industry-by-industry input-output table (IOT) exploiting the regional supply and use framework (SUT) and 28-industry macro data from the municipal economic accounts [@am_areas_2023]. We embed the city table within the GMRIO framework provided by the *Full International and Global Accounts for Research in input-Output analysis* (FIGARO) database [@remond-tiedrez_eu_2019] to obtain as much geographical and industry detail as possible. We obtain city-level emission factors by constructing an air emissions account (AEA) from the city's inventory data [@am_inventario_2021] following Eurostat's methodology [@eurostat_manual_2015;@eurostat_european_2013]. Consumption spending and socio-demographic information about city residents come from the Spanish Household Budget Survey (ES-HBS), which we use to derive a city consumption vector following the steps explained by @cazcarro_linking_2022, as well as direct household emissions related to heat and transport activities as in @corcoles_carbon_2024. Additionally, we impute individual-household `r co2vec` volumes by 3-digit consumption purpose using aggregate emissions intensity per unit of nominal spending, with which we are able to present a bird's-eye view of the socio-demographic composition of the city's CF. <!---->Finally, we illustrate the potential of trade vis-à-vis consumption for mitigation policy via several emission reduction simulation scenarios based on supply chain reconfiguration and household behavior.<!---->

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
year_str_io   <- 2010
year_end_city <- 2021
budget_survey_hh_city <- readRDS(file.path(datasets_path,"budget_survey_hh_city.rds")) %>% as_tibble
city_emissions_gdp <- readRDS(file.path(datasets_path,"city_emissions_gdp.rds"))
code_indus64 <- readxl::read_xlsx(file.path(datasets_path,"industry_classification.xlsx"), col_names = TRUE,sheet = "industries")
code_countries <- readxl::read_xlsx(file.path(datasets_path,"Country_Codes_and_Names.xlsx"),
sheet = 1) %>% mutate(cou=CODE) %>% mutate_at(c("cou"),~if_else(.=="CN_X_HK","CN",.)) %>% 
mutate_at(c("AREA"),~if_else(.=="ES","Rest of Spain",.)) %>% bind_rows(data.frame(AREA="Madrid city",CODE="ES30",cou="ES30",`NAME`="Madrid city")) %>% mutate_at(c("NAME"),~if_else(is.na(.),cou,.)) %>% 
mutate(ref_area=case_when(AREA=="European Union (EU)" ~ "European Union",
AREA=="EU candidate countries" ~ "Rest of the World",AREA=="European Free Trade Association (EFTA)" ~ "Rest of the World",AREA=="Other European countries" ~ "Rest of the World",AREA=="EU candidate countries" ~ "Rest of the World",AREA=="Non-European countries" ~ "Rest of the World")) %>% mutate_at(c("ref_area"),~if_else(is.na(.),AREA,.)) %>% mutate_at(c("ref_area"),~if_else(cou=="ES","Rest of Spain",.))
code_industries <- readxl::read_xlsx(file.path(datasets_path,"Country_Codes_and_Names.xlsx"),
sheet = "nace_r2_d2")
code_iots_mad <- readxl::read_xlsx(file.path(datasets_path,"classification_iots_mad.xlsx"),
sheet = "Tabla")
code_iots_city <- readxl::read_xlsx(file.path(datasets_path,"classification_iots_mad.xlsx"),
sheet = "City") %>% filter(digits_full>2)
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  #### [A] GDP footprint
  cf_gdp_tot_2021 <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
  names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30") %>% select(cou,code,
  obs_value,year) %>% filter(year==year_end_city) %>% summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0)),0)))
  cf_gdp_dir_2021 <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
  names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&grepl("ES30",counter)) %>% 
  select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% summarize_at(c("obs_value"),
  ~round(sum(.,na.rm=TRUE),0)),0)))
  #### [B] Consumption footprint
  city_acounts_madrid <- readRDS(file.path(datasets_path,"city_accounts_madrid.rds")) %>% as_tibble
  pop_meassure <- budget_survey_hh_city %>% distinct(ANOENC,NUMERO,FACTOR,NMIEMB) %>% group_by(ANOENC) %>% 
  summarize_at(c("FACTOR"),~sum(.*NMIEMB,na.rm=TRUE))
  code_coicop_d2 <- readxl::read_xlsx(file.path(datasets_path,"epf_enlace_codigos_b9722.xlsx"),sheet = "Enlace_series (2d)")
  city_emissions_coicop <- readRDS(file.path(datasets_path,"city_emissions_coicop.rds"))
  temp_plot_coicop <- city_emissions_coicop %>% pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
  values_to = "obs_value") %>% separate(counter,c("counter_cou","counter_code"),
  sep="_",extra="merge") %>% left_join(code_countries %>% 
  mutate_at(c("ref_area"),~if_else(cou=="CN","China",.)) %>%
  mutate_at(c("ref_area"),~if_else(cou=="US","United States",.)) %>%
  distinct(ref_area,cou),by=c("counter_cou"="cou")) %>% 
  mutate_at(c("code"),~stringr::str_sub(.,1,2)) %>%group_by(cou,code,ref_area,year) %>%
  summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% left_join(code_coicop_d2,
  by=c("code"="coicop_g2d")) %>% rename("heading"="coicop_g2d_heading_short") %>% 
  rename("P3_S14"="obs_value") %>% ungroup()
  
  temp_plot_coicop_2021 <- temp_plot_coicop %>% filter(year==year_end_city) %>% group_by(code,heading) %>% 
  summarise_at(c("P3_S14"),~sum(.,na.rm=TRUE)) %>% ungroup
  cons_co2_tot   <- temp_plot_coicop %>% group_by(year) %>% 
  summarise_at(c("P3_S14"),~sum(.,na.rm=TRUE)) %>% ungroup
  house_co2_tot  <- city_acounts_madrid %>% filter(grepl("HH",nace_r2)) %>% group_by(year) %>% 
  summarize_at(c("ktCO2"),~sum(.,na.rm=TRUE)) %>% ungroup %>% left_join(cons_co2_tot,by=c("year")) %>% 
  left_join(pop_meassure,by=c("year"="ANOENC")) %>% rename("HH"="ktCO2") %>%
  mutate(`ktCO2`=HH+P3_S14,`ktCO2_pc`=ktCO2/(FACTOR/1e06))
  house_co2_tot_2021 <- as.vector(unlist(house_co2_tot %>% filter(year==year_end_city) %>% select(ktCO2)))
  house_co2_pc_2021 <- as.vector(unlist(house_co2_tot %>% filter(year==year_end_city) %>% select(ktCO2_pc)))
```

The outline of the rest of the paper is as follows. @sec-method presents the sources and methods used to derive the city-augmented GMRIO framework. In section [-@sec-method-gmrio] we briefly explain the computation method for the total CF in line with the literature. Section [-@sec-method-household] explains the information requirements and methodological choices involved in the derivation of a workable city final consumption vector using micro observations from the ES-HBS. In section [-@sec-method-city] we document the process by which we construct a city input-output series from `r format(year_str_io, scientific=FALSE)` to `r format(year_end_city, scientific=FALSE)` to be then included coherently within FIGARO, which includes the derivation of the rest-of-the-nation and international requirement coefficients. @sec-method-emissions explains the construction of the city AEA. <!---->Last for section [-@sec-method], [-@sec-subsec-decomposition] shows the methodology applied to obtain the structural decomposition of the city's CF into an intensity, a trade, a technology, and consumption level component, as well as how we are able to simulate changes to global supply chains parsimoniously.<!----> @sec-results presents the empirical results, which separates the perspective of the city's activity (GDP) in [-@sec-subsec-results-gdp] from households' consumption in [-@sec-subsec-results-households] <!---->and from the structural decomposition with the trade and consumption scenarios in [-@sec-decomposition-simulation]<!---->. In sections [-@sec-subsec-results-gdp] and [-@sec-subsec-results-households] we emphasize the geographical and group-wise (industry or consumption purpose) distribution of embedded emissions, but it is in the latter that we go in more depth about the distributional drivers of total emissions from the perspective of household choices. We conclude with a section [-@sec-implications] discussing the main takeaways, implications, and limitations of the empirical results.

# Methodology and sources {#sec-method}
<!--@sec-method develops the global multi-regional input-output model (GMRIO) and documents the characteristics and choices involved in augmenting it with city-level information. In subsection [-@sec-method-gmrio] we provide information on the source of the supply and use tables (SUTs) employed in the construction of the dataset from which we derive the results in section [-@sec-results]. We also discuss in subsection [-@sec-method-household] the choices we made in deriving a micro dataset with household information on direct and consumption-related emissions. In -->

## An GMRIO model for Scope-3 CF estimation {#sec-method-gmrio}
<!--### Leontief-inverse estimation of CFs-->
The methodology for estimating CFs by means of environmentally extended input-output models (EEIO) is well-supported by an extensive literature [@miller_input-output_2022;@ivanova_mapping_2017;@eurostat_manual_2015;@eea_environmental_2013;@martinezIdentifyingEnvironmentalFootprint2019]. The use of GMRIOs to distribute emissions along the global value chain further expands out ability to pin down the geografical origin of locally triggered emissions [@wiedmann_threescope_2021;@wiedmann_concept_2016;@remond-tiedrez_eu_2019]. Any CF can be calculated using the standard Leontief-inverse demand-pull input-output model shown in @eq-carbon-footprint [@miller_input-output_2022;@wiedmann_concept_2016].
$$
CF^p = \hat{\textbf{e}}(\textbf{I} - \textbf{A})^{-1}\hat{\textbf{y}} 
$$ {#eq-carbon-footprint}

where $\hat{\textbf{e}}$ is the diagonalized $1 \times n$ vector of emission factors<!--, obtained as the product of industry emissions and the inverse of the diagonalized $n \times n$ matrix of industry outputs $\textbf{E}\hat{\textbf{x}}^{-1}$-->. The Leontief inverse $(\textbf{I} - \textbf{A})^{-1}$ is a $n \times n$ total requirements matrix indicating the amount of inputs from the $n$ industries directly and indirectly required per unit of industry's $j$ output. The vector $\hat{\textbf{y}}$ is the $n \times 1$ final demand vector, which can also be a diagonalized ($n \times n$) or simply spread by the different demand components ($n \times d$), such as households' final consumption or government spending. In the case of a GMRIO, the dimensions span $m$ number of regions or countries, such that the Leontief inverse becomes an $mn \times mn$ matrix, and  $\textbf{e}^t$ and $\textbf{y}$ $mn \times 1$ vectors. One advantage of diagonalizing a unique final demand vector $\hat{\textbf{y}}$, regardless of it being final consumption or gross domestic product, is that it preserves the dimensions of the Leontief inverse and, thus, allows for a row-wise or column-wise perspective, depending on whether a supplier or driver approach is followed. The latter corresponds to the CF concept used henceforth.

The paper will present two different approaches as we select the city's GDP or households as our unit of analysis. On the one hand, we are interested in the bi-dimensional distribution of emissions by source industry and country of origin that the gross domestic product of the city of Madrid is responsible for. From this perspective, the unit of analysis is the domestic economic activity of the urban area, and it is bounded by the National Accounts rules determining what counts as economically meaningful activity [@lequiller_understanding_2014;@eurostat_european_2013]. On the other, we also want to investigate the emissions produced by households. These do not only include the direct and indirect emissions driven by household final consumption expenditure, but also those originating in heating, cooling, transportation or other household activities, which fall outside of market-oriented production. In the case of households, the $CF^h$ will be a combination of the emissions embedded in the goods and services purchased by households ($CF^p$) and those direct `r co2vec` emissions originated in their direct domestic activity ($CF^d$), which is divided in three different categories: transportation, heating/cooling, and other fugitive emissions.
$$
CF^h =  CF^d + CF^p
$$ {#eq-carbon-footprint-households}

We choose to derive symmetric industry-by-industry input-output tables (IOTs) from the city-projected regional supply and use tables (RSUTs) [@remond-tiedrez_eu_2019], organized according to the second revision of the Statistical Classification of Economic Activities in the European Community (NACE). However, we will move from industry-by-industry to product-by-product according to the Statistical classification of Products by Activity (CPA) as required by the necessary transformations applied to consumption microdata [@miller_input-output_2022;@cazcarro_linking_2022]. Whereas for GDP-related emissions it suffices to match the classification matrix and the emissions factors, results for household consumption come only after additional steps.

## A city-augmented FIGARO-GMRIO {#sec-method-city}

![City-augmented GMRIO structure. Source: Authors' own elaboration.](graphics/Diagrama.pdf){#fig-diagram fig-env="figure*" width=90%}

For the GMRIO framework, we rely on the global multi-regional supply and use tables (GMSUTs) provided in the *Full International and Global Accounts for Research in input-Output analysis* (FIGARO) database [@remond-tiedrez_eu_2019], which is an official EU statistics produced jointly by Eurostat and the Joint Research Centre of the European Commission. In its current 2024 edition, FIGARO covers the whole time series from 2010 to 2022 for the 27 EU Member States, the United Kingdom, the United States and another 17 main EU partners, plus a "rest of the world" region.

Following a series of authors [e.g. @corcoles_carbon_2024 and @wiedmann_threescope_2021], we understand how crucial is to balance practicality, granularity, and accuracy in the production of city CFs. In this regard, we go beyond using national tables and emission factors to approximate smaller territorial units, for which direct observations are lacking. At the same time, we retain the detailed information provided by the national database by embedding the new tables within global value chains. This paper expands the available FIGARO-GMRIO to include a symmetric input-output table of the city of Madrid, with the corresponding adjustment to the rest of the nation. Our approach takes inspiration from several contributions that propose innovative non-survey methods to derive city-scale IOTs or SUTs [see @wiedmann_threescope_2021;@moran_carbon_2018;@zheng_entropy-based_2022;@wiedmann_concept_2016]. The three main data sources on which we produce our estimation are, first, FIGARO's GMRIO 2010-2022 series, second, the RSUTs from the region of Madrid covering the period from `r format(year_str, scientific=FALSE)` to `r format(year_end, scientific=FALSE)`, and, third, the municipal accounts data running from 2010 to 2022. @fig-diagram describes the different elements involved in the compilation of the city-augmented FIGARO-GMRIO database, where the \textit{c}, \textit{n}, \textit{w} subscripts designate the city, the rest of the nation (RoN), and the rest of the world (RoW), respectively.

To arrive at this result, we initially apply the GRAS algorithm, a bi-proportional technique for updating IOTs with both positive and negative elements [@temurshoev_note_2013;@lenzen_comments_2007;@junius_solution_2003], to the `r format(year_str_io, scientific=FALSE)`-`r format(year_end_city, scientific=FALSE)` series of RSUTs using as constraints the row and column sums derived from the value added, intermediate input, and total output vectors provided by the municipal industry accounts as shown in equations [-@eq-row-sums] and [-@eq-column-sums]
\vspace{-3pt}
$$ b_i = x_i - \sum^k_{d=1} f_{i,d} $$ {#eq-row-sums}
$$ b_j = x_j - \sum^r_{s=1} v_{s,j} $$ {#eq-column-sums}

where $f_{i,d}$ are the $k$, $n \times 1$ vectors of final demand components, $v_{s,j}$ the $r$ individual $1 \times n$ vectors of value-added subcomponents, typically gross operating surplus, total labor compensation, and other taxes minus subsidies, $x_i$ and $x_j$ are the $n \times 1$ and $1 \times n$ vectors of final output, respectively, and $b_i$ and and $b_j$ are the $n \times 1$ and $1 \times n$ summation vectors of the $n \times n$ interindustry transactions matrix $\textbf{Z}=[z_{ij}]$. The vector of interindustry row sums $b_i$ is provided by the municipal accounts [@am_areas_2023], so only $b_j$ has to be derived. Due to the lack of information about the city's final demand, we obtain the final demand vector $f_i$ not by using equation [-@eq-row-sums], but by multiplying the row sums of the regional direct requirement coefficients times the municipal output vector. Furthermore, since the available RSUTs series is smaller than our target FIGARO series, we use the 2013 RSUT for years 2010 to 2012, and the 2019 RSUT for years 2020 onwards as templates for the missing coefficients.

As noted in the introduction, the region of Madrid is highly specialized toward the service sector, with negligible contributions from agriculture and only a modest one from manufacturing. Given this constraint, we find that approximating the city table by means of the regional table is almost certainly superior to using the national table. On the other hand, since the municipal accounts data follows a 28-industry NACE (rev.2) classification, we first aggregate the regional industry-by-industry symmetric table according to the municipal classification. Thanks to a many-to-one relationship between the regional and urban disaggregations, this poses no complication. Given that the regional matrix distinguishes between domestic and imported interindustry flows, we only need to aggregate both matrices to apply the GRAS algorithm so that later we can separate the two using the proportion of the original import flows to the corresponding domestic ones. This way we can estimate the $n \times n$ (n=28) interindustry city matrix, defined as $\textbf{Z}_{cc}$ in figure [-@fig-diagram].

Secondly, we need to estimate matrices $\textbf{Z}_{cn}$ and $\textbf{Z}_{nc}$, which corresponds to the exports from the city to the rest of the nation and the imports to the city from the rest of the nation. From the import side, we have an interindustry import matrix that we can use to separate the demand from the nation $\textbf{Z}_{nc}$ from that of the rest of the world $\textbf{Z}_{wc}$. To be efficient, we assume that the same proportion of the national to the foreign value of each interindustry flow $z_{i,j}$ applies to the distribution of imports at the city level. This assumes that firms in Madrid have the same incentive to purchase inputs from the rest of the world as Spanish firms in general, which is akin to a gravity assumption about extra-urban trade. Following @miller_input-output_2022[p. 475], we can obtain the total value of imports from the rest of the nation $z^{nc}_{i,j}$ as follows: 
\vspace{-1.5pt}
$$ z^{nc}_{i,j} = m^c_{i,j} - (m^n_{i,j}/z^n_{i,j}) = [1 - (m^n_{i,j}/z^n_{i,j})]m^c_{i,j}$$ {#eq-import-dist}
<!--$$ z^m_{i,j} = z_{i,j}\alpha = z^m_{i,j}\frac{z_{j}}{z^{es}_{j}}$$ {#eq-import-prop}-->

where $m^c_{i,j}$ is the total city imports, $m^n_{i,j}$ the total national imports, and $z^n_{i,j}$ the total value of domestic flows from industry $i$ to industry $j$, respectively. 

From the export side, we face additional difficulties to derive matrix $\textbf{Z}_{cw}$. Unlike in the case of imports, we lack a matrix of export coefficients from industry $j$ in the city to industry $i$ from the rest of the world. Furthermore, we have some concerns about the reported values in the regional tables, as unlike any other macro magnitude, they do not match the regional accounts provided by the regional and the national statistical offices. The only relevant pieces of information we preserve are the *aggregate* trade balance and the sectoral distribution of exports. We proceed, first, by adding up the *regional* trade balance to the city's import total to derive the aggregate level of exports. We then multiply this total by the industry export shares to apply the original distribution to the new level. This way we can have a $n \times 1$ vector of industry export totals as in equation [-@eq-export-dist],
\vspace{-3pt}
$$ e^{c}_{i} = (e^{r^\ast} - m^{r^\ast})(e^r_{i}/\sum^n_{i=1}e^r_{i}) $$ {#eq-export-dist}

where $e^{c}_{i}$ is the $n \times 1$ vector of city export totals by industry, $e^r_{i}$ the equivalent vector from the regional table, and $e^{r^\ast}$ and $m^{r^\ast}$ are the aggregate magnitude of exports and imports at the regional level, respectively. Note that the regional table is first of all transformed into industry-by-industry IOTs and then aggregated to match the city industry classification. 

At this point, we can apply the same procedure as in @eq-import-dist to split the total between the rest of the nation and the rest of the world. Basically, we multiply the level of exports computed in the previous step by the share of domestic and imported flows on total intermediate output from the Spanish national table. This way we find a distribution between the rest of the nation and the rest of the world assuming, again, that the pull from domestic intermediate supplies is proportional to the demand that the city makes from the rest of the nation. The full matrix of exports encompassing all countries and sectors is found by premultiplying the diagonalized vector of total industry exports to the rest of the world by the matrix of industry export shares from Spain to the rest of the world, where the normalizing constant is the total industry exports to the rest of the world from the country. Finally, we obtain the rest-of-the-nation matrix $\textbf{Z}_{nn}$ by substracting matrices $\textbf{Z}_{cc}$, $\textbf{Z}_{cn}$, and $\textbf{Z}_{nc}$ from the original Spanish national table, previously aggregated down to 28 industries to match the municipal accounts. 

Once all these pieces are ready, we can append them to the world interindustry matrix. However, to produce fully-fledged IOTs, we include the value added components from the city accounts (B2A3G, D29X39, and D1, as per the SNA 2010 definition), adjusting the national vector accordingly. We derive the vector of taxes minus subsidies on products (D21X31, as per the SNA 2010 definition) by allocating proportionally the national vector to the share of the city to the Spanish intermediate flows total. Due to the limited information on final demand components available in the city accounts, we decided to include only gross domestic product (GDP), which for all countries can be derived from the information available in FIGARO, final consumption of the household sector (P3_S14, as per the SNA 2010 definition), and final demand as the sum of consumption and investment (P3AP5, as per the SNA 2010 definition). We perform several checks on the final matrix to make sure that the totals from the new and the old matrix match for each interindustry transaction total, value added subcomponent, gross domestic product, final consumption of households, final demand, and total output (recomputed as column and row sums) to the $10^6$ decimal place.<!-- The online appendix provides the \href{https://www.dropbox.com/scl/fi/c9tgmksw9nv0qga2m9qf7/city_mrio_industry_final_extended_p3_s14.rds?rlkey=sfycrci40jrnl4ltkhjt2ulvc&dl=0}{full time series of world matrices} from `r format(year_str_io, scientific=FALSE)` to `r format(year_end_city, scientific=FALSE)` for the interested reader to explore.-->

## Matching consumption microdata and the supply and use framework {#sec-method-household}
In the input-output framework [@remond-tiedrez_eu_2019;@undesa_handbook_2018], household final consumption expenditure is aggregated into a single column vector containing final demand flows from each industry. With this vector $\textbf{y}^h$, it is possible to compute the CF of household consumption by industry. However, it is well-known that this aggregation suppresses information on the heterogeneity of the household sector, in addition to presenting the information in a product classification that is very different from the one that consumers can relate to in their spending choices [@mongelli_integrating_2010]. As explained by @cazcarro_linking_2022, in the absence of information about aggregate household consumption or if we desire to match household microdata to SUTs, we need to transform the spending information from household surveys into the IOTs' price and industry classifications. Household expenditures are typically recorded at purchaser's prices and according to the Classification of Individual Consumption by Purpose (COICOP), whereas households' final consumption expenditure is presented at basic prices and according to the CPA classification. Purchaser's prices are equal to producer's prices plus taxes minus subsides on products, which, in turn, are equal to basic prices plus domestic transportation costs and trade margins [@remond-tiedrez_eu_2019]. Each of these transformations require data that is often not reported for confidentiality reasons, which further complicates the estimation of the CF from the perspective of households' final consumption expenditure.

In this paper we are missing a city consumption vector. Following the CF regionalization literature, we exploit household-level data from the Spanish Household Budget Survey (ES-HBS) to derive it. To pin down which households are actual residents in the city of Madrid, we subset the ES-HBS by NUTS2 region and provincial capital, such that we can select all the available observations from residents. Notwithstanding this, it is an established fact that household surveys underestimate consumption totals by falling short of National Account's targets [@coli_distributional_2022;@ivanova_environmental_2016]. To make up for these relevant constraints, we follow the four-step procedure described in @cazcarro_linking_2022. Firstly, we correct the survey weights to match the Spanish population total from Eurostat's Sector Accounts. Secondly, we proportionally distribute the gap between the survey and National Accounts' totals at each 3-digit COICOP heading as recommended by @coli_distributional_2022. Thirdly, we transform the vector of COICOP macro totals into CPA by means of the estimated bridge matrix for Spain provided by @cazcarro_linking_2022 in their excellent online appendix. To update the table annually, we apply a GRAS algorithm to the appropriate consumption vectors at purchaser's prices in CPA and COICOP for each year [@temurshoev_note_2013]. Fourthly, we derive implicit transportation and tax margin rates and retrieve the vector of household consumption at basic prices, which matches the appropriate CPA vector in the SUTs. This step involves several intermediate operation and the use of the national SUTs to distribute taxes as well as trade and transportation margins. We first calculate transport and trade margins and derive implicit tax rates as a residual. Lastly, we apply the transformation matrix from the fixed sales structure model "D" to obtain the NACE industry vector with which we work to find footprint estimates [@miller_input-output_2022, ch. 4]. Conversely, when we present data on total emissions by consumption purpose in [@sec-subsec-results-households], we reverse the previous process by moving from NACE to COICOP classification using commodity-technology model "B" to revert back to CPA [@miller_input-output_2022, p. 203] and then the same bridge matrix used in the first place. This procedure returns the same totals in both classifications. However, we do not undo completely the transformation from purchaser's to basic prices. Since taxes have no meaning in terms of emissions, we stop at producer's prices.
<!--In general, our procedure to obtain consumption-based estimates departs slightly from the literature in two main respects. As distinct from @ivanova_environmental_2016 and others, we work with a grossed-up consumption vector according to Distributional National Accounts principles [@coli_distributional_2022;@cazcarro_linking_2022], so that the problem of underreporting is mitigated to some degree. Furthermore, we exploit a rich stock of information provided by the City Council and other statistical agencies to improve on the precision of available estimations of consumption- and activity-related emissions at the city level, which complements other contributions to the urban CF literature that have focused on the breath rather than the precission of the estimation [@wiedmann_threescope_2021;@wiedmann_concept_2016].-->

## Challenges in the derivation of city emissions factors {#sec-method-emissions}
Computing activity-related CFs requires data on `r co2vec` emissions matching the industry classification of the GMRIO tables. Eurostat provides GHG emission totals broken down by 64 industries (NACE) plus households, which are designed to be fully compatible with FIGARO tables. From these data it is straightforward to derive emissions factors relating GHG emitted by the entire national economy to specific macro aggregates, typically gross output (P1).^[Eurostat's definition of GHG includes $CO_2$ in addition to $N_2O$, $CH_4$, $HFC$, $PFC$, $NF_3$, and $SF_6$ in $CO_2e$.] One relevant limitation of Eurostat's AEAs is that it only covers EU Member States, EFTA Countries, and Candidate Countries. FIGARO's intended reach is, however, the entire global economy. Fortunately, FIGARO includes an application module reporting the CFs of all countries. Following @corcoles_carbon_2024, we reverse @eq-carbon-footprint to retrive the national emissions total for each country in FIGARO, and then aggregate the resulting vectors to match the 28-industry city classification.<!--Nevertheless, for FIGARO-only countries, the totals refer to $CO_2$ and not to GHG or $CO_2-eq$ emissions, which could lead to a non-trivial underestimation of emissions for those countries. To attenuate this problem, we use EDGARv8.0 database and Annex I of Eurostat's Manual for AEAs [@eurostat_manual_2015] to create a correspondence map between the IPCC sectors (CRF/NFR) from national inventories and NACE (rev.2) industries from the FIGARO footprint application. We use this map to proportionally allocate the $non-CO_2$ GHG emissions provided in EDGAR across industries. The implicit assumption is that all NACE industries have the same IPCC-sector emissions intensity. We finally aggregate the resulting vectors to match the reduced city classification, which includes 28 NACE industries.--> 

Since we operate with a city-augmented GMRIO model, we need a city AEA, which, unfortunately, does not exist. This imposes three main constraints on the derivation of emission factors for the city. First, inventories are based on the territorial principle, whereas emissions accounts follow the National Accounts convention of the residence principle [@eurostat_manual_2015]. Second, the standard inventory classification follows a functional, not an economic distribution, and, thus, it is not directly compatible with the GMRIO's working classification. Third, we lack access to the source information on emissions used in the construction of the city `r co2vec` inventory to ground the derivation of the corresponding accounts, so we need to rely on an approximation.

![Emissions factors by industry (NACE rev.2) for the city and the rest of the nation, 2021. *Source*: Authors' calculations based on Eurostat's, FIGARO, and regional and city accounts data](graphics/intensity_ratios_2021.pdf){#fig-intensity-ratio fig-env="figure*"}

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
city_acounts_madrid_2021 <- readRDS(file.path(datasets_path,"city_accounts_madrid.rds")) %>% as_tibble
city_acounts_madrid_2021 <- as.vector(round(unlist(city_acounts_madrid_2021 %>% filter(year==year_end_city) %>% select(ktCO2) %>% summarize(sum(ktCO2))),1))
city_inventory_2021 <- as.vector(round(sum(readxl::read_xlsx(file.path(database_path,
"Ayuntamiento","Inventario","inventario_madrid_2021.xlsx")) %>% set_names(c("year",
paste0("0",2:9),"10","11","TOT")) %>% filter(year==year_end_city) %>% select(-year,-TOT) %>% t),1))
growth_inventory_accounts <- as.vector(round(city_acounts_madrid_2021*100/city_inventory_2021,1))
```

To address these challenges, we start from the excellent city AEI released publically by the local administration for the period 1999-2021 [@am_inventario_2021]. The city's inventory reports all the kilotonnes of `r co2vec` emissions that occur within the limits of the city according to the Selected Nomenclature for Air Pollution (SNAP) sector classification, with the exception of SNAP 01 as no emissions of this type are found. It reports the same GHGs as Eurostat, with the exception of $NF_3$, for which there are no readings within the city limits. It follows the EMEP/CORINAIR methodology to estimate total atmospheric emissions, which causes small discrepancies with the IPCC methodology. 

We address these issues by following an inventory-first approach based on imputation and secondary information [@eurostat_manual_2015;@corcoles_carbon_2024;@sanchezserranoHuellaCarbonoHogares2023]. Firstly, we assume that changing from the territorial to the residence principle is possible using the share of the national bridge items on the national inventory total provided by Eurostat for land and water transport. For air transport we rely on data from @aena_estadisticas_2023 on airport operations. We allocate the share of Madrid's Barajas Airport over the national emissions balance from air travel, 18% in `r format(year_end_city, scientific=FALSE)`, to the sector of other transport (SNAP 08) in the city's inventory. Similarly, I assign `r format(growth_inventory_accounts, scientific=FALSE)`% of the balance of land transport (a rather small quantity) to road transport (SNAP 07). Hence, changing from one to another classification upscales the GHG total, excluding households direct emissions, from `r format(city_inventory_2021, scientific=FALSE)` `r ktco2vec` to `r format(city_acounts_madrid_2021, scientific=FALSE)` `r ktco2vec` in `r format(year_end_city, scientific=FALSE)`. Nevertheless, we regard this as a conservative estimation, since, from a National Accounts perspective, the emissions produced by many transport firms from the rest of the country should be considered part of the city's direct emissions. Due to lack of appropriate information, we do not pursue additional residence-principle adjustments.

Secondly, we exploit the information in Annex I of Eurostat's Manual for AEAs [@eurostat_manual_2015] to create a correspondence map between SNAP and NACE (rev.2). Unfortunately, it is not a one-to-one matching across classifications, so we rely on national data to derive a two-step bridge matrix to move from the 10-sector SNAP classification, in which the city inventory is presented, to the CRF/NFR classification used by national AEIs and, finally, to the 28-industry NACE classification to which the FIGARO GMRIO database has been aggregated to fit the estimated city IOTs. We construct two matrices $\textbf{S}$ and $\textbf{N}$ to achieve this transformation. The first one attaches to the CRF/NFR classification the corresponding national GHG totals from Eurostat's AEIs by source sector. Since there is a many-to-many relationship between the two classifications we distribute each AEI sector's total as a proportion on the SNAP row-sums total. In other words, we distribute each CRF/NFR total *proportionally* to the share of each total on the SNAP cross-CRF/NFR total. This way, we proxy the missing distributional information by the relative weight of each CRF/NFR code falling within individual SNAP categories. The resulting $s \times m$ matrix $\textbf{S}$, where $s$ is the number of SNAP codes and $m$ the corresponding CFR/NFR codes, is normalized by the SNAP row sum totals. The second matrix follows a similar procedure in which Eurostat's national industry totals from the AEA are proportionally distributed across CRF/NFR codes. We exclude households (HH_TRA, HH_HEAT, HH_OTH) from the list of NACE industries considered. The $m \times n$ matrix $\textbf{N}^t$ is normalized by the row totals of the corresponding CRF/NFR sectors. Using the city's inventory $e^{S}_{c}$, we derive the 28 NACE (rev.2) activities comprissing the city `r co2vec` emissions accounts $e^{N}_c$ as follows,
\vspace{-3pt}
$$ \textbf{e}^{N} = \textbf{e}^{S}\textbf{S}\textbf{N}^t $$ {#eq-bridge-accounts}

Thirdly, we introduce a series of modifications to $\textbf{S}\textbf{N}^t$ to accommodate the peculiarities of the city's economy. We redistribute 30% the use of solvents and other products (SNAP 06) to other direct emissions by households (HH_OTH), downscale Agriculture (A01-A03) to 10% of the national proportion for each SNAP sector, and eliminate all mining activity (B) altogether on the premise that it does not exist or it is negligible. Most importantly, we apply a reduction of 95% in the amounts produced by the electricity, gas, steam and air conditioning supply industry (D35), which together with mining (B), water collection, treatment and supply (E37) and sewerage, waste management, and remediation activities (E37-E39) make up the total of the composite industry of mining and supplies (B_E). After these modifications, we allocate proportionally the gap across the remaining industries to match the aggregate constraints.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  tem_enviro_figaro_year <- readRDS(file.path(datasets_path,"city_mrio_env_accounts.rds")) %>% as_tibble
  tem_enviro_figaro_year %<>% separate(code,c("cou","code"),sep="_",extra="merge") %>%
  filter(cou%in%c("ES","ES30")) %>% group_by(cou,year) %>%
  summarize_at(c("ktGHGF","P1"),~sum(.,na.rm=TRUE)) %>% mutate(factor=ktGHGF/P1) %>%
  select(cou,year,factor) %>%  pivot_wider(names_from = "cou",values_from = "factor") %>%
  filter(year==year_end_city) %>% select(-year)
  tem_enviro_figaro_year_es <- as.vector(round(unlist(tem_enviro_figaro_year%>% select(`ES`)),3))
  tem_enviro_figaro_year_ma <- as.vector(round(unlist(tem_enviro_figaro_year%>% select(`ES30`)),3))
```

The resulting city accounts match the corrected inventory totals by construction. We apply one additional correction to the intensities to upscale (downscale) those sectors which are underrepresented (overrepresented) in the city vis-à-vis the country by applying the ratio of the city to the rest of the nation's output shares. This causes some redistribution from manufacturing to services, which we deem reasonable given the service orientation of the city economy [@amMadridEconomia20232023]. Figure \ref{fig-intensity-ratio} compares the emissions factors for the city of Madrid and the rest of Spain. We can see that the two economies present some differences in both the distribution and the magnitude of the emissions per unit of output. Regarding the later, the emissions intensity for the whole economy was in `r format(year_end_city, scientific=FALSE)` of `r format(tem_enviro_figaro_year_es, scientific=FALSE)` and `r format(tem_enviro_figaro_year_ma, scientific=FALSE)` kg of `r co2vec` per unit of output for the rest of the nation and the city, respectively, which shows that the differences in magnitude are well within the general difference between the two economies. On the other hand, we observe a rather low intensity of transportation (H49_H53) and public administration (O85), and within tiny proportions for other services. Finaly, we subtract the city vector from the national one to derive the rest of the nation's `r co2vec` industry emission quantities. At this point, computing the emission intensity-ratios is trivially done by dividing industry `r co2vec` emissions by the corresponding gross output value (P1). Table 1 shows the totals broken down by direct emissions component, industries and the original inventory total.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  tem_enviro_city_year <- readRDS(file.path(datasets_path,"city_accounts_madrid.rds")) %>% as_tibble
  tem_enviro_city_hh <- tem_enviro_city_year %>% filter(grepl("HH",nace_r2)) %>%
  pivot_wider(names_from = "nace_r2",values_from = "ktCO2")
  hh_tra_2021 <- as.vector(round(unlist(tem_enviro_city_hh %>% filter(year==year_end_city) %>% 
  select(-year) %>% select(`HH_TRA`)),3))
  hh_heat_2021 <- as.vector(round(unlist(tem_enviro_city_hh %>% filter(year==year_end_city) %>% 
  select(-year) %>% select(`HH_HEAT`)),3))
  hh_other_2010 <- as.vector(round(unlist(tem_enviro_city_hh %>% filter(year==year_end_city) %>% 
  select(-year) %>% select(`HH_HEAT`)),3))
```
```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  library(kableExtra)
  tem_enviro_city_hh %>% left_join(tem_enviro_city_year %>% filter(!grepl("HH",nace_r2)) %>%
  pivot_wider(names_from = "nace_r2",values_from = "ktCO2") %>% group_by(year) %>%
  transmute(`Industries`=rowSums(across(`A`:`T`),na.rm=TRUE)),by=c("year")) %>% 
  #mutate(`Total`=rowSums(across(`HH_HEAT`:`Industries`),na.rm=TRUE)) %>%
  left_join(readxl::read_xlsx(file.path(database_path,"Ayuntamiento","Inventario",
  "inventario_madrid_2021.xlsx")) %>% set_names(c("year",paste0("0",2:9),"10","11","TOT")) %>%
  filter(year%in%c(seq(year_str_io,year_end_city))) %>% select(year,TOT),by=c("year")) %>%
  mutate_all(~round(.,1)) %>% set_names(c("Year","Heating","Transport","Other",
  "Industries","Inventory")) %>% 
  kbl(booktabs = T,"latex") %>% kable_styling(latex_options = c("hold_position"),font_size = 8)
```

A full AEA, however, must include direct emissions produced by household activities. Eurostat divides them into three categories: heating and cooling activities (HH_HEAT), transport activities (HH_TRA), and other emissions-producing activities (HH_OTH). The first two can be derived bottom-up from ES-HBS micro data. We estimate emissions from heating and transport activities by combining total quantities of different energy products with the appropriate emissions factors provided by MITECO [-@miteco_calculadora_2023]. There is no information to derive cooling-related emissions, and we exclude electricity as it represents scope-2 emissions that are included in the corresponding energy producing industry. An additional issue is that total direct transport emissions by households are larger than all the transport emissions reported in the city inventory. Besides the unlikely possibility that households build fuel stocks, this is likely due to household members driving to work outside the city limits. Since the latter uses direct measurements from road transport, we decide to exclude 30% of households direct transport emissions in order to substract households' road transport emissions from those made by firms and recorded in the inventory (SNAP 07). This, again, produces some redistribution before applying @eq-carbon-footprint. However, since the residence principle rules the construction of the accounts, this missing 30% from households direct emissions is kept for the purpose of reporting direct transport emissions by households; we found no reasonable criterion to substract the emissions from non-residents. Lastly, we reallocate 30% of total solvents and other products emissions (SNAP 06) from the city's inventory to other direct emissions by households. Table 1 shows the `r co2vec` total derived by household activities (heating/cooling, transport, other) and by economic activity across industries; we include the original AEI total reported by the City Council for reference.

\begin{table}[!h]
\centering\begingroup\fontsize{9}{10}\selectfont
\begin{tabular}[t]{cccccc}
\toprule
Year & Heating & Transport & Other & Industries & Inventory\\
\midrule
2010 & 1335.7 & 4139.2 & 375.4 & 5825.7 & 8899\\
2011 & 1385.5 & 3981.7 & 369.4 & 5295.4 & 8261\\
2012 & 2139.5 & 3426.1 & 364.3 & 4676.1 & 8043\\
2013 & 1357.4 & 3152.5 & 362.7 & 5386.0 & 7802\\
2014 & 1279.9 & 2951.3 & 360.8 & 5395.2 & 7441\\
2015 & 1529.2 & 3069.0 & 211.2 & 5157.4 & 7187\\
2016 & 1190.8 & 2930.1 & 208.2 & 5879.9 & 7429\\
2017 & 1301.3 & 2925.9 & 166.4 & 5645.3 & 7219\\
2018 & 2025.1 & 2986.1 & 128.7 & 5222.1 & 7501\\
2019 & 1424.3 & 3045.6 & 126.3 & 5720.3 & 7230\\
2020 & 1779.6 & 1820.5 & 108.0 & 3470.3 & 5880\\
2021 & 1593.9 & 2312.2 & 109.3 & 3986.2 & 6356\\
\bottomrule
\end{tabular}
\endgroup{}
\caption{Breakdown of household direct emissions by type of activity, city industry emissions total, and the original city GHG inventory total, expressed in `r ktco2vec`. \textit{Source}: Authors’ own calculations.\label{tab:total-emissions}}
\end{table}

<!---->
## Structural decomposition as a base for simulating trade shocks on total emissions growth {#sec-subsec-decomposition}
In @sec-decomposition-simulation, we use structural decomposition analysis (SDA) to disentangle the contribution by changes in emissions intensity, trade, technology, and final demand to the variation in industry-level emissions for the input-output model in equation [-@eq-carbon-footprint]. SDA methodology uses the main elements of the standard input-output model, such as the Leontief inverse and the final demand vector, to decompose the change in one variable into the changes of its constituent parts [@artoDriversGrowthGlobal2014]. The application of SDA to the quantification of the underlying sources of changes in `r co2vec` emissions has grown considerably in the last decade from Dietzenbacher and Los' seminal paper [-@dietzenbacherStructuralDecompositionTechniques1998]. More recently, papers by @hoekstra_emission_2016, @artoDriversGrowthGlobal2014, and @xuStructuralDecompositionAnalysis2014 have expanded on the original model to include additional decompositions to the the Leontief inverse and final demand vector to capture specific effects, such as separating trade and technology contributions, or distinguishing between the level and composition impacts of final demand. In this paper, SDA will allow us to break down the evolution of Madrid's consumption-based CF into the contribution of emissions intensities, consumption, trade, and technology. It must be noted that due to data limitations, the decomposition uses flows at current prices.

For this purpose, we introduce a few modifications to the canonical threefold decomposition in @miller_input-output_2022[sec. 13.1.5] or @dietzenbacherStructuralDecompositionTechniques1998. We start by defining $\Delta \varepsilon$ as the growth in the volume of `r co2vec` emissions between two periods, with superscripts $0$ and $1$ for the two different years, which in this case are `r format(year_str_io, scientific=FALSE)` and `r format(year_end_city, scientific=FALSE)`. By definition, $\Delta \varepsilon$ is the result of our standard model in the two periods as follows,
\vspace{-3pt}
$$
\begin{aligned}
\Delta \varepsilon &= \varepsilon^1 -\varepsilon^0=\mathbf{e}^1\mathbf{L}^1\hat{\mathbf{y}}^1 - \mathbf{e}^0\mathbf{L}^0\hat{\mathbf{y}}^0
\end{aligned}
$${#eq-varepsilon}
where $\mathbf{e}$, $\mathbf{L}$, $\hat{\mathbf{y}}$ are the $1 \times n$ `r co2vec` emissions intensity vector, the Leontief inverse, and the $n \times n$ diagonalized vector of final household consumption, respectively. From equation [-@eq-varepsilon] we can follow the standard SDA methodology [@dietzenbacherStructuralDecompositionTechniques1998;@miller_input-output_2022,sec. 13.1.1 to 13.1.5] to expand and rearrange the definition of $\Delta \varepsilon$ and break it down into the three components of the basic additive decomposition. As noted by @dietzenbacherStructuralDecompositionTechniques1998[p. 310], structural decompositions are non-unique, but taking the average of the two polar decompositions provides a sufficient approximation to the average of all possible approaches. @eq-sda-basic presents the threefold decomposition described by @miller_input-output_2022[13.1.5], which presents separately the effects of changes in emissions intensity, the technique of production, and final consumption demand, which add up to $\Delta \varepsilon$ by construction.
\vspace{-3pt}
$$
\begin{aligned}
\Delta \varepsilon&= \frac{1}{2}\underbrace{(\Delta \hat{\mathbf{e}})(\mathbf{L}^0\hat{\mathbf{y}}^0 + \mathbf{L}^1\hat{\mathbf{y}}^1)}_{\text{emissions intensity change}} \\ 
& + \frac{1}{2}\underbrace{\lbrack\hat{\mathbf{e}}^0(\Delta \mathbf{L})\hat{\mathbf{y}}^1 + \hat{\mathbf{e}}^1(\Delta \mathbf{L})\hat{\mathbf{y}}^0\rbrack}_{\text{technological change}} \\
& + \frac{1}{2}\underbrace{(\hat{\mathbf{e}}^0\mathbf{L}^0 + \hat{\mathbf{e}}^1\mathbf{L}^1)(\Delta \hat{\mathbf{y}})}_{\text{final consumption change}}
\end{aligned}
$${#eq-sda-basic}
However, the Leontief inverse captures and, thus, blurs differences in trade and technology. To tell the contributions from trade and technology apart, we draw from the decomposition within a multiregional framework of the $\mathbf{A}$ matrix into the Hadamard product of two component matrices, $\mathbf{C} \otimes \mathbf{H}$, as described in detail in @xuStructuralDecompositionAnalysis2014, @artoDriversGrowthGlobal2014, and @hoekstra_emission_2016. In this setting, matrix $\mathbf{H}$ contains the total intermediate input requirements irrespective of the source country, such that $z_{ij}^{s}=\sum_r z_{ij}^{rs}$, as described in @hoekstra_emission_2016. Conversely, matrix $\mathbf{C}$ contains the share of all inputs of good $i$ from country $s$ coming from country $r$, where the corresponding elements are derived as $c_{ij}=a_{ij}^{sr}/h_{ij}^r$.

Starting from $\mathbf{L}=(I - \mathbf{C} \otimes \mathbf{H})^{-1}$, @miller_input-output_2022[p. 607] show that $\Delta \mathbf{L} = \mathbf{L}^1(\Delta \mathbf{C}\mathbf{H})\mathbf{L}^0$, where $\Delta \mathbf{C}\mathbf{H}$ can be itself divided into the specific $\Delta \mathbf{C}$ and $\Delta \mathbf{H}$ effects,
\vspace{-3pt}
$$
\Delta \mathbf{C}\mathbf{H}=\frac{1}{2}(\Delta \mathbf{C})(\mathbf{H}^0 + \mathbf{H}^1) + \frac{1}{2}(\mathbf{C}^0 + \mathbf{C}^1)(\Delta \mathbf{H})
$$
Using this useful decomposition, we we can piece all previous elements together and split the technological change effect from [-@eq-sda-basic] into a trade and pure technique of production contribution, so that we can rewrite the decomposition formula and reach our final expression as follows
\vspace{-3pt}
$$
\begin{aligned}
\Delta \varepsilon&= \frac{1}{2}\underbrace{(\Delta \hat{\mathbf{e}})(\mathbf{L}^0\hat{\mathbf{y}}^0 + \mathbf{L}^1\hat{\mathbf{y}}^1)}_{\text{emissions intensity change}} \\ 
%& + \frac{1}{2}\underbrace{\lbrack\hat{\mathbf{e}}^0(\Delta \mathbf{L})\hat{\mathbf{y}}^1 + \hat{\mathbf{e}}^1(\Delta \mathbf{L})\hat{\mathbf{y}}^0\rbrack}_{\text{technological change}} \\
& + \frac{1}{4}\underbrace{ \lbrace \hat{\mathbf{e}}^0 \mathbf{L}^0 \lbrack \Delta \mathbf{C} \otimes (\mathbf{H}^0 + \mathbf{H}^1)  \rbrack \mathbf{L}^1 \hat{\mathbf{y}}^1 \rbrace }_{\text{trade structure change}} \\
& + \frac{1}{4}\underbrace{ \lbrace \hat{\mathbf{e}}^0 \mathbf{L}^0 \lbrack (\mathbf{C}^0 + \mathbf{C}^1) \otimes \Delta \mathbf{H} \rbrack \mathbf{L}^1 \hat{\mathbf{y}}^1 \rbrace }_{\text{technological change}} \\
& + \frac{1}{2}\underbrace{(\hat{\mathbf{e}}^0\mathbf{L}^0 + \hat{\mathbf{e}}^1\mathbf{L}^1)(\Delta \hat{\mathbf{y}})}_{\text{final demand change}}
\end{aligned}
$${#eq-str-decomp}

Splitting $\mathbf{A}$ into the element-wise product of matrices $\mathbf{C} \otimes \mathbf{H}$ presents us with the opportunity to simulate changes in trade patterns on the assumption that the technique of production remains unaffected. In section [-@sec-decomposition-simulation], after presenting the structural decomposition results, we introduce a series of simulation results to illustrate the potential effect of blunt decoupling or global supply chain restructuring on total consumption emissions. The premise is that substituting one supplier from another, even though these systemic transformations are very hard to come by in practice, may have a potentially beneficial or adverse contribution to decarbonization efforts. Furthermore, by providing a transparent quantification of this potential contribution we expect to facilitate the discussion about prioritizing local drivers or global suppliers in implementing decarbonization policies.

The overall approach consists in downscaling the participation of decoupling countries on the global supply of inputs to industry $j$ and, conversely, upscaling the input coefficient of the remaining industries by proportionally allocating the total amount of input value that is no longer coming from decoupling countries. We introduce this changes in matrix $\mathbf{C}$, which we then use to retrieve matrix $\mathbf{A}$ and $\mathbf{L}$, such that 
\vspace{-3pt}
$$
\mathbf{A}^{new}=\mathbf{C}^{new} \otimes \mathbf{H}^{old}
$$
From this point we simply follow the standard approach from section [-@sec-method] to derive the new emissions level and distribution.
<!---->

# Results {#sec-results}

## Industry drivers and suppliers of the city's GDP CF {#sec-subsec-results-gdp}
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
city_emissions_gdp <- readRDS(file.path(datasets_path,"city_emissions_gdp.rds"))
code_indus64 <- readxl::read_xlsx(file.path(datasets_path,"industry_classification.xlsx"), col_names = TRUE,sheet = "industries")
code_countries <- readxl::read_xlsx(file.path(datasets_path,"Country_Codes_and_Names.xlsx"),
sheet = 1) %>% mutate(cou=CODE) %>% mutate_at(c("cou"),~if_else(.=="CN_X_HK","CN",.)) %>% 
mutate_at(c("AREA"),~if_else(.=="ES","Rest of Spain",.)) %>% 
bind_rows(data.frame(AREA="Madrid city",CODE="ES30",cou="ES30",`NAME`="Madrid city")) %>% 
mutate_at(c("NAME"),~if_else(is.na(.),cou,.)) %>% 
mutate(ref_area=case_when(AREA=="European Union (EU)" ~ "European Union",
AREA=="EU candidate countries" ~ "Rest of the World",AREA=="European Free Trade Association (EFTA)" ~ "Rest of the World",
AREA=="Other European countries" ~ "Rest of the World",AREA=="EU candidate countries" ~ "Rest of the World",
AREA=="Non-European countries" ~ "Rest of the World")) %>% mutate_at(c("ref_area"),~if_else(is.na(.),AREA,.)) %>% 
mutate_at(c("ref_area"),~if_else(cou=="ES","Rest of Spain",.))
code_industries <- readxl::read_xlsx(file.path(datasets_path,"Country_Codes_and_Names.xlsx"),
sheet = "nace_r2_d2")
code_iots_mad <- readxl::read_xlsx(file.path(datasets_path,"classification_iots_mad.xlsx"),
sheet = "Tabla")
code_iots_city <- readxl::read_xlsx(file.path(datasets_path,"classification_iots_mad.xlsx"),
sheet = "City") %>% filter(digits_full>2)
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
cf_gdp_tot_2021 <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30") %>% select(cou,code,
obs_value,year) %>% filter(year==year_end_city) %>% summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0)),0)))
cf_gdp_dir_2021 <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&grepl("ES30",counter)) %>% 
select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% summarize_at(c("obs_value"),
~round(sum(.,na.rm=TRUE),0)),0)))

cf_gdp_tot_2010 <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30") %>% select(cou,code,
obs_value,year) %>% filter(year==year_str_io) %>% summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0)),0)))
cf_gdp_dir_2010 <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&grepl("ES30",counter)) %>% 
select(cou,code,obs_value,year) %>% filter(year==year_str_io) %>% summarize_at(c("obs_value"),
~round(sum(.,na.rm=TRUE),0)),0)))
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
cf_2021_Mad <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&grepl("ES30",counter)) %>% 
select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% summarize_at(c("obs_value"),
~round(sum(.,na.rm=TRUE),0)),0)))
cf_2021_RoN <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&grepl("ES",counter)&
!grepl("ES30",counter)) %>% select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% 
summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0)),0)))
cf_2021_RoW <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&!grepl("ES",counter)) %>% 
select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% summarize_at(c("obs_value"),
~round(sum(.,na.rm=TRUE),0)),0)))
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
cf_2010_Mad <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&grepl("ES30",counter)) %>% 
select(cou,code,obs_value,year) %>% filter(year==year_str_io) %>% summarize_at(c("obs_value"),
~round(sum(.,na.rm=TRUE),0)),0)))
cf_2010_RoN <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&grepl("ES",counter)&
!grepl("ES30",counter)) %>% select(cou,code,obs_value,year) %>% filter(year==year_str_io) %>% 
summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0)),0)))
cf_2010_RoW <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&!grepl("ES",counter)) %>% 
select(cou,code,obs_value,year) %>% filter(year==year_str_io) %>% summarize_at(c("obs_value"),
~round(sum(.,na.rm=TRUE),0)),0)))
```
We estimate the total CF of the city's gross domestic product (GDP) in `r format(year_end_city, scientific=FALSE)` to be in the order of `r format(cf_gdp_tot_2021, scientific=FALSE)` `r ktco2vec`, from which `r format(cf_gdp_dir_2021, scientific=FALSE)` `r ktco2vec` are direct `r co2vec` emissions generated within the city limits. This is `r format(round(cf_gdp_tot_2021*100/cf_gdp_tot_2010,1), scientific=FALSE)`% of the emissions estimated for `r format(year_str_io, scientific=FALSE)`, when the total CF of domestic activity was `r format(cf_gdp_tot_2010, scientific=FALSE)` `r ktco2vec`, of which `r format(cf_gdp_dir_2010, scientific=FALSE)` `r ktco2vec` resulted from direct emissions.<!--This indicates that <!--the strong `r format(round((cf_gdp_dir_2021-cf_gdp_dir_2010)*100/cf_gdp_dir_2010,2), scientific=FALSE)`% growth in direct `r co2vec` has been compensated by-> a slight decline of embedded emissions has taken place while direct emissions remain almost unchanged, driving a similarly mild decline in the total CF--> In `r format(year_end_city, scientific=FALSE)`, `r format(round(cf_2021_Mad*100/cf_gdp_tot_2021,0), scientific=FALSE)`% of emissions came from the city, whereas the rest of the nation and the rest of the world contributed by `r format(round(cf_2021_RoN*100/cf_gdp_tot_2021,0), scientific=FALSE)`% and `r format(round(cf_2021_RoW*100/cf_gdp_tot_2021,0), scientific=FALSE)`%, respectively. Conversely, in `r format(year_str_io, scientific=FALSE)`, the rest of the world accounted for `r format(round(cf_2010_RoW*100/cf_gdp_tot_2010,0), scientific=FALSE)`% and the rest of the nation for `r format(round(cf_2010_RoN*100/cf_gdp_tot_2010,0), scientific=FALSE)`% of total emissions. We observe a decline in total emissions but an increased relevance of the global supply, as the rest of the world captures a substantially larger share of scope-3 emissions.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  #### ratio of China to United States
  ratio_cn_us <- city_emissions_gdp %>% filter(cou=="ES30") %>% select(-kgC02_eq) %>%
  pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",values_to = "obs_value") %>% 
  separate(counter,c("counter_cou","counter_code"),sep="_",extra="merge") %>% 
  mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% left_join(code_countries %>% 
  mutate_at(c("ref_area"),~if_else(cou=="CN","China",.)) %>%
  mutate_at(c("ref_area"),~if_else(cou=="US","United States",.)) %>%
  distinct(ref_area,cou),by=c("counter_cou"="cou")) %>% group_by(ref_area,year) %>% 
  summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% rename("GDP"="obs_value") %>%
  filter(ref_area%in%c("China","United States")) %>% 
  pivot_wider(names_from="ref_area",values_from="GDP") %>% 
  mutate(ratio=`China`/`United States`)
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  ratio_cn_us_2010 <- as.vector(unlist(ratio_cn_us %>% filter(year==year_str_io) %>% select(ratio)))
  ratio_cn_us_2021 <- as.vector(unlist(ratio_cn_us %>% filter(year==year_end_city) %>% select(ratio)))
  cn_2010 <- as.vector(unlist(ratio_cn_us %>% filter(year==year_str_io) %>% select(China)))
  cn_2021 <- as.vector(unlist(ratio_cn_us %>% filter(year==year_end_city) %>% select(China)))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  #### [d] Import and emissions factors weights by country
  city_mrio_industry_final <- readRDS(file.path(datasets_path,"city_mrio_industry_final_extended_p3_s14.rds"))
  imports <- city_mrio_industry_final %>% mutate(import_demand=rowSums(across(`ES30_A`:`ES30_T`),
  na.rm=TRUE)) %>% select(code,import_demand,year) %>% separate(code,c("cou","code"),sep="_",
  extra="merge") %>%filter(cou%in%c("CN","US")&year%in%c(year_str_io,year_end_city)) %>% 
  pivot_wider(names_from = "year",values_from = "import_demand")
```
```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  factors <- city_mrio_env_accounts %>% select(code,factor,year) %>% separate(code,c("cou","code"),sep="_",extra="merge") %>% filter(cou%in%c("CN","US","DE")&year%in%c(year_str_io,year_end_city)) %>% pivot_wider(names_from = "year",values_from = "factor") %>% mutate(`%`=(!!sym(paste0(year_end_city))-!!sym(paste0(year_str_io)))/!!sym(paste0(year_str_io)))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  us_m_2010 <- as.vector(unlist(imports %>% filter(cou=="US"&code=="B_E") %>% select(!!sym(paste0(year_str_io)))))
  us_m_2021 <- as.vector(unlist(imports %>% filter(cou=="US"&code=="B_E") %>% select(!!sym(paste0(year_end_city)))))
```

@fig-cf-growth-period shows the time series of emissions volume by source area from `r format(year_str_io, scientific=FALSE)` to `r format(year_end_city, scientific=FALSE)`. To zoom in on the underlying trends, the European Union, the United States, and China have been separated from the rest of the world's total. In general we observe a decline for all source areas in accordance with a declining total. Nevertheless, across the period we observe a redistribution of emissions from China to the United States after a period reversal from 2014 to 2018. The ratio of total emissions coming from China to those from the United States went down from `r format(round(ratio_cn_us_2010,2), scientific=FALSE)` to `r format(round(ratio_cn_us_2021,2), scientific=FALSE)`, which amounts to `r format(round(cn_2010-cn_2021,2), scientific=FALSE)` `r ktco2vec`. This concentrates on mining and energy supply (B_E), whose emissions declined for China but shot up for the United States. The same tendency can also be observed for other sectors such as manufacturing of chemicals, coke and petroleum products (C19_C21), manufacture of other machinery and equipment (C_28) or wholesale and retail trade (G45YG47). In the case of mining and energy supply, imports from China fell slightly whereas those of the United States went up from `r format(round(us_m_2010,2), scientific=FALSE)` to `r format(round(us_m_2021,2), scientific=FALSE)` million euros. Nonetheless, looking at emissions factors, we can observe that there are similar improvements in efficiency in China versus the US for mining and energy supply, whereas for other equipment or trade the efficiency gains almost double the ones realized in the US or Germany. Hence, even with expanding demand for manufactures, the relative and absolute decline is noticeable in the time series.

![Decomposition of `r ktco2vec` emissions growth by main geographical area, 2010-2021 (2010=100). *Source*: Authors' own calculations](graphics/emisiones_crecimiento_por_pais_2021.pdf){#fig-cf-growth-period fig-pos='!ht'}

![Distribution of `r ktco2vec` emissions by supplier and driver sector, 2021. *Note*: only sectors contributing in more than 5% are labeled in the plot. *Source*: Authors' own calculations](graphics/emisiones_pie_chart_2021.pdf){#fig-cf-supplier-driver}

![Evolution of total `r kgGHGvec` per unit of city GDP, 2010-2021 (2010=100). *Source*: Authors' own calculations](graphics/factores_crecimiento_por_sector_2021.pdf){#fig-cf-growth-factors}

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
cf_B_E_2021 <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&code=="B_E") %>% 
select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% summarize_at(c("obs_value"),
~round(sum(.,na.rm=TRUE),0)),0)))
cf_B_E_2021_RoN <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&grepl("ES",counter)&code=="B_E"&
!grepl("ES30",counter)) %>% select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% 
summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0)),0)))
cf_B_E_2021_RoW <- as.vector(unlist(round(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% filter(cou=="ES30"&!grepl("ES",counter)&code=="B_E") %>% 
select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% summarize_at(c("obs_value"),
~round(sum(.,na.rm=TRUE),0)),0)))
```

In the same way that upstream emissions come predomintly from energy and transportation industries, learning about the sectors driving indirect emissions presents the responsibilities in a clear way. Incidentaly, this enhences the ability to target the correct industries for environmental policies at city scale. @fig-cf-supplier-driver aggregates the contribution of 2-digit industries as suppliers and drivers of emissions by aggregating the row or column totals from the CF matrix in equation [-@eq-carbon-footprint], respectively. The first bar indicates that three sectors: mining and energy products (B_E), manufacturing (C), and transportation and storage (H), account for more than 90% of total emissions embedded on goods and services imported by domestic expenditures. Conversely, from the standpoint of the city's final demand, we see that sector responsibility is more balanced, even if the same sectors together with wholesale and retail trade (G) trigger 50% of total city emissions.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
cf_G_2021_tot <- as.vector(unlist(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
values_to = "obs_value") %>% mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% 
filter(cou=="ES30"&code=="G") %>%  select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% 
summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0))))
cf_G_2021_RoN <- as.vector(unlist(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% 
filter(cou=="ES30"&grepl("ES",counter)&code=="G") %>%  select(cou,code,obs_value,year) %>% 
filter(year==year_end_city) %>% summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0))))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
cf_H_2021_tot <- as.vector(unlist(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
values_to = "obs_value") %>% mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% 
filter(cou=="ES30"&code=="H") %>%  select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% 
summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0))))
cf_H_2021_RoN <- as.vector(unlist(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% 
filter(cou=="ES30"&grepl("ES",counter)&code=="H") %>%  select(cou,code,obs_value,year) %>% 
filter(year==year_end_city) %>% summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0))))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
cf_J_2021_tot <- as.vector(unlist(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
values_to = "obs_value") %>% mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% 
filter(cou=="ES30"&code=="J") %>%  select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% 
summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0))))
cf_J_2021_city <- as.vector(unlist(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% 
filter(cou=="ES30"&grepl("ES30",counter)&code=="J") %>%  select(cou,code,obs_value,year) %>% 
filter(year==year_end_city) %>% summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0))))
```

Looking at the driver industries of the city's CF, figure [-@fig-cf-sector-source] shows the two-dimensional distribution of the total CF of the city broken down by industry and main source area. The first thing to notice is the strong discrepancy between direct and indirect emissions, but also how the gap behaves across industries. As noted in figure [-@fig-cf-supplier-driver], the largest contributor is the composite sector of mining and energy supply (B, E), which accounts for `r format(cf_B_E_2021, scientific=FALSE)` `r ktco2vec`. They come predominantly from the city, but in `r format(year_end_city, scientific=FALSE)` `r format(cf_B_E_2021_RoN, scientific=FALSE)` `r ktco2vec` were imported from the rest of Spain and `r format(cf_B_E_2021_RoW, scientific=FALSE)` `r ktco2vec` from the rest of the world. The situation changes for other industries. The second largest driver is the wholesale and retail industry (G), in which the rest of Spain dominates with `r format(round(cf_G_2021_RoN*100/cf_G_2021_tot,0), scientific=FALSE)`% of the total. An even larger `r format(round(cf_H_2021_RoN*100/cf_H_2021_tot,0), scientific=FALSE)`% share is obtained for transportation and storage, but the picture holds for most sectors. This highlights how urban economies are crucially integrated within larger metropolitan or country-spanning economic agglomerations.

![Total embedded GDP-linked emissions from Madrid by sector and geographical origin, 2021. *Note*: Agriculture (A) and Household activities (T) are excluded due to very low amounts. *Source*: Authors' own calculations](graphics/emisiones_gdp_madrid_area_industry_ES30_2021.pdf){#fig-cf-sector-source fig-env="figure*" width=100% fig-pos="!ht"}

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
cf_J_2021_tot <- as.vector(unlist(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
values_to = "obs_value") %>% mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% 
filter(cou=="ES30"&code=="J") %>%  select(cou,code,obs_value,year) %>% filter(year==year_end_city) %>% 
summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0))))
cf_J_2021_city <- as.vector(unlist(city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,
names_to = "counter",values_to = "obs_value") %>% mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% 
filter(cou=="ES30"&grepl("ES30",counter)&code=="J") %>%  select(cou,code,obs_value,year) %>% 
filter(year==year_end_city) %>% summarize_at(c("obs_value"),~round(sum(.,na.rm=TRUE),0))))
```

Interestingly for Madrid, the industry of ICT activities (J), which is one of the main growth engines and vectors of specialization of the city economy, has a relatively large scope-3 CF. This works as a cautionary tale about the need to include upstream emissions to properly evaluate the environmental standing of service-driven growth. If the domestic footprint of the industry reaches a relatively modest `r format(cf_J_2021_city, scientific=FALSE)` `r ktco2vec`, the direct plus indirect emissions total reaches `r format(cf_J_2021_tot, scientific=FALSE)` `r ktco2vec`. The same can be said of other economic bulwarks such as business and scientific activities (M) or hotels and restaurants (I).

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
kgGHG_euro_gdp_factor <- city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",values_to = "obs_value") %>%  mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% filter(cou=="ES30") %>% 
select(cou,code,obs_value,year) %>% group_by(cou,code,year) %>% summarize_at(c("obs_value"),
~sum(.,na.rm=TRUE)) %>% left_join(city_mrio_industry_final %>% 
separate(code,c("cou","code"),sep="_",extra="merge") %>% 
filter(code%in%c(as.vector(unlist(code_iots_city %>% 
filter(type=="sector") %>% distinct(nace_code))))) %>% select(cou,code,GDP,year) %>% 
filter(cou=="ES30") %>% mutate_at(c("code"),~stringr::str_sub(.,1,1)) %>% group_by(cou,code,year) %>% summarize_at(c("GDP"),~sum(.,na.rm=TRUE)) %>% mutate_at(c("year"),~as.character(.)),
by=c("cou","code","year")) %>% mutate(kgGHGgdp=obs_value/GDP) %>% select(cou:year,kgGHGgdp) %>% ungroup %>% 
pivot_wider(names_from = "year",values_from = "kgGHGgdp") %>% mutate(`2010_b`=!!sym(paste0(year_str_io))) %>% 
mutate_at(c(as.character(year_str_io:year_end_city)),~./`2010_b`) %>% select(-`2010_b`) %>%
mutate(type=if_else(!!sym(paste0(year_end_city))>0.85,"stagnant","progressive")) %>% filter(!code=="T") %>% 
mutate(growth=(!!sym(paste0(year_end_city))-!!sym(paste0(year_str_io)))/!!sym(paste0(year_str_io))) %>% mutate_at(c("code"),~if_else(code=="B","B_E",.)) 
  
kgGHG_euro_gdp_c_factor <- city_emissions_gdp %>%  pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
values_to = "obs_value") %>% filter(cou=="ES30") %>% select(cou,code,obs_value,year) %>% 
group_by(cou,code,year) %>% summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% 
left_join(city_mrio_industry_final %>% separate(code,c("cou","code"),sep="_",extra="merge") %>% 
filter(code%in%c(as.vector(unlist(code_iots_city %>% filter(type=="sector") %>% distinct(nace_code))))) %>% select(cou,code,GDP,year) %>% filter(cou=="ES30") %>% group_by(cou,code,year) %>% summarize_at(c("GDP"),
~sum(.,na.rm=TRUE)) %>% mutate_at(c("year"),~as.character(.)),by=c("cou","code","year")) %>%
mutate(code_2d=stringr::str_sub(code,1,1)) %>% filter(code_2d=="C") %>% mutate(kgGHGgdp=obs_value/GDP) %>% select(cou:year,kgGHGgdp) %>% ungroup %>%  pivot_wider(names_from = "year",values_from = "kgGHGgdp") %>% 
mutate(`2010_b`=!!sym(paste0(year_str_io))) %>% mutate_at(c(as.character(year_str_io:year_end_city)),~./`2010_b`) %>% select(-`2010_b`) %>%
mutate(type=if_else(!!sym(paste0(year_end_city))>0.85,"stagnant","progressive")) %>% filter(!code=="T") %>% 
mutate(growth=(!!sym(paste0(year_end_city))-!!sym(paste0(year_str_io)))/!!sym(paste0(year_str_io)))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
growth_B_E <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="B_E") %>% select(growth))))
growth_G <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="G") %>% select(growth))))
growth_C <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="C") %>% select(growth))))
growth_M <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="M") %>% select(growth))))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
growth_C10_C12 <- as.vector(unlist((kgGHG_euro_gdp_c_factor %>% filter(code=="C10_C12") %>% select(growth))))
growth_C22_C23 <- as.vector(unlist((kgGHG_euro_gdp_c_factor %>% filter(code=="C22_C23") %>% select(growth))))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
growth_P <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="P") %>% select(growth))))
growth_P_int <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="P") %>% select(!!sym(paste0(year_end_city))))))
growth_R <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="R") %>% select(growth))))
growth_H <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="H") %>% select(growth))))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
intense_P <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="P") %>% select( !!sym(paste0(year_end_city))))))
intense_M <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="M") %>% select( !!sym(paste0(year_end_city))))))
intense_B_E <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="B_E") %>% select( !!sym(paste0(year_end_city))))))
intense_A <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="A") %>% select( !!sym(paste0(year_end_city))))))
intense_I <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="I") %>% select( !!sym(paste0(year_end_city))))))
intense_H <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="H") %>% select( !!sym(paste0(year_end_city))))))
intense_R <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="R") %>% select( !!sym(paste0(year_end_city))))))
intense_C <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="C") %>% select( !!sym(paste0(year_end_city))))))
intense_S <- as.vector(unlist((kgGHG_euro_gdp_factor %>% filter(code=="S") %>% select( !!sym(paste0(year_end_city))))))
```

In terms of `r kgGHGvec` per unit of gross domestic product, the highest intensity `r format(round(intense_P,3), scientific=FALSE)` in `r format(year_end_city, scientific=FALSE)` was in education (P), while the lowest `r format(round(intense_M,3), scientific=FALSE)` corresponds to business and scientific activities (M). Below 0.8 we find construction (F), real state (L), administration (N), and ICT activities (J), with mining and energy supply (B_E) at `r format(round(intense_B_E,3), scientific=FALSE)`. Despite the almost negligible contribution to GDP, agriculture (A) has a medium-high intensity of `r format(round(intense_A,3), scientific=FALSE)`, and hotels and restaurants (I), transportation and storage (H), and recreation activities (R) show the highest intensity ratios after education with `r format(round(intense_I,3), scientific=FALSE)`, `r format(round(intense_H,3), scientific=FALSE)`, and `r format(round(intense_R,3), scientific=FALSE)`, respectively. Manufacturing, on the other hand, has a mid-tier intensity of `r format(round(intense_C,3), scientific=FALSE)`, very similar to other services (S) `r format(round(intense_S,3), scientific=FALSE)`. Whereas we can expect high `r ktco2vec` services, e.g. industries catering to recreational demand or business activities, to be driven mostly by robust final demand, the reality is that they are among the most `r co2vec` intensive as well.

As per their evolution across the period, @fig-cf-growth-factors shows the evolution of the direct plus indirect carbon intensity of all 2-digit industries. We can separate the ones displaying a stronger from a weaker downward trend in `r co2vec` intensity. Despite accounting for the majority of upstream emissions, the total intensity of mining and energy supply (B_E) and trade (G) have declined by `r format(round(growth_B_E*100,1), scientific=FALSE)`% and `r format(round(growth_G*100,1), scientific=FALSE)`%, respectively. Business and scientific activities (M) show the best progress, with a total `r format(round(growth_M*100,1), scientific=FALSE)`% fall in their `r co2vec` intensity, whereas manufacturing indicates a more internally heterogeneous evolution that renders a comparatively weaker `r format(round(growth_C*100,1), scientific=FALSE)`%. At a more granular 3-digit level, we observe the lowest efficiency gains in food manufacturing (C10_C12) at `r format(round(growth_C10_C12*100,1), scientific=FALSE)`% and the highest in plastic and non-metallic manufacturing with `r format(round(growth_C22_C23*100,1), scientific=FALSE)`%. Conversely, the worst performing 2-digit industries are education (P) and recreation activities (R) with a `r format(round(growth_P*100,1), scientific=FALSE)`% and a `r format(round(growth_R*100,1), scientific=FALSE)`% reduction, respectively. A relevant case is transport and storage (H), which accounts for `r format(round(cf_H_2021_tot*100/cf_gdp_tot_2021,0), scientific=FALSE)`% of total emissions but whose `r co2vec` intensity has declined comparatively less by a `r format(round(growth_H*100,1), scientific=FALSE)`%. Overall, the tendency seems to have stalled across the board in 2020, even reversing slightly for some industries, but we would need to include more recent years to fully grasp any persistent change.

## Households' contribution to total $CO_2e$ emissions from Madrid {#sec-subsec-results-households}
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  #### [a] Option B: we take the national-accounts-upscaled vector of consumption from HBS
  budget_survey_hh_city <- readRDS(file.path(datasets_path,"budget_survey_hh_city.rds")) %>% as_tibble
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  #### [a] Option B: we take the national-accounts-upscaled vector of consumption from HBS
  budget_survey_hh_city_GHG <- readRDS(file.path(datasets_path,"budget_survey_hh_city_GHG.rds")) %>% as_tibble
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  #### [a] Option B: we take the national-accounts-upscaled vector of consumption from HBS
  city_acounts_madrid <- readRDS(file.path(datasets_path,"city_accounts_madrid.rds")) %>% as_tibble
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
library(tidyverse)
total_spending <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,GASTOT,.keep_all=TRUE) %>% group_by(ANOENC) %>% summarize_at(c("GASTOT"),~sum(.*FACTOR,na.rm=TRUE)/1e06)
equivalized_spending <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,GASTOEQV,.keep_all=TRUE) %>% group_by(ANOENC) %>% summarize_at(c("GASTOEQV"),~weighted.mean(./UC2,FACTOR,na.rm=TRUE))
equivalized_spending_2021 <- as.vector(unlist(equivalized_spending%>%filter(ANOENC==year_end_city)%>%select(GASTOEQV)))
pop_meassure <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,FACTOR,NMIEMB) %>% group_by(ANOENC) %>% 
summarize_at(c("FACTOR"),~sum(.*NMIEMB,na.rm=TRUE))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  code_countries <- readxl::read_xlsx(file.path(datasets_path,"Country_Codes_and_Names.xlsx"),
  sheet = 1) %>% mutate(cou=CODE) %>% mutate_at(c("cou"),~if_else(.=="CN_X_HK","CN",.)) %>% 
  mutate_at(c("AREA"),~if_else(.=="ES","Rest of Spain",.)) %>% bind_rows(data.frame(AREA="Madrid city",
  CODE="ES30",cou="ES30",`NAME`="Madrid city")) %>% mutate_at(c("NAME"),~if_else(is.na(.),cou,.)) %>% 
  mutate(ref_area=case_when(AREA=="European Union (EU)" ~ "European Union",
  AREA=="EU candidate countries" ~ "Rest of the World",AREA=="European Free Trade Association (EFTA)" ~ "Rest of the World", AREA=="Other European countries" ~ "Rest of the World",AREA=="EU candidate countries" ~ "Rest of the World",AREA=="Non-European countries" ~ "Rest of the World")) %>% mutate_at(c("ref_area"),~if_else(is.na(.),AREA,.)) %>% mutate_at(c("ref_area"),~if_else(cou=="ES","Rest of Spain",.))
  code_coicop_d2 <- readxl::read_xlsx(file.path(datasets_path,"epf_enlace_codigos_b9722.xlsx"),sheet = "Enlace_series (2d)")

  city_emissions_coicop <- readRDS(file.path(datasets_path,"city_emissions_coicop.rds"))
  temp_plot_coicop <- city_emissions_coicop %>% pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
  values_to = "obs_value") %>% separate(counter,c("counter_cou","counter_code"),
  sep="_",extra="merge") %>% left_join(code_countries %>% 
  mutate_at(c("ref_area"),~if_else(cou=="CN","China",.)) %>%
  mutate_at(c("ref_area"),~if_else(cou=="US","United States",.)) %>%
  distinct(ref_area,cou),by=c("counter_cou"="cou")) %>% 
  mutate_at(c("code"),~stringr::str_sub(.,1,2)) %>%group_by(cou,code,ref_area,year) %>%
  summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% left_join(code_coicop_d2,
  by=c("code"="coicop_g2d")) %>% rename("heading"="coicop_g2d_heading_short") %>% 
  rename("P3_S14"="obs_value") %>% ungroup()
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
temp_plot_coicop_2021 <- temp_plot_coicop %>% filter(year==year_end_city) %>% group_by(code,heading) %>% 
summarise_at(c("P3_S14"),~sum(.,na.rm=TRUE)) %>% ungroup
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
coicop_transport_2021 <- as.vector(unlist(temp_plot_coicop_2021 %>% filter(code=="07") %>% select(P3_S14)))
coicop_food_2021 <- as.vector(unlist(temp_plot_coicop_2021 %>% filter(code=="01") %>% select(P3_S14)))
coicop_housing_2021 <- as.vector(unlist(temp_plot_coicop_2021 %>% filter(code=="04") %>% select(P3_S14)))
coicop_restaurants_2021 <- as.vector(unlist(temp_plot_coicop_2021 %>% filter(code=="11") %>% select(P3_S14)))
perc_total_01_11 <-   as.vector(unlist(temp_plot_coicop %>% filter(year==year_end_city) %>% 
mutate(new_var=if_else(code%in%c("01","04","07","11"),1,0)) %>% group_by(new_var) %>% 
summarise_at(c("P3_S14"),~sum(.,na.rm=TRUE)) %>% ungroup %>% mutate_at(c("P3_S14"),~./sum(.,na.rm=TRUE)) %>%
filter(new_var==1) %>% select(P3_S14)))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
#### [a] obtain the total for households as CO2 producers
doms_co2_tot  <- city_acounts_madrid %>% filter(grepl("HH",nace_r2)) %>% group_by(year) %>% 
summarize_at(c("ktCO2"),~sum(.,na.rm=TRUE)) %>% ungroup
#### [b] obtain the total for CO2 from household consumption
cons_co2_tot   <- temp_plot_coicop %>% group_by(year) %>% 
summarise_at(c("P3_S14"),~sum(.,na.rm=TRUE)) %>% ungroup
#### [c] bind the together and derive per capita figures
house_co2_tot  <- doms_co2_tot %>% left_join(cons_co2_tot,by=c("year")) %>% 
left_join(pop_meassure,by=c("year"="ANOENC")) %>% rename("HH"="ktCO2") %>%
mutate(`ktCO2`=HH+P3_S14,`ktCO2_pc`=ktCO2/(FACTOR/1e06))
#### [d] include total and equivalized spending figures
house_co2_tot %<>% left_join(total_spending,by=c("year"="ANOENC")) %>% rename("cons_tot"="GASTOT") %>%
left_join(equivalized_spending,by=c("year"="ANOENC")) %>% rename("cons_eq"="GASTOEQV")
house_co2_tot %<>% mutate(`kg_CO2_euro`=P3_S14/cons_tot)
#### [e] derive the figures
house_co2_tot_2010 <- as.vector(unlist(house_co2_tot %>% filter(year==year_str_io) %>% select(ktCO2)))
house_co2_tot_2021 <- as.vector(unlist(house_co2_tot %>% filter(year==year_end_city) %>% select(ktCO2)))
house_co2_pc_2010 <- as.vector(unlist(house_co2_tot %>% filter(year==year_str_io) %>% select(ktCO2_pc)))
house_co2_pc_2021 <- as.vector(unlist(house_co2_tot %>% filter(year==year_end_city) %>% select(ktCO2_pc)))
house_co2_kg_euro_2021 <- as.vector(unlist(house_co2_tot %>% filter(year==year_end_city) %>% select(kg_CO2_euro)))
house_co2_cons_eq_2021 <- as.vector(unlist(house_co2_tot %>% filter(year==year_end_city) %>% select(cons_eq)))
house_co2_tot_hh_2010 <- as.vector(unlist(house_co2_tot %>% mutate_at(c("ktCO2"),~HH) %>% filter(year==year_str_io) %>% select(ktCO2)))
house_co2_tot_hh_2021 <- as.vector(unlist(house_co2_tot %>% mutate_at(c("ktCO2"),~HH) %>% filter(year==year_end_city) %>% select(ktCO2)))
```
![Total embedded household consumption-linked emissions from Madrid by driver consumption purpose and supplier sector and geographical area, 2021. *Note*: Agriculture (A) and Household activities (T) are excluded due to very low amounts. Whenever we make reference to (the rest of) Spain, we exclude emissions and spending from Madrid. *Source*: Authors' own calculations](graphics/emisiones_coicop_nace_area_ES30_2021.pdf){#fig-cf-consumption-source fig-env="figure*" width=100%}

Despite a variety of challenges [@macekuraMismeasureProgressEconomic2020;@stiglitz_report_2009], gross domestic product remains the go-to indicator of economic activity. As such, it has allowed us to derive the total emissions which the city's final demand is responsible for. This includes government spending, net exports, and investment in addition to final consumption. However, if we are interested in the environmental impact of material well-being, we are forced to focus on households' final consumption expenditure [@sala_consumption_2019]. In `r format(year_end_city, scientific=FALSE)`, we estimate that the CF of households in the city of Madrid totaled `r format(round(house_co2_tot_2021,0), scientific=FALSE)` `r ktco2vec`, coming slightly down from `r format(round(house_co2_tot_2010,0), scientific=FALSE)` `r ktco2vec` in `r format(year_str_io, scientific=FALSE)`. From these, `r format(round(house_co2_tot_hh_2021,0),scientific=FALSE)` `r ktco2vec` or `r format(round(house_co2_tot_hh_2021*100/house_co2_tot_2021,1),scientific=FALSE)`% correspond to direct emissions by households in 2021. Final consumption expenditure explains the other `r format(round(house_co2_tot_2021-house_co2_tot_hh_2021,0),scientific=FALSE)` `r ktco2vec`, which is equal to `r format(round(house_co2_kg_euro_2021,3), scientific=FALSE)` `r kgGHGvec` per unit of nominal spending, which is in the low end of the urban density distribution [@corcoles_carbon_2024;@ivanova_mapping_2017]. In per capita terms, the average resident emitted `r format(round(house_co2_pc_2021,0), scientific=FALSE)` `r kgGHGvec` in `r format(year_end_city, scientific=FALSE)` and `r format(round(house_co2_pc_2010,0), scientific=FALSE)` `r kgGHGvec` in `r format(year_str_io, scientific=FALSE)`. As stated in equation [-@eq-carbon-footprint-households], these figures combine the emissions required from firms along the entire international supply chain to cater to households' consumption needs and the emissions that result from households' direct activities, primarily home temperature regulation and private road transport.

@fig-cf-consumption-source shows the magnitude and geographical distribution of the total emissions requirements for meeting nominal consumption demand by main COICOP group in `r format(year_end_city, scientific=FALSE)`. As noted in section [-@sec-method-household], once we derive the vector of industry `r co2vec` totals according to equation [-@eq-carbon-footprint], we revert the procedure to go back from the industry-based classification to COICOP and producer's prices so that we can report industry totals by consumption purpose. Note, however, that this totals *exclude* direct emissions by households-qua-producers, so that transportation `r co2vec` volumes belong exclusively to services purchased by households and does not include, for instance, the use of private cars. The first thing to notice in the chart is that transportation is, in fact, at the top with `r format(round(coicop_transport_2021,0), scientific=FALSE)` `r ktco2vec`. Food products and housing and utilities follow closely at `r format(round(coicop_food_2021,0), scientific=FALSE)` `r ktco2vec` and `r format(round(coicop_housing_2021,0), scientific=FALSE)` `r ktco2vec`, respectively. Accomodation, caterings, and restaurants, which represent an important driver of economic activity in the city, stand high on the raking at `r format(round(coicop_restaurants_2021,0), scientific=FALSE)` `r ktco2vec`. These four categories make up `r format(round(perc_total_01_11*100,1), scientific=FALSE)`% of total consumption-linked emissions in Madrid. Education, clothing and footwear, and communications generate the least emissions. Fron the standpoint of the geographical distribution of emissions, the city's weight is highest for transport, whereas the rest of Spain dominates in restaurants, food products, and housing supplies. The rest of the world is most important for transportation services, and very similar for food and restaurants and hotels. Proportionally, its largest share is in healthcare, although the emissions total is relatively low compared with the top consumption groups.

Additionally, @fig-cf-consumption-source breaks down emissions by three main composite supplying sectors: mining and energy supply (B_E), manufacturing and transport (C_H), and all remaining industries (Rest), such as agriculture, recreational services or construction. In the same way that @fig-cf-supplier-driver showed that the first two sectors dominate the upstream supply of `r co2vec` emissions, @fig-cf-consumption-source synthesizes the supply and driver perspective by accounting for the geographical-sectoral supply distribution of `r co2vec` requirements by consumption purpose. It indicates, for instance, that approximately a third of the transport services' footprint comes from the domestic transport industry, with a strong contribution from the rest of the world and the rest of Spain. Food products have a substantial component of embedded emissions from manufacturing and transportation, and in general from the rest of the world, which accounts for more than 50% of the total. The same holds for accommodation and restaurants, although the contribution from the rest of Spain is in this case the most relevant. Recreation and culture has a considerable indirect CF that is masked by its low direct emissions volume. More importantly, this indirect footprint relies on a relatively large upstream contribution by foreign manufacturing and transportation. As indicated above, the largest contribution from the rest of the world is in healthcare services and products, but we can see now that this is mostly due to mining and energy supply. For clothing and footwear the proportion of the foreign contribution is similar but the weight of manufacturing is on a level with energy supply.<!--In general, @fig-cf-consumption-source shows the convenience of combining supply and demand into the analysis of CFs to understand the global constraints on local decarbonization plans.-->

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  budget_survey_hh_city_GHG <- readRDS(file.path(datasets_path,"budget_survey_hh_city_GHG.rds")) 
```

```{r, eval=TRUE,include=TRUE,message=FALSE,warning=FALSE,cache=TRUE}
  library(kableExtra)
  temp_plot_coicop <- city_emissions_coicop %>% pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
  values_to = "obs_value") %>% separate(counter,c("counter_cou","counter_code"),sep="_",extra="merge") %>%
  left_join(code_countries %>% 
  mutate_at(c("ref_area"),~if_else(cou=="CN","China",.)) %>%
  mutate_at(c("ref_area"),~if_else(cou=="US","United States",.)) %>%
  distinct(ref_area,cou),by=c("counter_cou"="cou")) %>% 
  mutate_at(c("code"),~stringr::str_sub(.,1,2)) %>%group_by(cou,code,ref_area,year) %>%
  summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% left_join(code_coicop_d2,by=c("code"="coicop_g2d")) %>%
  rename("heading"="coicop_g2d_heading_short") %>% rename("P3_S14"="obs_value") %>% ungroup()
  
  CAGR_formula <- function(FV,PV,yrs) {values <- ((FV/PV)^(1/yrs)-1);return(values)}
  table_coicop <- temp_plot_coicop %>% group_by(code,heading,year) %>%  summarise_at(c("P3_S14"),~sum(.,na.rm=TRUE)) %>% ungroup %>%
  left_join(budget_survey_hh_city_GHG %>% filter(CCAA==13&CAPROV==1&ANOENC%in%c(seq(year_str_io,year_end_city))) %>% group_by(ANOENC,CODIGOd2) %>%
  summarise_at(c("GASTO"),~sum(.*FACTOR,na.rm=TRUE)/1e06),by=c("year"="ANOENC","code"="CODIGOd2")) %>%
  mutate(Factor=P3_S14/GASTO) %>% rename("Emissions"="P3_S14","Spending"="GASTO","Heading"="heading","COICOP"="code") %>% 
  group_by(year) %>% mutate_at(c("Emissions","Spending"),~.*100/sum(.,na.rm=TRUE)) %>% ungroup %>%
  mutate_at(c("Emissions","Spending"),~round(.,1)) %>%  mutate_at(c("Factor"),~round(.,3))
  
  library(kableExtra)
  table_coicop %<>% left_join(table_coicop %>% select(COICOP:year,Factor) %>% 
  pivot_wider(names_from = "year",values_from = "Factor") %>%
  mutate(Growth=CAGR_formula(!!sym(paste0(year_end_city)),!!sym(paste0(year_str_io)),length(seq(year_str_io,year_end_city))),
  check = !!sym(paste0(year_str_io)) * (1 + Growth) ^ length(seq(year_str_io,year_end_city))) %>% select(-check) %>%
  pivot_longer(!!sym(paste0(year_str_io)):!!sym(paste0(year_end_city)),names_to = "year",values_to = "factor") %>% 
  mutate_at(c("year"),~as.double(.)) %>% select(-factor),by=c("COICOP",
  "Heading","year")) %>% mutate_at(c("Growth"),~round(.*100,1))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
share_04 <- as.vector(unlist(table_coicop %>% filter(year==year_end_city&COICOP=="04") %>% select(Spending)))
share_11 <- as.vector(unlist(table_coicop %>% filter(year==year_end_city&COICOP=="11") %>% select(Spending)))
share_07 <- as.vector(unlist(table_coicop %>% filter(year==year_end_city&COICOP=="07") %>% select(Spending)))
ratio_07 <- as.vector(unlist(table_coicop %>% filter(year==year_end_city&COICOP=="07") %>% select(Factor)))
growth_04 <- as.vector(unlist((table_coicop %>% filter(year==year_end_city&COICOP=="07") %>% select(Growth))))
growth_01 <- as.vector(unlist((table_coicop %>% filter(year==year_end_city&COICOP=="01") %>% select(Growth))))
growth_12 <- as.vector(unlist((table_coicop %>% filter(year==year_end_city&COICOP=="12") %>% select(Growth))))
growth_07 <- as.vector(unlist((table_coicop %>% filter(year==year_end_city&COICOP=="07") %>% select(Growth))))
```
```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  library(kableExtra)
  table_coicop %>% filter(year==year_end_city) %>% select(-year) %>% rename("code"="COICOP") %>%
  mutate_at(c("Heading"),~if_else(code=="05","Furnishings",.)) %>%
  mutate_at(c("Heading"),~if_else(code=="11","Restaurants & Hotels",.)) %>%
  mutate_at(c("Heading"),~paste0(code," ",Heading)) %>% select(-code) %>% 
  rename("ktCO_2"="Emissions","Ratio"="Factor","Expenditure category"="Heading") %>%
  select(`Expenditure category`,`Ratio`,everything()) %>%
  kbl(booktabs = T,"latex") %>% kable_styling(latex_options = c("hold_position"),font_size = 8)
  # p{3.2cm}p{1cm}p{1.4cm}p{1.2cm}p{1cm}
```
\begin{table}[!h]
\centering\begingroup\fontsize{8}{9}\selectfont
\begin{tabular}[t]{lcccc}
\toprule
Expenditure category & `r kgGHGvec`/\euro{} & `r ktco2vec` & \euro{M} & Growth \\
\midrule
01 Food products & 0.272 & 18.9 & 11.3 & -0.9\\
02 Alcohol \& tobacco & 0.287 & 4.8 & 2.7 & 0.3\\
03 Clothing \& footwear & 0.132 & 2.7 & 3.4 & -3.5\\
04 Housing \& utilities & 0.066 & 11.3 & 27.7 & -5.8\\
05 Furnishings & 0.195 & 6.9 & 5.8 & -5.8\\
06 Healthcare & 0.213 & 6.0 & 4.6 & -1.3\\
07 Transport & 0.308 & 19.9 & 10.5 & -1.6\\
08 Communication & 0.123 & 1.9 & 2.6 & -4.6\\
09 Recreation \& culture & 0.172 & 7.4 & 7.0 & -1.8\\
10 Education & 0.087 & 0.8 & 1.5 & -5.8\\
11 Restaurants \& Hotels & 0.137 & 11.6 & 13.8 & -3.5\\
12 Miscellaneous & 0.139 & 7.7 & 9.1 & -3.9\\
\bottomrule
\end{tabular}
\endgroup{}
\caption{`r kgGHGvec` per unit of nominal household spending ratios and descriptives in 2021. \textit{Note}: `r ktco2vec` emissions and \euro{M} spending figures are presented in shares, whereas the last column shows the `r format(year_str_io, scientific=FALSE)`-`r format(year_end_city, scientific=FALSE)` period compound growth rate of the emissions ratios by expenditure category. \textit{Source}: Authors’ own calculations.\label{tab:spending-intensity}}
\end{table}

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  code_coicop_d3 <- readxl::read_xlsx(file.path(datasets_path,"epf_enlace_codigos_b9722.xlsx"),
  sheet = "Enlace_series (3d)")
  #### [a] create an aggregated dataset at 3 digits
  temp_3d_coicop <- city_emissions_coicop %>% pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
  values_to = "obs_value") %>% separate(counter,c("counter_cou","counter_code"),sep="_",extra="merge") %>%
  left_join(code_countries %>% mutate_at(c("ref_area"),~if_else(cou=="CN","China",.)) %>%
  mutate_at(c("ref_area"),~if_else(cou=="US","United States",.)) %>%
  distinct(ref_area,cou),by=c("counter_cou"="cou")) %>% group_by(cou,code,ref_area,year) %>%
  summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% left_join(code_coicop_d3 %>% 
  select(coicop_g3d,ecoicop_g3d_heading),by=c("code"="coicop_g3d")) %>%
  rename("heading"="ecoicop_g3d_heading") %>% rename("P3_S14"="obs_value") %>% ungroup()
  #### [b] clean and join to spending data to derive intensity ratios
  table_3d_coicop <- temp_3d_coicop %>% group_by(code,heading,year) %>%  summarise_at(c("P3_S14"),
  ~sum(.,na.rm=TRUE)) %>% ungroup %>% left_join(budget_survey_hh_city %>% 
  filter(CCAA==13&CAPROV==1&ANOENC%in%c(seq(year_str_io,year_end_city))) %>% group_by(ANOENC,CODIGOd3) %>%
  summarise_at(c("GASTO"),~sum(.*FACTOR,na.rm=TRUE)/1e06),by=c("year"="ANOENC","code"="CODIGOd3")) %>%
  mutate(Factor=P3_S14/GASTO) %>% rename("Emissions"="P3_S14","Spending"="GASTO",
  "Heading"="heading","COICOP"="code") %>%  group_by(year) %>% mutate_at(c("Emissions","Spending"),
  ~.*100/sum(.,na.rm=TRUE)) %>% ungroup %>% mutate_at(c("Emissions","Spending"),~round(.,1)) %>%  
  mutate_at(c("Factor"),~round(.,3))
  #### [c] add growth rate
  table_3d_coicop %<>% left_join(table_3d_coicop %>% select(COICOP:year,Factor) %>% 
  pivot_wider(names_from = "year",values_from = "Factor") %>%
  mutate(Growth=CAGR_formula(!!sym(paste0(year_end_city)),!!sym(paste0(year_str_io)),length(seq(year_str_io,year_end_city))),
  check = !!sym(paste0(year_str_io)) * (1 + Growth) ^ length(seq(year_str_io,year_end_city))) %>% select(-check) %>%
  pivot_longer(!!sym(paste0(year_str_io)):!!sym(paste0(year_end_city)),names_to = "year",values_to = "factor") %>% 
  mutate_at(c("year"),~as.double(.)) %>% select(-factor),by=c("COICOP",
  "Heading","year")) %>% mutate_at(c("Growth"),~round(.*100,1))
  table_3d_coicop %<>% group_by(COICOP,year) %>% 
  mutate(Average=mean(Factor,na.rm=TRUE)) %>% ungroup
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
library(dplyr)
#### [a] emission intensity ratios
factor_012 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="012") %>% select(Average)))
factor_031 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_str_io&COICOP=="031") %>% select(Factor)))
#### [b] compound growth factors
growth_011 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="011") %>% select(Growth)))
growth_012 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="012") %>% select(Growth)))
growth_021 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="021") %>% select(Growth)))
growth_022 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="022") %>% select(Growth)))
growth_031 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="031") %>% select(Growth)))
#### [c] compound growth factors
growth_127 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="127") %>% select(Growth)))
growth_081 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="081") %>% select(Growth)))
growth_125 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="125") %>% select(Growth)))
growth_055 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="055") %>% select(Growth)))
growth_052 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="052") %>% select(Growth)))
#### [d] compound growth factors
growth_126 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="126") %>% select(Growth)))
growth_123 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="123") %>% select(Growth)))
growth_082 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="082") %>% select(Growth)))
growth_054 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="054") %>% select(Growth)))
growth_092 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="092") %>% select(Growth)))
growth_091 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="091") %>% select(Growth)))
growth_061 <- as.vector(unlist(table_3d_coicop %>% filter(year==year_end_city&COICOP=="061") %>% select(Growth)))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHGTOT`),na.rm=TRUE)) %>% group_by(ANOENC,EDADG) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(.,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG")

  budget_survey_hh_city_GHG %<>% mutate_at(c("REGTEN"),~case_when(.%in%c(1)~"Owner (full)",
  .%in%c(2)~"Owner (partial)",.%in%c(3:4)~"Renteer",.%in%c(5:6)~"Free user"))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  table_demographics_CO2 <-   budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHGTOT`),na.rm=TRUE)) %>% group_by(ANOENC,QUNTLG) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(.,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
  mutate_at(c("group"),~paste0("Q",.)) %>% pivot_wider(names_from = "group",values_from = "kgGHG") %>%
  left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHGTOT`),na.rm=TRUE)) %>% group_by(ANOENC,EDADG) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(.,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year")) %>%
  left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHGTOT`),na.rm=TRUE)) %>% group_by(ANOENC,ESTUDIOG) %>% filter(!is.na(ESTUDIOG)) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(.,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year"))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
   #### [a] average income by group
  table_full_co2 <- budget_survey_hh_city_GHG %>% filter(CCAA==13&CAPROV==1&ANOENC%in%c(seq(year_str_io,year_end_city))) %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  group_by(ANOENC,QUNTLG) %>% summarise_at(c("IMPEXACEQV"),~weighted.mean(.,FACTOR,na.rm=TRUE)  %>% round(0)) %>% 
  set_names(c("year","group","Income")) %>% mutate_at(c("group"),~paste0("Q",.)) %>% pivot_wider(names_from = "group",values_from = "Income") %>%
  left_join(budget_survey_hh_city_GHG %>% filter(CCAA==13&CAPROV==1&ANOENC%in%c(seq(year_str_io,year_end_city))) %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  group_by(ANOENC,EDADG) %>% summarise_at(c("IMPEXACEQV"),~weighted.mean(.,FACTOR,na.rm=TRUE)  %>% round(0)) %>% 
  set_names(c("year","group","Income")) %>% pivot_wider(names_from = "group",values_from = "Income"),by=c("year")) %>%
  left_join(budget_survey_hh_city_GHG %>% filter(CCAA==13&CAPROV==1&ANOENC%in%c(seq(year_str_io,year_end_city))) %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  group_by(ANOENC,ESTUDIOG) %>% summarise_at(c("IMPEXACEQV"),~weighted.mean(.,FACTOR,na.rm=TRUE)  %>% round(0)) %>% 
  set_names(c("year","group","Income")) %>% filter(!is.na(group)) %>% pivot_wider(names_from = "group",values_from = "Income"),by=c("year")) %>%
  left_join(budget_survey_hh_city_GHG %>% filter(CCAA==13&CAPROV==1&ANOENC%in%c(seq(year_str_io,year_end_city))) %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  group_by(ANOENC,SEXOG) %>% summarise_at(c("IMPEXACEQV"),~weighted.mean(.,FACTOR,na.rm=TRUE)  %>% round(0)) %>% 
  set_names(c("year","group","Income")) %>% pivot_wider(names_from = "group",values_from = "Income"),by=c("year")) %>%
  left_join(budget_survey_hh_city_GHG %>% filter(CCAA==13&CAPROV==1&ANOENC%in%c(seq(year_str_io,year_end_city))) %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  group_by(ANOENC,REGTEN) %>% summarise_at(c("IMPEXACEQV"),~weighted.mean(.,FACTOR,na.rm=TRUE)  %>% round(0)) %>% 
  set_names(c("year","group","Income")) %>% pivot_wider(names_from = "group",values_from = "Income"),by=c("year")) %>%
  left_join(budget_survey_hh_city_GHG %>% filter(CCAA==13&CAPROV==1&ANOENC%in%c(seq(year_str_io,year_end_city))) %>% distinct(ANOENC,NUMERO,FACTOR,.keep_all = TRUE) %>%
  group_by(ANOENC) %>% summarise_at(c("IMPEXACEQV"),~weighted.mean(.,FACTOR,na.rm=TRUE)  %>% round(0)) %>% set_names(c("year","Total")),by=c("year")) %>%
  mutate(COICOP="Equivalized disposable income") %>%
              
  #### [b] averages by group
  bind_rows(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,.keep_all = TRUE) %>%        
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHG_HFCE`),na.rm=TRUE)) %>% group_by(ANOENC,QUNTLG) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(./UC2,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
  mutate_at(c("group"),~paste0("Q",.)) %>% pivot_wider(names_from = "group",values_from = "kgGHG") %>%
  left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,.keep_all = TRUE) %>%
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHG_HFCE`),na.rm=TRUE)) %>% group_by(ANOENC,EDADG) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(./UC2,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year")) %>%
  left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,.keep_all = TRUE) %>%
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHG_HFCE`),na.rm=TRUE)) %>% group_by(ANOENC,ESTUDIOG) %>% filter(!is.na(ESTUDIOG)) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(./UC2,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year")) %>%
  left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,.keep_all = TRUE) %>%
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHG_HFCE`),na.rm=TRUE)) %>% group_by(ANOENC,SEXOG) %>% filter(!is.na(SEXOG)) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(./UC2,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year")) %>% 
  left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,.keep_all = TRUE) %>%
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHG_HFCE`),na.rm=TRUE)) %>% group_by(ANOENC,REGTEN) %>% filter(!is.na(SEXOG)) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(./UC2,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year")) %>% 
  left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,.keep_all = TRUE) %>%
  mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHG_HFCE`),na.rm=TRUE)) %>% group_by(ANOENC) %>%
  summarise_at(c("kgGHGTOT"),~weighted.mean(./UC2,FACTOR,na.rm=TRUE) %>% round(1)) %>% set_names(c("year","Total")),
  by=c("year")) %>% mutate(COICOP="Average kgGHG")) %>% 
  
  #### [c] averages by group and COICOP (2 digits)
  bind_rows(budget_survey_hh_city_GHG %>% group_by(ANOENC,QUNTLG,CODIGOd2) %>% 
  summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
  mutate_at(c("group"),~paste0("Q",.)) %>% pivot_wider(names_from = "group",values_from = "kgGHG") %>%
  left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,EDADG,CODIGOd2) %>% 
  summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year","COICOP")) %>%
  left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,ESTUDIOG,CODIGOd2) %>% 
  summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% filter(!is.na(ESTUDIOG)) %>%
  set_names(c("year","group","COICOP","kgGHG")) %>% pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year","COICOP")) %>% 
  left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,SEXOG,CODIGOd2) %>% 
  summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year","COICOP")) %>% 
  left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,REGTEN,CODIGOd2) %>% 
  summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year","COICOP")) %>% 
  left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,CODIGOd2) %>% 
  summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>%
  set_names(c("year","COICOP","Total")),by=c("year","COICOP"))) %>% 
  
  #### [d] direct emissions
  bind_rows(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,QUNTLG,HH_HEAT,HH_TRA,HH_OTH) %>%
  pivot_longer(`HH_HEAT`:`HH_OTH`,names_to = "HH",values_to = "kgGHG") %>% group_by(ANOENC,QUNTLG,HH) %>% 
  summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
  mutate_at(c("group"),~paste0("Q",.)) %>% pivot_wider(names_from = "group",values_from = "kgGHG") %>%
  mutate_at(c("COICOP"),~case_when(.=="HH_HEAT"~"Heating",.=="HH_TRA"~"Transport",.=="HH_OTH"~"Other")) %>%
    
    left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,EDADG,HH_HEAT,HH_TRA,HH_OTH) %>%
    pivot_longer(`HH_HEAT`:`HH_OTH`,names_to = "HH",values_to = "kgGHG") %>% group_by(ANOENC,EDADG,HH) %>% 
    summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
    pivot_wider(names_from = "group",values_from = "kgGHG") %>%
    mutate_at(c("COICOP"),~case_when(.=="HH_HEAT"~"Heating",.=="HH_TRA"~"Transport",.=="HH_OTH"~"Other")),by=c("year","COICOP")) %>%
    
    left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,ESTUDIOG,HH_HEAT,HH_TRA,HH_OTH) %>%
    pivot_longer(`HH_HEAT`:`HH_OTH`,names_to = "HH",values_to = "kgGHG") %>% group_by(ANOENC,ESTUDIOG,HH) %>% 
    summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
    filter(!is.na(group)) %>% pivot_wider(names_from = "group",values_from = "kgGHG") %>%
    mutate_at(c("COICOP"),~case_when(.=="HH_HEAT"~"Heating",.=="HH_TRA"~"Transport",.=="HH_OTH"~"Other")),by=c("year","COICOP")) %>%
    
    left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,SEXOG,HH_HEAT,HH_TRA,HH_OTH) %>%
    pivot_longer(`HH_HEAT`:`HH_OTH`,names_to = "HH",values_to = "kgGHG") %>% group_by(ANOENC,SEXOG,HH) %>% 
    summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
    pivot_wider(names_from = "group",values_from = "kgGHG") %>%
    mutate_at(c("COICOP"),~case_when(.=="HH_HEAT"~"Heating",.=="HH_TRA"~"Transport",.=="HH_OTH"~"Other")),by=c("year","COICOP")) %>%
    
    left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,REGTEN,HH_HEAT,HH_TRA,HH_OTH) %>%
    pivot_longer(`HH_HEAT`:`HH_OTH`,names_to = "HH",values_to = "kgGHG") %>% group_by(ANOENC,REGTEN,HH) %>% 
    summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
    pivot_wider(names_from = "group",values_from = "kgGHG") %>%
    mutate_at(c("COICOP"),~case_when(.=="HH_HEAT"~"Heating",.=="HH_TRA"~"Transport",.=="HH_OTH"~"Other")),by=c("year","COICOP")) %>%
  
    left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,FACTOR,HH_HEAT,HH_TRA,HH_OTH) %>%
    pivot_longer(`HH_HEAT`:`HH_OTH`,names_to = "HH",values_to = "kgGHG") %>% group_by(ANOENC,HH) %>% 
    summarise_at(c("kgGHG"),~round(weighted.mean(./UC2,FACTOR,na.rm=TRUE),1)) %>% 
    set_names(c("year","COICOP","Total")) %>% mutate_at(c("COICOP"),~case_when(.=="HH_HEAT"~"Heating",
    .=="HH_TRA"~"Transport",.=="HH_OTH"~"Other")),by=c("year","COICOP")) %>%
    
  arrange(year,factor(COICOP,levels=c("Heating","Transport","Other")))) %>% 
  filter(year==year_end_city) %>% ungroup %>%
  
  #### [e] intensity ratios
  # left_join(city_emissions_coicop %>% pivot_longer(`AR_A`:`ZA_T`,names_to = "counter",
  # values_to = "obs_value") %>% separate(counter,c("counter_cou","counter_code"),sep="_",extra="merge") %>%
  # mutate_at(c("code"),~stringr::str_sub(.,1,2)) %>%group_by(cou,code,year) %>%
  # summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% rename("P3_S14"="obs_value") %>% left_join(code_coicop_d2 %>%
  # select(coicop_g2d,coicop_g2d_heading_short) %>% set_names(c("coicop_g2d","heading")),by=c("code"="coicop_g2d")) %>% 
  # group_by(code,heading,year) %>%  summarise_at(c("P3_S14"),~sum(.,na.rm=TRUE)) %>% ungroup %>%
  # left_join(budget_survey_hh_city %>% filter(CCAA==13&CAPROV==1&ANOENC%in%c(seq(year_str_io,year_end_city))) %>% group_by(ANOENC,CODIGOd2) %>%
  # summarise_at(c("GASTO"),~sum(.*FACTOR,na.rm=TRUE)/1e06),by=c("year"="ANOENC","code"="CODIGOd2")) %>%
  # mutate(Factor=P3_S14/GASTO) %>% rename("Emissions"="P3_S14","Spending"="GASTO","Heading"="heading","COICOP"="code") %>% 
  # group_by(year) %>% mutate_at(c("Emissions","Spending"),~.*100/sum(.,na.rm=TRUE)) %>% ungroup %>%
  # mutate_at(c("Emissions","Spending"),~round(.,1)) %>%  mutate_at(c("Factor"),~round(.,3)) %>% select(-Heading),by=c("COICOP","year")) %>%
  
  #### [f] formatting
  left_join(code_coicop_d2 %>% distinct(coicop_g2d,coicop_g2d_heading_short),by=c("COICOP"="coicop_g2d")) %>% 
  mutate_at(c("coicop_g2d_heading_short"),~if_else(is.na(.),"",.)) %>% 
  mutate_at(c("COICOP"),~paste0(COICOP," ",coicop_g2d_heading_short)) %>% 
  select(COICOP,`Q1`:`Q5`,`15-34`:`+71`,everything(),-year) %>%
  mutate_at(c("COICOP"),~if_else(.=="Transport ","Transport activity",.)) %>%
  mutate_at(c("COICOP"),~if_else(.=="Heating ","Heating/cooling",.)) %>%
  mutate_at(c("coicop_g2d_heading_short"),~if_else(.=="",COICOP,.))
```
```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  table_full_co2 %>% select(COICOP,`Q1`:`Q5`,`15-34`:`+71`,`Total`) %>% 
  mutate_at(c("COICOP"),~if_else(.=="Equivalized disposable income ","Equivalized income",.))%>% 
  mutate_at(c("COICOP"),~if_else(.=="05 Furnishings & maintenance","05 Furnishings",.)) %>%
  mutate(across(where(is.numeric),~if_else(COICOP=="Other ",round(.,0),round(.,0)))) %>%
  kbl(booktabs = T,"latex") %>% kable_styling(latex_options = c("hold_position"),font_size = 9)
```
\begin{table*}[!ht]
\centering
\begin{tabular}[t]{lcccccccccc}
\toprule
Emissions group & Q1 & Q2 & Q3 & Q4 & Q5 & 15-34 & 35-54 & 55-70 & +71 & Total\\
\midrule
Equivalized income \euro{} & 17116 & 21784 & 25373 & 29045 & 36428 & 23057 & 25514 & 26633 & 27265 & 25931\\
Equivalized `r kgGHGvec` & 2318 & 3940 & 5246 & 7570 & 11234 & 5774 & 6333 & 6503 & 5046 & 6053\\
\addlinespace
01 Food products & 269 & 408 & 446 & 543 & 597 & 318 & 438 & 495 & 507 & 456\\
02 Alcohol \& tobacco & 61 & 149 & 221 & 225 & 333 & 140 & 186 & 265 & 165 & 200\\
03 Clothing \& footwear & 39 & 50 & 73 & 105 & 148 & 98 & 90 & 81 & 76 & 86\\
04 Housing \& utilities & 112 & 144 & 144 & 161 & 220 & 126 & 141 & 174 & 181 & 157\\
05 Furnishings & 32 & 46 & 83 & 153 & 249 & 100 & 89 & 129 & 190 & 118\\
06 Healthcare & 58 & 102 & 150 & 198 & 381 & 145 & 135 & 239 & 237 & 185\\
07 Transport & 140 & 280 & 463 & 716 & 1087 & 623 & 626 & 569 & 392 & 577\\
08 Communication & 41 & 55 & 58 & 64 & 70 & 52 & 54 & 62 & 68 & 58\\
09 Recreation \& culture & 35 & 57 & 86 & 128 & 274 & 95 & 132 & 139 & 87 & 124\\
10 Education & 16 & 29 & 59 & 76 & 193 & 19 & 108 & 79 & 46 & 95\\
11 Restaurants \& hotels & 81 & 168 & 332 & 448 & 984 & 375 & 493 & 461 & 329 & 450\\
12 Miscellaneous & 53 & 70 & 94 & 128 & 284 & 158 & 117 & 119 & 166 & 131\\
\addlinespace
Heating/cooling & 675 & 881 & 821 & 908 & 984 & 702 & 791 & 844 & 1070 & 859\\
Transport & 414 & 1147 & 1590 & 2430 & 2461 & 2397 & 1677 & 1744 & 1097 & 1682\\
Other & 19 & 29 & 40 & 56 & 96 & 43 & 50 & 51 & 44 & 48\\
\bottomrule
\end{tabular}
\caption{Breakdown of households' average `r kgGHGvec` footprint of 2-digit consumption purposes and domestic activities by spending quintile and age group in Madrid, `r format(year_end_city, scientific=FALSE)`. \textit{Source}: Authors’ own calculations.\label{tab:emissions-demographic}}
\end{table*}

From @fig-cf-consumption-source we can learn that consumption spending drives an extremely large volume of indirect emissions. However, this depends on two parameters: the level of final demand and the carbon intensity of each consumption purpose. To understand this difference, we need to derive intensity ratios by 2-digit COICOP groups. Table 2 shows the emissions intensity per unit of nominal household spending (`r kgGHGvec`\euro{}) of main expenditure groups, followed by the shares of each category on total embedded emissions and consumption spending. The last column reports the `r format(year_str_io, scientific=FALSE)`-`r format(year_end_city, scientific=FALSE)` compound growth rate of the intensity ratios. We can see that spending on transportation and storage is the most `r co2vec` intense in the city, whereas housing and utilities is in the opposite situation. <!--However, the latter accounts for `r format(round(share_11,1), scientific=FALSE)`% due to it having the largest share on total spending.-->The outstanding contribution of transport spending is explained by its `r format(round(share_07,3), scientific=FALSE)`% share on total household spending and an intensity of `r format(round(ratio_07,3), scientific=FALSE)` `r kgGHGvec`\euro{}, which explains its leading position in figure [-@fig-cf-consumption-source]. Similarly, housing and utilities is less carbon intense, but tops the ranking with `r format(round(share_04,1), scientific=FALSE)`% of total expenditure. Lastly, it is worth noting that all groups' intensity ratios are declining, with the exception of alcohol and tobacco, albeit at different speeds. While the housing and utilities group has reduced its emissions intensity by `r format(round(as.vector(unlist(table_coicop %>% dplyr::filter(year==year_end_city&COICOP=="04") %>% dplyr::select(Growth))),1), scientific=FALSE)`% per year, food products and transport have realized much smaller efficiency gains at `r format(round(as.vector(unlist(table_coicop %>% dplyr::filter(year==year_end_city&COICOP=="01") %>% dplyr::select(Growth))),1), scientific=FALSE)`% and `r format(round(as.vector(unlist(table_coicop %>% dplyr::filter(year==year_end_city&COICOP=="07") %>% dplyr::select(Growth))),1), scientific=FALSE)`%, respectively.

At a more granular level (3-digit COICOP), the picture is validated with a few exceptions. For food products, for instance, we see that the emission intensity is driven down by `r format(stringr::str_to_lower(as.vector(unlist(table_3d_coicop %>% mutate(COICOP2d=stringr::str_sub(COICOP,1,2)) %>% group_by(COICOP2d) %>% dplyr::filter(year==year_end_city&COICOP2d=="01") %>% top_n(1,-Growth) %>% ungroup %>% mutate_at(c("Heading"),~paste0(.," (",COICOP,")")) %>% dplyr::distinct(Heading)))), scientific=FALSE)`, with an average compound growth of  `r format(round(as.vector(unlist(table_3d_coicop %>% mutate(COICOP2d=stringr::str_sub(COICOP,1,2)) %>% group_by(COICOP2d) %>% dplyr::filter(year==year_end_city&COICOP2d=="01") %>% top_n(1,-Growth) %>% ungroup %>% dplyr::select(Growth))),1), scientific=FALSE)`% and an average factor of `r format(round(factor_012,2), scientific=FALSE)`. For alcoholic beverages (021) we see a moderate `r format(round(growth_021,1), scientific=FALSE)`% decline, where the emission intensity of tobacco (022) grew by `r format(round(growth_022,1), scientific=FALSE)`%, both with high ratios similar to food and non-alcoholic beverages. Clothing (031) and footware (032), on the other had, have low intensities that are also underwent a robust process of decline. For instance, clothing reduced its intensity by a an average `r format(round(growth_031,1), scientific=FALSE)`% from an already low `r format(round(factor_031,3), scientific=FALSE)` intesity in `r format(year_str_io, scientific=FALSE)`. The largest reductions are, basides actual and imputed rentals (041-042), in other services (127: `r format(round(growth_127,2), scientific=FALSE)`%), postal services (081: `r format(round(growth_081,2), scientific=FALSE)`%), insurance (125: `r format(round(growth_125,2), scientific=FALSE)`%), and housing tools and equipement (055: `r format(round(growth_055,2), scientific=FALSE)`%). Communications equipment (082: `r format(round(growth_082,2), scientific=FALSE)`%), household utensils (054: `r format(round(growth_054,2), scientific=FALSE)`%) and textiles (052: `r format(round(growth_052,2), scientific=FALSE)`%) have also strongly reduced their `r co2vec` intensity. On the oposite end, medical products and equipment (061: `r format(round(growth_061), scientific=FALSE)`%) and other recreational goods and services (092: `r format(round(growth_092), scientific=FALSE)`%) stand out as growing more carbon intensive.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
  library(dplyr)
  #### [a] household CO2 emissions
  CO2_q1_2021 <- as.vector(unlist(table_full_co2 %>% filter(grepl("kgGHG",COICOP)) %>% select(`Q1`)))
  CO2_q5_2021 <- as.vector(unlist(table_full_co2 %>% filter(grepl("kgGHG",COICOP)) %>% select(`Q5`)))
  #`r format(round(CO2_q1_2021,0), scientific=FALSE)`
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
  #### [b] household spending data
  gastoeqv_2021 <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,GASTOEQV,FACTOR) %>% 
  group_by(ANOENC) %>% summarise_at(c("GASTOEQV"),~weighted.mean(GASTOEQV,FACTOR,na.rm=TRUE)) %>%
  filter(ANOENC==year_end_city) %>% select(GASTOEQV) %>% unlist %>% as.vector()
  gastoeqv_2010 <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,GASTOEQV,FACTOR) %>% 
  group_by(ANOENC) %>% summarise_at(c("GASTOEQV"),~weighted.mean(GASTOEQV,FACTOR,na.rm=TRUE)) %>%
  filter(ANOENC==year_str_io) %>% select(GASTOEQV) %>% unlist %>% as.vector()
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
  #### [b] household data
  quintile_2021 <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,NMIEMB,QUNTLG,FACTOR) %>% 
  group_by(ANOENC,QUNTLG) %>% summarise_at(c("FACTOR"),~sum(FACTOR,na.rm=TRUE)) %>%
  filter(ANOENC==year_end_city) %>% ungroup %>% summarize(mean(FACTOR)) %>% unlist %>% as.vector()
  quintile_q1_2021 <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,NMIEMB,QUNTLG,FACTOR) %>% 
  group_by(ANOENC,QUNTLG) %>% summarise_at(c("FACTOR"),~sum(NMIEMB*FACTOR,na.rm=TRUE)) %>%
  filter(ANOENC==year_end_city) %>% ungroup %>% filter(QUNTLG==1) %>% select(FACTOR) %>% unlist %>% as.vector()
  quintile_q5_2021 <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,NMIEMB,QUNTLG,FACTOR) %>% 
  group_by(ANOENC,QUNTLG) %>% summarise_at(c("FACTOR"),~sum(NMIEMB*FACTOR,na.rm=TRUE)) %>%
  filter(ANOENC==year_end_city) %>% ungroup %>% filter(QUNTLG==5) %>% select(FACTOR) %>% unlist %>% as.vector()
  
  gastoeqv_2021 <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,GASTOEQV,FACTOR) %>% 
  group_by(ANOENC) %>% summarise_at(c("GASTOEQV"),~weighted.mean(.,FACTOR,na.rm=TRUE)) %>%
  filter(ANOENC==year_end_city) %>% select(GASTOEQV) %>% unlist %>% as.vector()
  impexaceqv_2021 <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,IMPEXACEQV,FACTOR) %>% 
  group_by(ANOENC) %>% summarise_at(c("IMPEXACEQV"),~weighted.mean(.,FACTOR,na.rm=TRUE)) %>%
  filter(ANOENC==year_end_city) %>% select(IMPEXACEQV) %>% unlist %>% as.vector()
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
  library(dplyr)
  #### [a] household CO2 emissions
  impexac_q_2021 <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,IMPEXACEQV,QUNTLG,FACTOR) %>% 
  group_by(ANOENC,QUNTLG) %>% summarise_at(c("IMPEXACEQV"),~weighted.mean(IMPEXACEQV,FACTOR,na.rm=TRUE)) %>%
  filter(ANOENC==year_end_city) %>% select(IMPEXACEQV,QUNTLG) %>% ungroup
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
  library(dplyr);library(tidyverse)
  #### [a] household CO2 emissions
  gini_series <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,IMPEXAC,IMPURENT,UC2,
  IMPEXACEQV,GASTOEQV,GASTOT,kgGHGTOT,QUNTLG,FACTOR) %>% group_by(ANOENC) %>% 
  mutate_at(c("IMPEXACEQV"),~(IMPEXAC+IMPURENT)/UC2) %>% mutate(GASTOEQV=(GASTOT-IMPURENT)/UC2) %>% 
  mutate(CARBONEQV=kgGHGTOT/UC2) %>% mutate_at(c("GASTOEQV"),~if_else(is.na(.),0,.)) %>%
  summarise_at(c("IMPEXACEQV","GASTOEQV","CARBONEQV"),~DescTools::Gini(.,FACTOR,unbiased=FALSE)) %>% 
  ungroup %>% set_names(c("year","gini_income","gini_expenditure","gini_emissions")) %>% 
  pivot_longer(`gini_income`:`gini_emissions`,names_to="Gini",values_to="obs_value") 
```

We noted in section [-@sec-method-household] that it is possible to retrieve household-level CFs. After deriving 3-digit intensity ratios, we impute the estimated total CF per consumption purpose to each household reported in ES-HBS [@ine_encuesta_2024], whose aggregation matches the figures reported before by construction. Using information on energy products (measured in physical units) and on emissions factors from MITECO [@miteco_calculadora_2023], we can also impute the estimated *direct* CF of household activity [@corcoles_carbon_2024]. The resulting micro data creates a distributional perspective into the volume of emissions triggered by household decisions. This is crucial to understand the drivers of a city's footprint and, most importantly, to act on them without disregard for the economic inequalities that could compromise mitigation strategies. For instance, the average equivalized household income after taxes and transfers was \euro `r format(round(impexaceqv_2021,0), scientific=FALSE)` in `r format(year_end_city, scientific=FALSE)`, but this glosses over substantial distributional differences that can go from \euro `r format(round(as.vector(unlist(impexac_q_2021 %>% filter(QUNTLG==1) %>% dplyr::select(IMPEXACEQV))),0), scientific=FALSE)` on average for the bottom 20% to \euro `r format(round(as.vector(unlist(impexac_q_2021 %>% filter(QUNTLG==5) %>% dplyr::select(IMPEXACEQV))),0), scientific=FALSE)` for the corresponding top 20% of the equivalized spending distribution.^[Household equivalized income accounts for differences in a household's size and composition to make individual incomes comparable across household types. It adjusts total household income using the modified OECD equivalence scale, where the first adult counts as 1, but the second and each subsequent person aged 14 and over only 0.5, 0.3 to each child aged under 14 [@deatonAnalysisHouseholdSurveys1997]] Each spending quintile represents aproximatedly `r format(round(quintile_2021,0), scientific=FALSE)` households, but an unequal number of people ranging from `r format(round(quintile_q1_2021,0), scientific=FALSE)` (Q1) to `r format(round(quintile_q5_2021,0), scientific=FALSE)` (Q5). This translates into quite different emissions profiles and overall levels of inequality in each group's contribution to climate change.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
  diff_table_full_co2 <-table_full_co2 %>% group_by(COICOP) %>% 
  mutate(diff=`Q5`-`Q1`,`%diff`=(`Q5`-`Q1`)*100/`Q1`) %>% select(COICOP,ends_with("diff")) %>%
  left_join(table_full_co2 %>% select(COICOP,`Q1`,`Q5`) %>% filter(!COICOP=="00 Average kgGHG") %>% 
  mutate_at(c("Q1","Q5"),~./sum(.,na.rm=TRUE)),by=c("COICOP")) %>% filter(!COICOP=="00 Average kgGHG") %>%
  tidyr::separate(COICOP,c("code","COICOP"),sep=" ",extra="merge") %>% mutate_at(c("COICOP"),
  ~if_else(.=="",code,.)) %>% ungroup %>% mutate_at(c("COICOP"),~stringr::str_to_lower(.)) %>%
  mutate(share_diff=`Q5`-`Q1`) %>% filter(!grepl("kgGHG",COICOP)) %>% filter(!grepl("income",COICOP)) %>% filter(code%in%c(paste0("0",1:9),"10","11","12"))
  
  diff_q1_tra <- as.vector(unlist(diff_table_full_co2 %>% filter(code=="Transport") %>% select(`Q1`)))
  diff_q5_tra <- as.vector(unlist(diff_table_full_co2 %>% filter(code=="Transport") %>% select(`Q5`)))

  top_diff <- paste0(as.vector(unlist(diff_table_full_co2 %>% top_n(2,`%diff`) %>% 
  select(COICOP))),collapse=" and ")
  bottom_diff <- paste0(as.vector(unlist(diff_table_full_co2 %>% top_n(2,-`%diff`) %>% 
  select(COICOP))),collapse=" and ")
  top_share_diff <- paste0(as.vector(unlist(diff_table_full_co2 %>% top_n(2,`share_diff`) %>% 
  select(COICOP))),collapse=" and ")
  bottom_share_diff <- paste0(as.vector(unlist(diff_table_full_co2 %>% top_n(2,-`share_diff`) %>% 
  select(COICOP))),collapse=" and ")

  q5_tra_share <- as.vector(unlist(diff_table_full_co2 %>% filter(code=="Transport") %>% select(`Q5`)))
  q1_tra_share <- as.vector(unlist(diff_table_full_co2 %>% filter(code=="Transport") %>% select(`Q1`)))
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
 #### [a] aggregate gap
 total_gap <- budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,
 FACTOR,.keep_all = TRUE) %>% mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHG_HFCE`),
 na.rm=TRUE)) %>% group_by(ANOENC,QUNTLG) %>% summarise_at(c("kgGHGTOT"),
 ~sum(.*FACTOR,na.rm=TRUE)/1e06 %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
 mutate_at(c("group"),~paste0("Q",.)) %>% pivot_wider(names_from = "group",values_from = "kgGHG") %>%
 mutate(Total=rowSums(across(`Q1`:`Q5`),na.rm=TRUE)) %>% ungroup
 total_gap_prop <- total_gap %>% mutate_at(c(paste0("Q",1:5)),~./Total) %>% 
 select(-Total) %>% filter(year==2021)%>% ungroup

 #### [b] gap contributed by expenditure-related emissions
 expenditure_gap <- budget_survey_hh_city_GHG %>% group_by(ANOENC,QUNTLG) %>% 
 summarise_at(c("kgGHG"),~round(sum(.*FACTOR,na.rm=TRUE),1)/1e06) %>% 
 set_names(c("year","group","kgGHG")) %>% mutate_at(c("group"),~paste0("Q",.)) %>% 
 pivot_wider(names_from = "group",values_from = "kgGHG") %>%
 left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,
 FACTOR,.keep_all = TRUE) %>% mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHG_HFCE`),
 na.rm=TRUE)) %>% group_by(ANOENC,QUNTLG) %>% summarise_at(c("kgGHGTOT"),
 ~sum(.*FACTOR,na.rm=TRUE)/1e06 %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
 mutate_at(c("group"),~paste0("Q",.)) %>% pivot_wider(names_from = "group",values_from = "kgGHG") %>%
 mutate(Total=rowSums(across(`Q1`:`Q5`),na.rm=TRUE)) %>% select(year,Total),by=c("year")) %>% 
 mutate(Total_exp=rowSums(across(`Q1`:`Q5`),na.rm=TRUE)) %>% ungroup
 expenditure_gap_prop <- expenditure_gap %>% mutate_at(c(paste0("Q",1:5)),~./Total) %>% 
 select(-Total,-Total_exp) %>% filter(year==2021)%>% ungroup

 #### [c] gap contributed by direct activity-related emissions
 hh_activity_gap <- budget_survey_hh_city_GHG %>%  distinct(ANOENC,UC2,NUMERO,FACTOR,
 QUNTLG,HH_HEAT,HH_TRA,HH_OTH) %>% pivot_longer(`HH_HEAT`:`HH_OTH`,names_to = "HH",
 values_to = "kgGHG") %>% group_by(ANOENC,QUNTLG) %>% 
 summarise_at(c("kgGHG"),~round(sum(.*FACTOR,na.rm=TRUE),1)/1e06) %>% 
 set_names(c("year","group","kgGHG")) %>% mutate_at(c("group"),~paste0("Q",.)) %>% 
 pivot_wider(names_from = "group",values_from = "kgGHG") %>%
 left_join(budget_survey_hh_city_GHG %>% distinct(ANOENC,UC2,NUMERO,
 FACTOR,.keep_all = TRUE) %>% mutate_at(c("kgGHGTOT"),~rowSums(across(`HH_HEAT`:`kgGHG_HFCE`),
 na.rm=TRUE)) %>% group_by(ANOENC,QUNTLG) %>% summarise_at(c("kgGHGTOT"),
 ~sum(.*FACTOR,na.rm=TRUE)/1e06 %>% round(1)) %>% set_names(c("year","group","kgGHG")) %>%
 mutate_at(c("group"),~paste0("Q",.)) %>% pivot_wider(names_from = "group",values_from = "kgGHG") %>%
 mutate(Total=rowSums(across(`Q1`:`Q5`),na.rm=TRUE)) %>% select(year,Total),by=c("year")) %>% 
 mutate(Total_exp=rowSums(across(`Q1`:`Q5`),na.rm=TRUE)) %>% ungroup
 hh_activity_gap_prop <- hh_activity_gap %>% mutate_at(c(paste0("Q",1:5)),~./Total) %>% 
 select(-Total,-Total_exp) %>% filter(year==2021) %>% ungroup

 #### [d] gap contributed by direct activity-related emissions
 ratio_hh_activity_gap <- budget_survey_hh_city_GHG %>%  distinct(ANOENC,UC2,NUMERO,FACTOR,
 QUNTLG,HH_HEAT,HH_TRA,HH_OTH) %>% pivot_longer(`HH_HEAT`:`HH_OTH`,names_to = "HH",
 values_to = "kgGHG") %>% group_by(ANOENC,QUNTLG,HH) %>% 
 summarise_at(c("kgGHG"),~round(sum(.*FACTOR,na.rm=TRUE),1)/1e06) %>% 
 set_names(c("year","group","type","kgGHG")) %>% mutate_at(c("group"),~paste0("Q",.)) %>% 
 pivot_wider(names_from = "group",values_from = "kgGHG") %>% filter(year==2021) %>% 
 ungroup
```

Table 3 presents the breakdown of households' average annual equivalized `r kgGHGvec` emissions by spending quintile and four age groups (15-34, 35-54, 55-65, +71). It also separates the contribution of 2-digit COICOP groups and direct `r co2vec` emissions. We include the aggregate figures for comparison. Unless stated otherwise, all values are equivalized and refer to 2021. Overall, we see a strong correlation between income and emissions levels. For instance, the bottom 20% of the spending distribution emitted an average of `r format(round(CO2_q1_2021,0), scientific=FALSE)` `r kgGHGvec` in `r format(year_end_city, scientific=FALSE)`, whereas the top 20% contributed with `r format(round(CO2_q5_2021/CO2_q1_2021,1), scientific=FALSE)` times as much `r kgGHGvec`. However, this distributional gap is due not only to level but compositional changes. On the one hand, `r kgGHGvec` for all consumption purposes and domestic activities increases with households' equivalized disposable income. While `r format(top_diff, scientific=FALSE)` are the emissions groups with the largest quintile gap, `r format(bottom_diff, scientific=FALSE)` are the ones with the lowest. In accordance with the environmental expression of Engel's Law [@browningEngelLaw2018;@levinsonEnvironmentalEngelCurves2015], we tend to see essentials on the lower end of the gap distribution. Food purchases are `r format(round(as.vector(unlist(table_full_co2 %>% mutate(ratio=(Q2/Q1)-1) %>% filter(grepl("01",COICOP)) %>% select(ratio)))*100,1), scientific=FALSE)`% higher for the second than the first quantile, but they only grow by `r format(round(as.vector(unlist(table_full_co2 %>% mutate(ratio=(Q5/Q2)-1) %>% filter(grepl("01",COICOP)) %>% select(ratio)))*100,1), scientific=FALSE)`% from the second to the fifth quantile, indicating the marginally decreasing growth in expenditure and emissions as a function of income levels. Hence, to observe such a large distributional gap, other consumption purposes need to reverse the relationship between expenditure and income that obtains for essentials. This is especially the case of restaurants and hotels. Equivalized emissions grow by `r format(round(as.vector(unlist(table_full_co2 %>% mutate(ratio=(Q5/Q1)-1) %>% filter(grepl("11",COICOP)) %>% select(ratio)))*100,1), scientific=FALSE)`% from the bottom to the top quintile. Similarly, for transport, recreation and cultural activities, and miscellanea we find gaps of `r format(round(as.vector(unlist(table_full_co2 %>% mutate(ratio=(Q5/Q1)-1) %>% filter(grepl("07",COICOP)) %>% select(ratio)))*100,1), scientific=FALSE)`%, `r format(round(as.vector(unlist(table_full_co2 %>% mutate(ratio=(Q5/Q1)-1) %>% filter(grepl("09",COICOP)) %>% select(ratio)))*100,1), scientific=FALSE)`%, `r format(round(as.vector(unlist(table_full_co2 %>% mutate(ratio=(Q5/Q1)-1) %>% filter(grepl("12",COICOP)) %>% select(ratio)))*100,1), scientific=FALSE)`%, respectively. Education is an interesting case, since related emissions are comparatively low, but due to the remarkable spending gap, we are left with a `r format(round(as.vector(unlist(table_full_co2 %>% mutate(ratio=(Q5/Q1)-1) %>% filter(grepl("10",COICOP)) %>% select(ratio)))*100,1), scientific=FALSE)`% increase across the quintile distribution. The aggregate picture is, therefore, a mixture of opposing tendencies. It seems clear that any policy targetting consumption needs to reckon with this radical difference between essentials and other expenditure groups in designing mitigation plan.

```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  table_full_co2 %>% select(COICOP,`Female`:`Male`,`Primary`:`Tertiary`,
  `Owner (full)`:`Renteer`,`Free user`) %>% 
  mutate_at(c("COICOP"),~if_else(.=="Equivalized disposable income ","Equivalized income",.))%>% 
  mutate_at(c("COICOP"),~if_else(.=="05 Furnishings & maintenance","05 Furnishings",.)) %>%
  mutate(across(where(is.numeric),~if_else(COICOP=="Other ",round(.,0),round(.,0)))) %>%
  kbl(booktabs = T,"latex") %>% kable_styling(latex_options = c("hold_position"),font_size = 9)
```
\begin{table*}[!ht]
\centering
\begin{tabular}[t]{lccccccccc}
\toprule
Emissions group & Female & Male & Primary & Secondary & Tertiary & Full & Partial & Renteer & Free user\\
\midrule
Equivalized income \euro{} & 24692 & 26792 & 18382 & 22082 & 30975 & 28351 & 29118 & 19010 & 26530\\
Equivalized `r kgGHGvec` & 5655 & 6330 & 3370 & 5577 & 7038 & 6055 & 7061 & 5145 & 5961\\
\addlinespace
01 Food products & 452 & 458 & 407 & 455 & 466 & 504 & 470 & 370 & 428\\
02 Alcohol \& tobacco & 188 & 207 & 216 & 215 & 184 & 220 & 196 & 165 & 249\\
03 Clothing \& footwear & 95 & 81 & 45 & 71 & 105 & 80 & 96 & 76 & 152\\
04 Housing \& utilities & 175 & 145 & 135 & 157 & 162 & 182 & 144 & 128 & 147\\
05 Furnishings & 120 & 117 & 104 & 95 & 139 & 154 & 118 & 58 & 116\\
06 Healthcare & 213 & 167 & 143 & 192 & 188 & 249 & 161 & 110 & 145\\
07 Transport & 584 & 573 & 241 & 551 & 640 & 540 & 616 & 607 & 440\\
08 Communication & 61 & 56 & 49 & 58 & 60 & 62 & 53 & 56 & 74\\
09 Recreation \& culture & 142 & 114 & 44 & 113 & 142 & 123 & 147 & 93 & 203\\
10 Education & 89 & 98 & 150 & 40 & 123 & 54 & 88 & 161 & 37\\
11 Restaurants \& hotels & 391 & 482 & 165 & 388 & 531 & 382 & 570 & 368 & 776\\
12 Miscellaneous & 155 & 116 & 85 & 108 & 160 & 143 & 102 & 139 & 146\\
\addlinespace
Heating/cooling & 980 & 777 & 769 & 862 & 875 & 944 & 835 & 757 & 632\\
Transport & 1594 & 1722 & 610 & 1555 & 1926 & 1680 & 1786 & 1538 & 1842\\
Other & 47 & 49 & 29 & 43 & 57 & 48 & 53 & 42 & 53\\
\bottomrule
\end{tabular}
\caption{Breakdown of households' average `r kgGHGvec` footprint of 2-digit consumption purposes and domestic activities by gender, main education level, and tenure status in Madrid, `r format(year_end_city, scientific=FALSE)`. \textit{Source}: Authors’ own calculations.\label{tab:emissions-demographic}}
\end{table*}

Comparing emissions from expenditure and activities, we can calculate that while the top quintile represents `r format(round(as.vector(unlist(total_gap_prop %>% select(Q5)))*100,1),scientific=FALSE)`% of total emissions, or `r format(round(as.vector(unlist(total_gap %>% filter(year==2021) %>% select(Q5))),1),scientific=FALSE)` `r ktco2vec`, the bottom quintile generates only `r format(round(as.vector(unlist(total_gap_prop %>% select(Q1)))*100,1),scientific=FALSE)`%. This amounts to a gap of no less than `r format(round(as.vector(unlist(total_gap %>% mutate(diff=Q5-Q1) %>% filter(year==2021) %>% select(diff))),1),scientific=FALSE)` `r ktco2vec`. The gap in emissions derived from expenditure is `r format(round(as.vector(unlist(expenditure_gap %>% mutate(diff=Q5-Q1) %>% filter(year==2021) %>% select(diff))),1),scientific=FALSE)` `r ktco2vec` and in emissions-generating activities `r format(round(as.vector(unlist(hh_activity_gap %>% mutate(diff=Q5-Q1) %>% filter(year==2021) %>% select(diff))),1),scientific=FALSE)` `r ktco2vec`. The ratio of the last to the first quantile is `r format(round(as.vector(unlist(expenditure_gap %>% mutate(diff=Q5/Q1) %>% filter(year==2021) %>% select(diff))),1),scientific=FALSE)` for the former and `r format(round(as.vector(unlist(hh_activity_gap %>% mutate(diff=Q5/Q1) %>% filter(year==2021) %>% select(diff))),1),scientific=FALSE)` for the latter. Emissions inequality is higher in consumption than in direct activities, but in transport activities the ratio is `r format(round(as.vector(unlist(ratio_hh_activity_gap %>% mutate(diff=Q5/Q1) %>% filter(year==2021&type=="HH_TRA") %>% select(diff))),1),scientific=FALSE)`. Differences in heating/cooling emissions are minor (`r format(round(as.vector(unlist(ratio_hh_activity_gap %>% mutate(diff=Q5/Q1) %>% filter(year==2021&type=="HH_HEAT") %>% select(diff))),1),scientific=FALSE)`), indicating that they are compararively much more income-inelastic. In terms of equivalized emissions, differences are stronger in heating/cooling and as much in transport activities and other emissions. 

Subsetting by socio-demographic groups, as shown in Tables 3 and 4, we find a different reading. Looking across age groups for the household reference person we find some differences, particularly in terms of average equivalized `r kgGHGvec` and for the cases of transport expenditure and activity. The central age groups (35-54, 55-70) have higher equivalized income, expenditure, and `r kgGHGvec`, than the young (15-34) and the old ($+71$), but only to a limited extent. In equivalized terms, households whose reference person is female or male show only small variations, with the exception of transport, recreation activities, and hotels and restaurants, as well as heating/cooling emissions, where the former is responsable for a larger `r kgGHGvec` volume. The opposite is true in the case of direct transport activity, where male reference person households generate more `r kgGHGvec`. As for the highest education level achieved by the reference person, the overlap with income is visible, and we have a strong jump from primary to secondary and, then, to tertiary in terms of income but more than proportionally in terms of `r kgGHGvec`, growing by `r format(round(as.vector(unlist(table_full_co2 %>% mutate(ratio=(Tertiary-Primary)/Primary) %>% filter(grepl("kg",COICOP)) %>% select(ratio)))*100,1), scientific=FALSE)`%. By education level, we can observe the largest differences in `r format(names_list(stringr::str_to_lower(as.vector(unlist(table_full_co2 %>% mutate(ratio=(Tertiary-Primary)/Primary) %>% top_n(3,ratio) %>% select(coicop_g2d_heading_short))))),scientific=FALSE)`. As per tenure status, the sharpest variation obtains between partial owner and renteer, in large part seemingly due to the substantial income difference between the two demographics.

<!--, with the exception of the $+71$ year old, whose consumption and, hence, emissions are even below those of the youngest cohort. Alternatively, if we look into the strongest variations in the share of each group on total `r co2vec` emissions by households, we find that `r format(top_share_diff, scientific=FALSE)` are the groups whose contribution grows the most, and `r format(bottom_share_diff, scientific=FALSE)` the ones at the opposite end. [INCLUDE REFERENCE TO GENDER AND TO EDUCATION LEVEL THAT ARE GOING TO GO INTO THE APPENDIX. THE MESSAGE IS ABOUT HOW DEMOGRAPHICS CHANGE THE IDEA FROM THE AGGREGATE]-->

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  #### [a] average income by group
  table_full_3d_co2 <- budget_survey_hh_city_GHG %>% group_by(ANOENC,QUNTLG,CODIGOd3) %>% 
  summarise_at(c("kgGHG"),~round(sum(.*FACTOR,na.rm=TRUE)/sum(FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
  mutate_at(c("group"),~paste0("Q",.)) %>% pivot_wider(names_from = "group",values_from = "kgGHG") %>%
  left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,EDADG,CODIGOd3) %>% 
  summarise_at(c("kgGHG"),~round(sum(.*FACTOR,na.rm=TRUE)/sum(FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year","COICOP")) %>%
  left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,ESTUDIOG,CODIGOd3) %>% 
  summarise_at(c("kgGHG"),~round(sum(.*FACTOR,na.rm=TRUE)/sum(FACTOR,na.rm=TRUE),1)) %>% filter(!is.na(ESTUDIOG)) %>%
  set_names(c("year","group","COICOP","kgGHG")) %>% pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year","COICOP")) %>% 
  left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,SEXOG,CODIGOd3) %>% 
  summarise_at(c("kgGHG"),~round(sum(.*FACTOR,na.rm=TRUE)/sum(FACTOR,na.rm=TRUE),1)) %>% set_names(c("year","group","COICOP","kgGHG")) %>%
  pivot_wider(names_from = "group",values_from = "kgGHG"),by=c("year","COICOP")) %>% 
  filter(year==year_end_city) %>% ungroup %>% left_join(code_coicop_d3 %>% distinct(coicop_g3d,
  ecoicop_g3d_heading),by=c("COICOP"="coicop_g3d")) %>% 
  mutate_at(c("ecoicop_g3d_heading"),~if_else(is.na(.),"",.)) %>% 
  mutate_at(c("COICOP"),~paste0(COICOP," ",ecoicop_g3d_heading)) %>% 
  select(COICOP,`Q1`:`Q5`,`15-34`:`+71`,everything(),-year)
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
  table_full_co2_gender <- table_full_co2 %>% select(COICOP,`Primary`:`coicop_g2d_heading_short`)
  ma_co2_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("kg",COICOP)) %>% select(`Male`)))
  fe_co2_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("kg",COICOP)) %>% select(`Female`)))
  ma_inc_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("income",COICOP)) %>% select(`Male`)))
  fe_inc_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("income",COICOP)) %>% select(`Female`)))
```
```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=FALSE}
  table_full_co2_gender <- table_full_co2 %>% select(COICOP,`Primary`:`coicop_g2d_heading_short`)
  ma_heat_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("Heating",COICOP)) %>% select(`Male`)))
  fe_heat_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("Heating",COICOP)) %>% select(`Female`)))
  ma_tra_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("Transport ",COICOP)) %>% select(`Male`)))
  fe_tra_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("Transport ",COICOP)) %>% 
  select(`Female`)))
  ma_tras_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("07 Transport",COICOP)) %>% 
  select(`Male`)))
  fe_tras_kg <- as.vector(unlist(table_full_co2_gender %>% filter(grepl("07 Transport",COICOP)) %>% 
  select(`Female`)))
```

<!--From a socio-demographic perspective, gender is also a relevant grouping variable to understand the distribution of emissions responsibility. Households with male heads emit on average `r format(ma_co2_kg, scientific=FALSE)` `r kgGHGvec`, which is `r format(round(ma_co2_kg*100/fe_co2_kg,1), scientific=FALSE)`% more than those where the main breadwinner is female. This reflects an income gender gap of \euro{}`r format(ma_inc_kg-fe_inc_kg, scientific=FALSE)` (`r format(round((ma_inc_kg-fe_inc_kg)*100/fe_inc_kg,1), scientific=FALSE)`%) out of an average household equivalized disposable income of \euro{}`r format(fe_inc_kg, scientific=FALSE)` for females. Interestingly, there are clear differences in consumption patterns. While male and female heads spend similar amounts on heating, `r format(round(ma_heat_kg*100/ma_co2_kg,1), scientific=FALSE)`% and `r format(round(fe_heat_kg*100/fe_co2_kg,1), scientific=FALSE)`%, respectively, male-headed households spend `r format(round(ma_tra_kg,1), scientific=FALSE)` on transport, whereas female-headed ones almost half with `r format(fe_tra_kg, scientific=FALSE)` `r kgGHGvec` on average per year. Since the amounts of emissions embedded in their respective spending on transport are relatively close, `r format(round(ma_tras_kg,1), scientific=FALSE)` and `r format(round(fe_tras_kg,1), scientific=FALSE)` `r kgGHGvec`, respectively, the gap in direct emissions likely reflects different mobility choices. We find other relevant gender gaps in healthcare, which is much higher for female-headed households, alcohol & tobacco, and clothing and footwear, for which we find very similar footprints. Households where the main income earner is female are also larger on average, and with more children, which overlaps with strong demographic profiles of single-parent households and women outliving their partners.-->

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  epf_centile_groups <- function(x, WeightVar, Quantiles = seq(0,1, by = 0.01)){
    c(-Inf,Hmisc::wtd.quantile(x, weights = WeightVar, probs = Quantiles[2:(length(Quantiles)-1)], na.rm = TRUE) %>%
    as.vector(),+Inf)}
  epf_decile_groups <- function(x, WeightVar, Quantiles = seq(0,1, by = 0.1)){
    c(-Inf,Hmisc::wtd.quantile(x, weights = WeightVar, probs = Quantiles[2:(length(Quantiles)-1)], na.rm = TRUE) %>%
    as.vector(),+Inf)}
  epf_quintile_groups <- function(x, WeightVar, Quantiles = seq(0,1, by = 0.2)){
    c(-Inf,Hmisc::wtd.quantile(x, weights = WeightVar, probs = Quantiles[2:(length(Quantiles)-1)], na.rm = TRUE) %>%
    as.vector(),+Inf)}

  create_groups_epf <- function(dataset) {
      dataset %<>% select(-starts_with("DECIL"),-starts_with("QUNTL"),-starts_with("CENTL"))
      dataset %<>% left_join(dataset %>%  distinct(ANOENC,NUMERO,FACTOR,IMPEXACEQV) %>% group_by(ANOENC) %>%
      mutate(CENTLI = cut(IMPEXACEQV, breaks = epf_centile_groups(IMPEXACEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(DECILI = cut(IMPEXACEQV, breaks = epf_decile_groups(IMPEXACEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(QUNTLI = cut(IMPEXACEQV, breaks = epf_quintile_groups(IMPEXACEQV,FACTOR),include.lowest=TRUE,labels=FALSE)),
      by = c("ANOENC","NUMERO","FACTOR","IMPEXACEQV"))
      dataset %<>% left_join(dataset %>%  distinct(ANOENC,NUMERO,FACTOR,GASTOEQV) %>% group_by(ANOENC) %>%
      mutate(CENTLG = cut(GASTOEQV, breaks = epf_centile_groups(GASTOEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(DECILG = cut(GASTOEQV, breaks = epf_decile_groups(GASTOEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(QUNTLG = cut(GASTOEQV, breaks = epf_quintile_groups(GASTOEQV,FACTOR),include.lowest=TRUE,labels=FALSE)),
      by = c("ANOENC","NUMERO","FACTOR","GASTOEQV"))
  }
  
  create_carbon_groups_epf <- function(dataset) {
      dataset %<>% select(-starts_with("DECILC"),-starts_with("QUNTLC"),-starts_with("CENTLC"))
      dataset %<>% left_join(dataset %>% distinct(ANOENC,NUMERO,FACTOR,kgGHGEQV) %>% group_by(ANOENC) %>%
      mutate(CENTLC = cut(kgGHGEQV, breaks = epf_centile_groups(kgGHGEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(DECILC = cut(kgGHGEQV, breaks = epf_decile_groups(kgGHGEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(QUNTLC = cut(kgGHGEQV, breaks = epf_quintile_groups(kgGHGEQV,FACTOR),include.lowest=TRUE,labels=FALSE)),
      by = c("ANOENC","NUMERO","FACTOR","kgGHGEQV"))
  }
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
budget_survey_hh_city_GHG <- readRDS(file.path(datasets_path,"budget_survey_hh_city_GHG.rds")) %>% create_groups_epf %>% create_carbon_groups_epf
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  set.seed(135546) 
  budget_survey_hh_city_GHG %<>% create_groups_epf %>% create_carbon_groups_epf
  emissions_spending_sim <- data.frame()
  for(group_n in c(seq(9,5,-1))){
    #### [a] estimation of the budget limit
    budget_median <- budget_survey_hh_city_GHG %>% filter(CENTLI>44&CENTLI<56) %>% 
    group_by(ANOENC,CODIGOd3) %>% summarize_at(c("GASTO"),~sum(.*FACTOR,na.rm=TRUE)) %>% 
    group_by(ANOENC) %>% mutate_at(c("GASTO"),~./sum(.,na.rm=TRUE))
    #### [b] imputation of the budget limit
    temp_budget_centile_change <- budget_survey_hh_city_GHG %>% filter(DECILI>group_n) %>%
    distinct(ANOENC,NUMERO,CODIGOd3,FACTOR,HH_HEAT,HH_TRA,HH_OTH,GASTOT,kgGHGTOT,kgGHG) %>%
    left_join(budget_median,by=c("ANOENC","CODIGOd3")) %>% mutate_at(c("GASTO"),~GASTOT*GASTO) %>% rename("kgGHGprior"="kgGHG") %>%
    left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,CODIGOd3) %>% summarize_at(c("GASTO","kgGHG"),
    ~sum(.,na.rm=TRUE)) %>% mutate(intensity=kgGHG/GASTO) %>% ungroup %>% select(ANOENC,CODIGOd3,kgGHG,intensity),
    by=c("ANOENC","CODIGOd3")) %>% mutate_at(c("kgGHG"),~GASTO*intensity) %>% group_by(ANOENC,NUMERO) %>%
    mutate(kgGHGnew=sum(kgGHG,na.rm=TRUE)) %>% rename("kgGHGpost"="kgGHG","kgGHGold"="kgGHGTOT") %>% ungroup %>% 
    select(ANOENC,NUMERO,CODIGOd3,FACTOR,kgGHGprior,kgGHGpost,kgGHGold,kgGHGnew)
    #### [c] join the rest of the data [I NEED TO JOIN BY YEAR AND IDENTIFIER]
    budget_hh_CO2_new <- budget_survey_hh_city_GHG %>% select(ANOENC,NUMERO,FACTOR,CODIGOd3,GASTO,kgGHG:GASTOT,IMPEXAC,IMPEXACEQV,UC2) %>%
    left_join(temp_budget_centile_change %>% distinct(ANOENC,NUMERO,FACTOR,CODIGOd3,kgGHGpost,kgGHGnew),
    by=c("ANOENC","NUMERO","FACTOR","CODIGOd3")) %>% mutate_at(c("kgGHG"),~if_else(!is.na(kgGHGpost),kgGHGpost,.)) %>%
    mutate_at(c("kgGHGTOT"),~if_else(!is.na(kgGHGnew),kgGHGnew,.))
    coicop_CO2_reduce <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,FACTOR,CODIGOd3,kgGHG) %>% group_by(ANOENC,CODIGOd3) %>% 
    summarize_at(c("kgGHG"),~sum(.*FACTOR,na.rm=TRUE)/1e06) %>% left_join(budget_hh_CO2_new %>% 
    distinct(ANOENC,NUMERO,FACTOR,CODIGOd3,kgGHG) %>% group_by(ANOENC,CODIGOd3) %>% rename("kgGHGnew"="kgGHG") %>%
    summarize_at(c("kgGHGnew"),~sum(.*FACTOR,na.rm=TRUE)/1e06),by=c("ANOENC","CODIGOd3"))
    total_CO2_reduce <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,FACTOR,kgGHGTOT) %>% group_by(ANOENC) %>% 
    summarize_at(c("kgGHGTOT"),~sum(.*FACTOR,na.rm=TRUE)/1e06) %>% left_join(budget_hh_CO2_new %>% 
    distinct(ANOENC,NUMERO,FACTOR,kgGHGTOT) %>% group_by(ANOENC) %>% rename("kgGHGTOTnew"="kgGHGTOT") %>%
    summarize_at(c("kgGHGTOTnew"),~sum(.*FACTOR,na.rm=TRUE)/1e06),by=c("ANOENC"))
    #### [d] compute totals and ratios of mitigation 
    temp_emissions_cut <- coicop_CO2_reduce %>% left_join(total_CO2_reduce,by=c("ANOENC")) %>% mutate(group=group_n)
    emissions_spending_sim %<>% bind_rows(temp_emissions_cut)
  }
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
    coicop_reduction_top50_tota <- as.vector(unlist(emissions_spending_sim %>% 
    filter(ANOENC==2019&group==5) %>% distinct(ANOENC,kgGHGTOT) %>% select(-ANOENC)))
    coicop_reduction_top50_totb <- as.vector(unlist(emissions_spending_sim %>% 
    filter(ANOENC==2019&group==5) %>% distinct(ANOENC,kgGHGTOTnew) %>% select(-ANOENC)))
    # coicop_reduction_top50_totc <- as.vector(unlist(readRDS(file.path(datasets_path,
    # "city_emissions_coicop_gva_sim.rds")) %>% as_tibble() %>% filter(shock==0.5) %>% 
    # group_by(code) %>% transmute(kgGHG_sim=rowSums(across(`AR_A`:`ZA_T`),na.rm=TRUE)) %>% 
    # ungroup %>% mutate(CODIGOd2=stringr::str_sub(code,1,2)) %>% 
    # summarise_at(c("kgGHG_sim"),~sum(.,na.rm=TRUE))))
    
    coicop_reduction_top50 <- emissions_spending_sim %>% 
    filter(ANOENC==2019&group==5) %>% mutate(CODIGOd2=stringr::str_sub(CODIGOd3,1,2)) %>%
    group_by(CODIGOd2) %>% summarise_at(c("kgGHG","kgGHGnew"),~sum(.,na.rm=TRUE))%>%
    left_join(code_coicop_d2 %>% distinct(coicop_g2d,coicop_g2d_heading_short) %>%
    rename("heading"="coicop_g2d_heading_short"),by=c("CODIGOd2"="coicop_g2d")) %>%
    pivot_longer(`kgGHG`:`kgGHGnew`,names_to = "type",values_to = "kgGHG") %>%
    mutate_at(c("type"),~case_when(.=="kgGHG"~"actual",.=="kgGHGnew"~"projected")) 
    
    #### [a] food
    coicop_reduction_top50_01 <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="01") %>%
    filter(type=="projected") %>% select(kgGHG)))
    coicop_reduction_top50_01_actual <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="01") %>%
    filter(type=="actual") %>% select(kgGHG)))
    coicop_reduction_top50_01_gvc <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="01") %>%
    filter(type=="gvc") %>% select(kgGHG)))
    #### [b] transport
    coicop_reduction_top50_07 <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="07") %>%
    filter(type=="projected") %>% select(kgGHG)))
    coicop_reduction_top50_07_actual <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="07") %>%
    filter(type=="actual") %>% select(kgGHG)))
    coicop_reduction_top50_07_gvc <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="07") %>%
    filter(type=="gvc") %>% select(kgGHG)))
    #### [c] recreation
    coicop_reduction_top50_09 <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="09") %>%
    filter(type=="projected") %>% select(kgGHG)))
    coicop_reduction_top50_09_actual <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="09") %>%
    filter(type=="actual") %>% select(kgGHG)))
    coicop_reduction_top50_09_gvc <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="09") %>%
    filter(type=="gvc") %>% select(kgGHG)))
    #### [d] restaurants
    coicop_reduction_top50_11 <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="11") %>%
    filter(type=="projected") %>% select(kgGHG)))
    coicop_reduction_top50_11_actual <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="11") %>%
    filter(type=="actual") %>% select(kgGHG)))
    coicop_reduction_top50_11_gvc <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="11") %>%
    filter(type=="gvc") %>% select(kgGHG)))
```

<!-- In this sense, @fig-cf-coicopCO2 shows how many `r ktco2vec` would the city save if we impose the median consumption structure on the top 50% of the equivalized spending distribution. -->
We can illustrate the relative importance of the expenditure *structure* in addition to the expenditure level. While moderation of expenditure levels have a straightforward implications for households' CF, variation in the spending composition as a function of per capita spending can have a less obvious but sizeable impact [@levinsonEnvironmentalEngelCurves2015]. A possible implication of Engel's Law is the non-linear growth in total emissions [@browningEngelLaw2018;@levinsonEnvironmentalEngelCurves2015]. As we have seen, essentials, such as food or transport, are relatively more carbon intensive than other products. If we imposed a poorer consumption structure, hence a higer share of spending on essentials, on the the upper segment of the spending distribution, we might increase, rather than reduce, the total amount of consumption-related `r ktco2vec` if consumption levels remained the same for the whole distribution. <!--Without curtailing spending, it indicates how much emissions savings could be realized by addressing consumption patters. By the same token, it can clarify the extent of any possible gains from supply chain swaps by comparing them against a conservative demand policy.-->However, the opposite seems true. Imposing the median consumption structure above the $50^{th}$ percentile would amount to a reduction of `r format(round(coicop_reduction_top50_tota-coicop_reduction_top50_totb,1), scientific=FALSE)` `r ktco2vec` (`r format(round(abs(coicop_reduction_top50_totb-coicop_reduction_top50_tota)*100/coicop_reduction_top50_tota,1), scientific=FALSE)`%) in `r format(year_end_city, scientific=FALSE)`. For comparison, total `r co2vec` emissions caused by food spending will slightly increase by `r format(round(abs(coicop_reduction_top50_01-coicop_reduction_top50_01_actual)*100/coicop_reduction_top50_01_actual,1),scientific=FALSE)`%, whereas for housing and utilities they would remain at the same level. On the other hand, emissions from transport services, hotels and restaurants , and recreation and culture will decline noticeably by `r format(round(abs(coicop_reduction_top50_07-coicop_reduction_top50_07_actual)*100/coicop_reduction_top50_07_actual,1),scientific=FALSE)`%, `r format(round(abs(coicop_reduction_top50_11-coicop_reduction_top50_11_actual)*100/coicop_reduction_top50_11_actual,1),scientific=FALSE)`%, and `r format(round(abs(coicop_reduction_top50_09-coicop_reduction_top50_09_actual)*100/coicop_reduction_top50_09_actual,1),scientific=FALSE)`%, respectively. By looking at the rest of consumption purposes we can see that furnishings and home maintenance, healthcare, and miscellanea are more important as we move up in the spending distribution, but nowhere near the case of education, whose emissions would be almost negligible compared to the rest of consumption groups.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
library(tidyverse);library(magrittr)
budget_survey_hh_city_GHG %<>% create_groups_epf
set.seed(135546)
emissions_evs_sim <- data.frame()
  for(prob_n in seq(0.05,0.95,0.05)){
    temp_emissions_evs_sim <- data.frame()
    #### [a] create bernoulli selection of EVs
    data_emissions_cut <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,.keep_all = TRUE) %>% group_by(DECILI) %>% 
    mutate(EVs = sample(0:1, n(), prob = c((1-prob_n),prob_n), replace = TRUE))
    for(group_n in c(seq(9,1,-1))){ #seq(99,50,-1) 
      #### [b] estimation of emissions cut
      temp_emissions_cut <- data_emissions_cut %>% mutate_at(c("HH_TRA"),~if_else(DECILI>group_n&EVs==1,.*0,.)) %>%
      group_by(ANOENC) %>% summarize_at(c("HH_TRA"),~sum(.*FACTOR,na.rm=TRUE)/1e06) %>% mutate(centil=group_n) %>%
      set_names(c("year","HH_TRA_EVs","group"))
      #### [c] count of households in this situation
      temp_emissions_cut %<>% left_join(data_emissions_cut %>% group_by(ANOENC,EVs) %>% filter(DECILI>group_n) %>%
      summarize_at(c("FACTOR"),~sum(.,na.rm=TRUE)) %>% pivot_wider(names_from = "EVs",
      values_from = "FACTOR") %>% set_names(c("year","noEVs","EVs")),by=c("year")) %>%
      #### [d] average income and household footprint
      left_join(data_emissions_cut %>% group_by(ANOENC) %>% filter(DECILI>group_n) %>%
      summarize_at(c("IMPEXACEQV"),~weighted.mean(.,FACTOR,na.rm=TRUE)) %>% set_names(c("year","IMPEXACEQV")),by=c("year")) %>%
      left_join(data_emissions_cut %>% group_by(ANOENC) %>% #filter(DECILI>group_n) %>% 
      summarize_at(c("kgGHGTOT","HH_HEAT","HH_TRA","HH_OTH"),~sum(.*FACTOR,na.rm=TRUE)/1e06) %>% 
      set_names(c("year","kgGHG","HH_HEAT","HH_TRA","HH_OTH")),by=c("year"))
      temp_emissions_evs_sim %<>% bind_rows(temp_emissions_cut)
    }
  temp_emissions_evs_sim %<>% left_join(temp_emissions_evs_sim %>% filter(group==9) %>% select(year,HH_TRA) %>%
  rename("TOT"="HH_TRA"),by=c("year")) %>% mutate(`HH_TRA_EVs%`=HH_TRA_EVs/TOT) %>% mutate(adoption_like=prob_n)
  emissions_evs_sim %<>% bind_rows(temp_emissions_evs_sim)
  }
```
```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  library(wesanderson);library(latex2exp)
  emissions_evs_sim %>% filter(year%in%c(2021)) %>% filter(adoption_like==0.5) %>% 
  select(`HH_TRA_EVs%`,`HH_TRA_EVs`,year,group) %>% left_join(emissions_evs_sim %>% group_by(year,group) %>% summarize(`95%`=quantile(HH_TRA_EVs,probs=.95),`5%`=quantile(HH_TRA_EVs,probs=.05)),
  by=c("year","group")) %>% ungroup %>% rename("groups"="group") %>% filter(!groups==1) %>%
    ggplot(aes(y=`HH_TRA_EVs`,x=factor(groups,levels=c(rev(seq(2,9,1)))),
    fill=factor(groups,levels=c(rev(seq(2,9,1)))))) + 
    geom_bar(position="dodge", stat="identity",color="white") + scale_fill_brewer(palette="Dark2") +
    #geom_errorbar(aes(x=factor(groups,levels=c(rev(seq(2,9,1)))), ymin=`5%`, ymax=`95%`), width=0.2, #colour="black", alpha=0.8, size=.5) +
    labs(fill='') + xlab("Target lower bound decile") + ylab(TeX("kt$\\CO_2e$")) + guides(fill=guide_legend(nrow=3,reverse=TRUE)) +
    theme(text = element_text(size = 20),axis.ticks.x=element_blank(),
    axis.ticks.y=element_blank(),legend.position = "none",
    panel.border=element_blank(),legend.margin=margin(0,0,0,0))
  ggsave(file.path(getwd(),"paper","graphics","simulation_evs_GHG_reduction.pdf"),height = 5,width = 10)
```

Conversely, we can also evaluate the potential of mobility policies vis-à-vis expenditure policies by simulating the impact on total `r co2vec` that interventions targeting either a substantial limitation of private emissions-generating road transport or the increasing adoption of electric vehicles could potentially have. Table 3 highlighted the outstanding contribution of private mobility choices to the average household's CF in Madrid. In this sense, reductions in private transport outweight any reasonable intervention on consumption demand. To exemplify this point, @fig-cf-coicopCO2b reports how many `r ktco2vec` would the city save if households reduced 50% of their use of private vehicles cummulatively from the richest to the poorest of the target bottom decile of the intervention. In orther words, by simulating a 50% adoption of carbon-neutral transport activities by households in the ninth, or from the ninth to the eighth, and so on, decile, we can illustrate the total `r ktco2vec` savings.<!-- Whereas in the case of the ninth decile we subset the top 10% of households, in the case of the eighth decile we take the top 20%, and so on. -->Within the top 10%, 20%, 30%, and down to 80% we randomly sample with probability $1/2$ a series of households from the set of those with positive fuel spending records. We then eliminate completely their transport emissions and derive the new totals. This assumes that all household members either switch to other means of transportation (public transit, cycling or walking) or turn to electric vehicles (EVs) to meet their mobility needs.

![Simulated direct transport emissions levels resulting from a 50% addoption rate of carbon-free transport activities by households from the top down to the corresponding bottom spending decile of the intervention range, `r format(year_end_city, scientific=FALSE)`. *Source*: Authors' own calculation.](graphics/simulation_evs_GHG_reduction.pdf){#fig-cf-coicopCO2b}

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
emissions_tra_tot <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,.keep_all = TRUE) %>% 
group_by(ANOENC) %>% summarize_at(c("HH_TRA"),~sum(.*FACTOR,na.rm=TRUE)/1e06)
emissions_tra_tot_year_end_city <- as.vector(unlist(emissions_tra_tot %>% filter(ANOENC==year_end_city) %>% select(HH_TRA)))
emissions_tra_tot_year_end_city_d9 <- as.vector(unlist(emissions_evs_sim %>% 
filter(year==year_end_city&adoption_like==0.5) %>% filter(group==9) %>%select(HH_TRA_EVs)))
emissions_tra_tot_year_end_city_d2 <- as.vector(unlist(emissions_evs_sim %>% 
filter(year==year_end_city&adoption_like==0.5) %>% filter(group==2) %>%select(HH_TRA_EVs)))
emissions_tra_tot_year_end_city_d5 <- as.vector(unlist(emissions_evs_sim %>% 
filter(year==year_end_city&adoption_like==0.5) %>% filter(group==5) %>%select(HH_TRA_EVs)))
#### [b] different adoption likelihood
emissions_tra_tot_5prtc_year_end_city_d5 <- as.vector(unlist(emissions_evs_sim %>% 
filter(year==year_end_city&adoption_like==0.05) %>% filter(group==5) %>%select(HH_TRA_EVs)))
emissions_tra_tot_80prtc_year_end_city_d7 <- as.vector(unlist(emissions_evs_sim %>% 
filter(year==year_end_city&adoption_like==0.80) %>% filter(group==7) %>%select(HH_TRA_EVs)))
```

@fig-cf-coicopCO2b shows that the mitigation potential of changes to private transport are considerable. Depending on the penetration rate of (close to) carbon neutral means transportation across the spending distribution, we obtain different `r co2vec` savings. If we limit this transformation to the top 10%, we find that direct transport emissions by households go down from `r format(round(emissions_tra_tot_year_end_city,1), scientific=FALSE)` `r ktco2vec` to `r format(round(emissions_tra_tot_year_end_city_d9,1), scientific=FALSE)` `r ktco2vec`, which is a `r format(round(100-(emissions_tra_tot_year_end_city_d9*100/emissions_tra_tot_year_end_city),1), scientific=FALSE)`% reduction. Alternatively, if one in every two households implement this drastic change, we would end up with `r format(round(emissions_tra_tot_year_end_city_d5,1), scientific=FALSE)` `r ktco2vec`, which represents `r format(100-round(emissions_tra_tot_year_end_city_d5*100/emissions_tra_tot_year_end_city,1), scientific=FALSE)`% or `r format(round(emissions_tra_tot_year_end_city_d5,1), scientific=FALSE)` `r ktco2vec` fewer direct transport emissions. If this process reaches half of the household population, but excluding the bottom 10%, we would talk of approximately `r format(100-round(emissions_tra_tot_year_end_city_d2*100/emissions_tra_tot_year_end_city,1), scientific=FALSE)`% lower direct transport emissions by households in `r format(year_end_city, scientific=FALSE)`. By changing the probability of adoption, we obtain very different emissions reduction totals. With one out of every twenty households in the top 50% following suit, we get as little as a `r format(100-round(emissions_tra_tot_5prtc_year_end_city_d5*100/emissions_tra_tot_year_end_city,1), scientific=FALSE)`% reduction. Conversely, if the likelihood of adoption increases to 80% among the top three deciles, we could see direct transport emissions falling to `r format(round(emissions_tra_tot_80prtc_year_end_city_d7,1), scientific=FALSE)` `r ktco2vec`, which is `r format(100-round(emissions_tra_tot_80prtc_year_end_city_d7*100/emissions_tra_tot_year_end_city,1), scientific=FALSE)`% less. These scenarios highlight the enormous potential for `r co2vec` emissions reduction that could derive from a strong commitment to fostering the adoption of electric vehicles, public transportation, or cycling.

<!---->
## Breaking down the drivers of the carbon footptint's growth path{#sec-decomposition-simulation}
```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  library(kableExtra)
  readRDS(file.path(datasets_path,"str_decomposition.rds")) %>% filter(cou%in%c("ES30")) %>% 
  select(-check,-cou) %>% left_join(str_decomposition %>% filter(cou%in%c("ES")) %>%
  select(-check,-cou),by=c("code")) %>% set_names(c("code",paste0("ES30_",c("emissions","input","tech",
  "demand")), paste0("ES_",c("emissions","input","tech","demand")))) %>% mutate_if(is.double,~round(.,2)) %>%
  kbl(booktabs = T,"latex") %>% kable_styling(latex_options = c("hold_position"),font_size = 8)
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  sda_method <- "trade&technology"
  sda_vector <- "P3_S14"
  year_sda   <- 2019
  str_decomposition <- readRDS(file.path(datasets_path,paste0("str_decomposition_",
  sda_method,"_",sda_vector,".rds"))) %>% as_tibble()
  str_decomposition_plot <- str_decomposition %>% filter(cou%in%c("ES30")) %>% pivot_longer(`delta_emiss`:`change_demd`,names_to = "factor",values_to = "obs_value") %>%
  bind_rows(str_decomposition %>% filter(cou%in%c("ES")) %>% pivot_longer(`delta_emiss`:`change_demd`,names_to = "factor",values_to = "obs_value")) %>% 
    bind_rows(str_decomposition %>% filter(cou%in%c("ES30")) %>% pivot_longer(`delta_emiss`:`change_demd`,names_to = "factor",values_to = "obs_value") %>%
    bind_rows(str_decomposition %>% filter(cou%in%c("ES")) %>% pivot_longer(`delta_emiss`:`change_demd`,names_to = "factor",values_to = "obs_value")) %>%
    group_by(cou,factor) %>% summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% mutate(code="Total") %>% select(cou,code,factor,obs_value)) %>%
    select(-check) %>% mutate_at(c("factor"),~case_when(.=="delta_emiss"~"Total",.=="change_input"~"Intensity",.=="change_trade"~"Trade",
    .=="change_tech"~"Technology",.=="change_demd"~"Consumption")) %>% filter(cou=="ES30") %>% filter(!code=="T") %>%
      left_join(readxl::read_xlsx(file.path(datasets_path,"classification_iots_mad.xlsx"),sheet = "City") %>%
      filter(digits_full>2) %>% distinct(nace_code,Definition_short_en),by=c("code"="nace_code")) %>% 
      mutate_at(c("Definition_short_en"),~if_else(code=="Total","Total",.)) 
```

```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  library(wesanderson);library(latex2exp);library(ggthemes)
  str_decomposition_mad %>%
  ggplot(aes(x=`obs_value`,y=factor(factor,levels=rev(c("ktCO2","Intensity","Trade","Technology","Consumption"))),group=factor,fill=factor)) + 
  geom_bar(position="dodge", stat="identity",color="white") + scale_fill_brewer(palette="Dark2") + facet_wrap(~factor(Definition_short_en,
  levels=c(as.vector(unlist(str_decomposition_mad %>% distinct(code,Definition_short_en) %>% arrange(code) %>% select(Definition_short_en))))),
  ncol = 7,scales = "free_x") + labs(fill='') + ylab(TeX("Components of total kt$\\CO_2$ growth")) + xlab(TeX("kt$\\CO_2$")) + 
  guides(fill=guide_legend(nrow=1,reverse=TRUE)) + theme(text = element_text(size = 12),axis.ticks.x=element_blank(),axis.text = element_text(size = 10),
  axis.ticks.y=element_blank(),legend.position = "none",panel.border=element_blank(),legend.margin=margin(0,0,0,0))
  ggsave(file.path(getwd(),"paper","graphics",paste0("sda_decomposition.pdf")),height = 6,width = 12)
  ggsave(file.path(getwd(),"graphics",paste0("sda_decomposition.pdf")),height = 6,width = 12)
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  str_decomposition_prct = readRDS(file.path(datasets_path,"str_decomposition_prct.rds"))
  str_decomposition_plot <- str_decomposition %>% filter(cou%in%c("ES30")) %>% pivot_longer(`delta_emiss`:`change_demd`,names_to = "factor",values_to = "obs_value") %>%
  bind_rows(str_decomposition %>% filter(cou%in%c("ES")) %>% pivot_longer(`delta_emiss`:`change_demd`,names_to = "factor",values_to = "obs_value")) %>% bind_rows(str_decomposition %>% filter(cou%in%c("ES30")) %>% pivot_longer(`delta_emiss`:`change_demd`,names_to = "factor",values_to = "obs_value") %>%
  bind_rows(str_decomposition %>% filter(cou%in%c("ES")) %>% pivot_longer(`delta_emiss`:`change_demd`,
  names_to = "factor",values_to = "obs_value")) %>% group_by(cou,factor) %>% summarize_at(c("obs_value"),
  ~sum(.,na.rm=TRUE)) %>% mutate(code="Total") %>% select(cou,code,factor,obs_value)) %>%
  select(-check) %>% mutate_at(c("factor"),~case_when(.=="delta_emiss"~"Total",.=="change_input"~"Intensity",
  .=="change_trade"~"Trade",.=="change_tech"~"Technology",.=="change_demd"~"Consumption")) %>% filter(cou=="ES30") %>% filter(!code=="T") %>% left_join(readxl::read_xlsx(file.path(datasets_path,
  "classification_iots_mad.xlsx"),sheet = "City") %>% filter(digits_full>2) %>% distinct(nace_code,
  Definition_short_en),by=c("code"="nace_code")) %>% mutate_at(c("Definition_short_en"),~if_else(code=="Total",
  "Total",.)) %>% pivot_wider(names_from = "factor",values_from = "obs_value")
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  names_list <- function(string_n){
  string_n[string_n=="Rest of the world"] <- "the rest of the world"
  string_n[string_n=="Rest of Spain"] <- "the rest of Spain"
  string_n_list <- paste0(paste0(string_n[1:(length(string_n)-1)],
  collapse=", "),", and ",string_n[length(string_n)]);return(string_n_list)}
```

Sections [-@sec-subsec-results-gdp] and [-@sec-subsec-results-households] have reported the level, composition, and evolution of 3-scope `r co2vec` emissions driven by the city's gross domestic product and final household consumption. Using structural decomposition analysis (SDA) we can now delve into the underlying factors determining emissions generation. As presented in section [-@sec-subsec-decomposition], we break total emissions down by the contribution of intensity, trade structure, technology, and final household consumption. @fig-sda-decomposition presents the breakdown of total `r co2vec` emissions by 28-NACE activities into this four factors for the period from `r format(year_str_io, scientific=FALSE)` to `r format(year_end_city, scientific=FALSE)`. Starting with the aggregate economy, it experienced a decline in total emissions of `r format(round(as.vector(unlist(str_decomposition_plot %>% filter(code=="Total") %>% select(Total))),1), scientific=FALSE)` `r ktco2vec` or `r format(as.vector(unlist(str_decomposition_prct %>% filter(code=="Total") %>% select(Total))), scientific=FALSE)`%. This result is driven by a `r format(round(as.vector(unlist(str_decomposition_plot %>% filter(code=="Total") %>% select(Consumption))),1), scientific=FALSE)` `r ktco2vec` push by final consumption, `r format(as.vector(unlist(str_decomposition_prct %>% filter(code=="Total") %>% select(Consumption))), scientific=FALSE)`% increase, and a `r format(as.vector(unlist(str_decomposition_prct %>% filter(code=="Total") %>% select(Intensity))), scientific=FALSE)`%, `r format(as.vector(unlist(str_decomposition_prct %>% filter(code=="Total") %>% select(Trade))), scientific=FALSE)`%, and `r format(as.vector(unlist(str_decomposition_prct %>% filter(code=="Total") %>% select(Technology))), scientific=FALSE)`% fall in emissions driven by efficiency, trade, and technology, respectively. While the smallest contribution comes from changes to the technique of production, the larger emissions savings are realized thanks to efficiency gains.

![Structural decomposition of total Mt$CO_2$ growth in Madrid into emissions intensity, trade, technology, and consumption demand contributions for the city of Madrid. *Source*: Author's own calculations using FIGARO, ES-HBS, and municipal accounts.](graphics/sda_decomposition.pdf){#fig-sda-decomposition fig-env="figure*" width=100%}

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
    str_decomposition_cou_prct <- readRDS(file.path(datasets_path,"str_decomposition_cou_prct.rds"))
    str_decomposition_cou <- str_decomposition %>% 
    pivot_longer(`delta_emiss`:`change_demd`,names_to = "factor",values_to = "obs_value") %>%
    group_by(cou,factor) %>% summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% select(cou,factor,obs_value) %>%
    bind_rows(str_decomposition %>% pivot_longer(`delta_emiss`:`change_demd`,names_to = "factor",
    values_to = "obs_value") %>% group_by(factor) %>% summarize_at(c("obs_value"),~sum(.,na.rm=TRUE)) %>% 
    mutate(cou="WORLD") %>% select(cou,factor,obs_value)) %>%
    mutate_at(c("factor"),~case_when(.=="delta_emiss"~"Total",.=="change_input"~"Intensity",.=="change_trade"~"Trade",.=="change_tech"~"Technology",.=="change_demd"~"Consumption")) %>% 
    left_join(code_countries %>% select(CODE,NAME),
    by=c("cou"="CODE")) %>% mutate_at(c("NAME"),~if_else(cou=="WORLD","World total",.)) %>% 
    mutate_at(c("NAME"),~if_else(cou=="ES","Rest of Spain",.)) %>% 
    mutate_at(c("NAME"),~if_else(cou=="DE","Germany",.)) %>%
    pivot_wider(names_from = "factor",values_from = "obs_value") %>%
    ungroup
```

@fig-sda-decomposition-cou shows the full country results using data from FIGARO. Across countries, we see that regardless of emissions growing or shrinking, the contribution by the `r co2vec` intensity of the aggregate economic activity is negative and considerable with very few exceptions, such as `r format(names_list(as.vector(unlist(str_decomposition_cou %>% filter(Intensity>0) %>% arrange(Intensity) %>% select(NAME)))),scientific=FALSE)`. Trade, on the other hand, tends to add to total emissions for the majority of countries, most notably export-oriented economies, such as `r format(names_list(as.vector(unlist(str_decomposition_cou_prct %>% filter(Trade>0) %>% top_n(4,Trade) %>% arrange(-Trade) %>% select(NAME)))),scientific=FALSE)`, ordered by the proportion of their contribution. Technology tends to substract from emissions growth, but there are some examples of the opposite, such as `r format(names_list(as.vector(unlist(str_decomposition_cou_prct %>% filter(Technology>0) %>% top_n(4,Technology) %>% arrange(-Technology) %>% select(NAME)))),scientific=FALSE)`. Consumption demand, however, adds considerably to total emissions, and is in most cases solely responsible for countries failing to reduce their emissions despite gains in efficiency, trade or technology. Countries with negative growth of consumption demand are `r format(names_list(as.vector(unlist(str_decomposition_cou_prct %>% filter(Consumption<0) %>% arrange(Consumption) %>% select(NAME)))),scientific=FALSE)`. Spain excluding Madrid city displays a very common pattern: negative contributions by intensity and technology, but positive by consumption and trade, albeit small in the latter case. There are `r format(as.vector(unlist(str_decomposition_cou_prct %>% filter(Intensity<0&Technology<0&Trade>0&Consumption>0&Total<0) %>% nrow)),scientific=FALSE)` countries in this situation that have seen their emissions declined, most importantly `r format(names_list(as.vector(unlist(str_decomposition_cou_prct %>% filter(Intensity<0&Technology<0&Trade>0&Consumption>0&Total<0) %>% arrange(Total) %>% top_n(8,-Total) %>% select(NAME)))),scientific=FALSE)`, and `r format(as.vector(unlist(str_decomposition_cou_prct %>% filter(Intensity<0&Technology<0&Trade>0&Consumption>0&Total>0) %>% nrow)),scientific=FALSE)` countries with rising emissions, among which we can highlight `r format(names_list(as.vector(unlist(str_decomposition_cou_prct %>% filter(Intensity<0&Technology<0&Trade>0&Consumption>0&Total>0) %>% arrange(-Total) %>% top_n(5,Total) %>% select(NAME)))),scientific=FALSE)`. A majority of medium to large EU countries share the same pattern as Spain. In addition to this pattern, the city of Madrid benefits also from trade, and only consumption demand is pushing emissions higher, compensating most of the emission saved by the other three factors. Even if comparing a capital city with other countries is unreasonable, it still shows that it is not on the emissions-intensive end of the country and their neighbours.

If we compare this results with individual industries, we observe a large degree of heterogeneity that makes aggregate results not representative of the underlying drivers. The three industries that have increased their emissions the most in absolute terms are `r format(stringr::str_to_lower(names_list(as.vector(unlist(str_decomposition_plot %>% filter(Total>0) %>% top_n(3,Total) %>% arrange(-Total) %>% select(Definition_short_en))))),scientific=FALSE)`, with `r format(names_list(round(as.vector(unlist(str_decomposition_plot %>% filter(Total>0) %>% top_n(3,Total) %>% arrange(-Total) %>% select(Total))),1)),scientific=FALSE)` `r ktco2vec`, respectively. Conversely, `r format(stringr::str_to_lower(names_list(as.vector(unlist(str_decomposition_plot %>% filter(Total<0) %>% top_n(3,Total) %>% arrange(-Total) %>% select(Definition_short_en))))),scientific=FALSE)` realized the largest fall in emissions, `r format(names_list(round(as.vector(unlist(str_decomposition_plot %>% filter(Total<0) %>% top_n(3,Total) %>% arrange(Total) %>% select(Total))),1)),scientific=FALSE)` `r ktco2vec`. In percentage terms, `r format(stringr::str_to_lower(names_list(as.vector(unlist(str_decomposition_prct %>% filter(Total>0) %>% top_n(3,Total) %>% arrange(-Total) %>% select(Definition_short_en))))),scientific=FALSE)` showed the largest increases, and `r format(stringr::str_to_lower(names_list(as.vector(unlist(str_decomposition_prct %>% filter(!code=="Total") %>% filter(Total<0) %>% top_n(3,Total) %>% arrange(Total) %>% select(Definition_short_en))))),scientific=FALSE)` the largest declines. By component, we find no industry where the contribution of emissions intensity was positive. Nevertheless, variance in the extent of the reduction is considerable. From `r format(round(as.vector(unlist(str_decomposition_plot %>% filter(!code=="Total") %>% filter(Intensity==min(Intensity)) %>% select(Intensity))),1),scientific=FALSE)` `r ktco2vec` in `r format(stringr::str_to_lower(as.vector(unlist(str_decomposition_plot %>% filter(!code=="Total") %>% filter(Intensity==min(Intensity)) %>% select(Definition_short_en)))),scientific=FALSE)` to `r format(round(as.vector(unlist(str_decomposition_plot %>% filter(!code=="Total") %>% filter(Intensity==max(Intensity)) %>% select(Intensity))),1),scientific=FALSE)` `r ktco2vec` in `r format(stringr::str_to_lower(as.vector(unlist(str_decomposition_plot %>% filter(!code=="Total") %>% filter(Intensity==max(Intensity)) %>% select(Definition_short_en)))),scientific=FALSE)`. For the most part, the negative contribution of trade to emissions growth is smaller than intensity, but still significant. In particular, `r format(stringr::str_to_lower(names_list(as.vector(unlist(str_decomposition_plot %>% filter(Trade>Intensity) %>% top_n(3,Trade) %>% arrange(Total) %>% select(Definition_short_en))))),scientific=FALSE)` show a larger contribution to emissions reduction from trade than intensity. On the other hand, the effect of technology is modest and mixed, with some sectors adding and other substracting from total emissions. Noteworthy sectors are `r format(stringr::str_to_lower(names_list(as.vector(unlist(str_decomposition_plot %>% filter(Technology>Intensity&Technology>Trade) %>% top_n(3,Technology) %>% arrange(Technology) %>% select(Definition_short_en))))),scientific=FALSE)`, where technology outweights intensity and trade. Finally, the contribution of final consumption is robust and inequivocally positive, with the exception of `r format(stringr::str_to_lower(names_list(as.vector(unlist(str_decomposition_prct %>% filter(Consumption<0) %>% top_n(3,Consumption) %>% arrange(Consumption) %>% select(Definition_short_en))))),scientific=FALSE)`, where it declines. Overall, these results indicate that `r co2vec` emissions have continued to grow due to the strong pull by consumption demand despite the generalized gains in efficiency, trade, and technology across a majority of industries along the entire global value chain supplying to the city's economy.

![Structural decomposition of total Mt$CO_2$ growth for selected countries into emissions intensity, trade, technology, and consumption demand contributions for all countries in the sample. *Source*: Author's own calculations.](graphics/sda_decomposition_cou.pdf){#fig-sda-decomposition-cou fig-env="figure*" width=100%}

![Total embedded household consumption-linked emissions from Madrid by consumption purpose before and after the hypothetical projection of the median consumption structure, 2019. *Source*: Author's own calculations](graphics/three_scenarios_coicop_CO2_reduction.pdf){#fig-cf-coicopCO2 fig-env="figure*" width=90%}

We have observed that consumption strongly constraints or even reverses the push by efficiency, technology, and trade towards emissions reduction. By the same token, we can highlight that the contribution by the trade structure is only modest. An important hypothesis in the literature, and a environmental talking point, is that supply chain offshoring had been used as means for pollution evasion by advanced economies [@levinsonUnmaskingPollutionHave2008], which would indirectly benefit from shifts in the trade structure towards more efficient countries. This argument has been challenged in the past [@artoDriversGrowthGlobal2014], and our results agree with a relatively modest, and sometimes contradictory, emissions reduction potential from supply chain restructuring. Consumption demand clearly shapes the slow pace of decarbonization. Likewise, an important policy concern is the the potential of re-shoring to enhance mitigation efforts. To further assess the potential for emissions abatement and as a way to indirectly highlight the weight of domestic policies, we simulate three scenarios. From a methodological perspective, this is implemented, as explained in section [-@sec-subsec-decomposition], by simulating a trade shock to matrix $\mathbf{C}$, from which we derive a modified matrix $\mathbf{A}$ to calculate consumption-driven emissions following the @eq-carbon-footprint. In the first scenario, we explore the consequences of trade decoupling from non-Western suppliers by simulating a series of shocks on 10-point increment intervals to the input supplied by non-Western to Western countries, which are then substituted by intra-block Western supplies. For instance, we reduce the supplies of energy products from Saudi Arabia to France and, at the same time, we proportionally increase the supply from other Western countries to meet up the trade gap left by Saudi Arabia. This reallocation of input supplies follows the existing procurement proportions from other countries in the block, and assumes, somewhat unrealistically, that firms in Western countries are fully able to close the import gap in quality, quantity, and price. In addition to the current 28 EU countries, we include Canada, the United Kingdom, Japan, and the United States within the Western block. Secondly, we replicate the same exercise but this time restricting the domestic block to EU countries, with the purpose of illustrating harsh EU import restrictions that might be motivated by the desire to avoid carbon leakage. Finally, we produce an additional simulation in which EU countries switch from Chinese to US supplies, without affecting any other intermediate flow in the system. These three simulation scenarios are inspired by the recent implementation of tariffs and other trade barriers between the US, the EU, and China, and seeks to explore the extent to which, if feasible to swap suppliers, emissions will grow or fall as a result. These scenarios, which affect multiple countries, illustrate possible reconfigurations of trade that can potentially impact Madrid's scope-3 emissions.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  epf_centile_groups <- function(x, WeightVar, Quantiles = seq(0,1, by = 0.01)){
    c(-Inf,Hmisc::wtd.quantile(x, weights = WeightVar, probs = Quantiles[2:(length(Quantiles)-1)], na.rm = TRUE) %>%
    as.vector(),+Inf)}
  epf_decile_groups <- function(x, WeightVar, Quantiles = seq(0,1, by = 0.1)){
    c(-Inf,Hmisc::wtd.quantile(x, weights = WeightVar, probs = Quantiles[2:(length(Quantiles)-1)], na.rm = TRUE) %>%
    as.vector(),+Inf)}
  epf_quintile_groups <- function(x, WeightVar, Quantiles = seq(0,1, by = 0.2)){
    c(-Inf,Hmisc::wtd.quantile(x, weights = WeightVar, probs = Quantiles[2:(length(Quantiles)-1)], na.rm = TRUE) %>%
    as.vector(),+Inf)}

  create_groups_epf <- function(dataset) {
      dataset %<>% select(-starts_with("DECIL"),-starts_with("QUNTL"),-starts_with("VENTL"),-starts_with("PRCTL"))
      dataset %<>% left_join(dataset %>%  distinct(ANOENC,NUMERO,FACTOR,IMPEXACEQV) %>% group_by(ANOENC) %>%
      mutate(CENTLI = cut(IMPEXACEQV, breaks = epf_centile_groups(IMPEXACEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(DECILI = cut(IMPEXACEQV, breaks = epf_decile_groups(IMPEXACEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(QUNTLI = cut(IMPEXACEQV, breaks = epf_quintile_groups(IMPEXACEQV,FACTOR),include.lowest=TRUE,labels=FALSE)),
      by = c("ANOENC","NUMERO","FACTOR","IMPEXACEQV"))
      dataset %<>% left_join(dataset %>%  distinct(ANOENC,NUMERO,FACTOR,GASTOEQV) %>% group_by(ANOENC) %>%
      mutate(CENTLG = cut(GASTOEQV, breaks = epf_centile_groups(GASTOEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(DECILG = cut(GASTOEQV, breaks = epf_decile_groups(GASTOEQV,FACTOR),include.lowest=TRUE,labels=FALSE)) %>%
      mutate(QUNTLG = cut(GASTOEQV, breaks = epf_quintile_groups(GASTOEQV,FACTOR),include.lowest=TRUE,labels=FALSE)),
      by = c("ANOENC","NUMERO","FACTOR","GASTOEQV"))
  }
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
budget_survey_hh_city_GHG <- readRDS(file.path(datasets_path,"budget_survey_hh_city_GHG.rds")) %>% create_groups_epf
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  set.seed(135546) 
  budget_survey_hh_city_GHG %<>% create_groups_epf
  emissions_spending_sim <- data.frame()
  for(group_n in c(seq(9,5,-1))){
    #### [a] estimation of the budget limit
    budget_median <- budget_survey_hh_city_GHG %>% filter(CENTLI>44&CENTLI<56) %>% 
    group_by(ANOENC,CODIGOd3) %>% summarize_at(c("GASTO"),~sum(.*FACTOR,na.rm=TRUE)) %>% 
    group_by(ANOENC) %>% mutate_at(c("GASTO"),~./sum(.,na.rm=TRUE))
    #### [b] imputation of the budget limit
    temp_budget_centile_change <- budget_survey_hh_city_GHG %>% filter(DECILI>group_n) %>%
    distinct(ANOENC,NUMERO,CODIGOd3,FACTOR,HH_HEAT,HH_TRA,HH_OTH,GASTOT,kgGHGTOT,kgGHG) %>%
    left_join(budget_median,by=c("ANOENC","CODIGOd3")) %>% mutate_at(c("GASTO"),~GASTOT*GASTO) %>% rename("kgGHGprior"="kgGHG") %>%
    left_join(budget_survey_hh_city_GHG %>% group_by(ANOENC,CODIGOd3) %>% summarize_at(c("GASTO","kgGHG"),
    ~sum(.,na.rm=TRUE)) %>% mutate(intensity=kgGHG/GASTO) %>% ungroup %>% select(ANOENC,CODIGOd3,kgGHG,intensity),
    by=c("ANOENC","CODIGOd3")) %>% mutate_at(c("kgGHG"),~GASTO*intensity) %>% group_by(ANOENC,NUMERO) %>%
    mutate(kgGHGnew=sum(kgGHG,na.rm=TRUE)) %>% rename("kgGHGpost"="kgGHG","kgGHGold"="kgGHGTOT") %>% ungroup %>% 
    select(ANOENC,NUMERO,CODIGOd3,FACTOR,kgGHGprior,kgGHGpost,kgGHGold,kgGHGnew)
    #### [c] join the rest of the data [I NEED TO JOIN BY YEAR AND IDENTIFIER]
    budget_hh_CO2_new <- budget_survey_hh_city_GHG %>% select(ANOENC,NUMERO,FACTOR,CODIGOd3,GASTO,kgGHG:GASTOT,IMPEXAC,IMPEXACEQV,UC2) %>%
    left_join(temp_budget_centile_change %>% distinct(ANOENC,NUMERO,FACTOR,CODIGOd3,kgGHGpost,kgGHGnew),
    by=c("ANOENC","NUMERO","FACTOR","CODIGOd3")) %>% mutate_at(c("kgGHG"),~if_else(!is.na(kgGHGpost),kgGHGpost,.)) %>%
    mutate_at(c("kgGHGTOT"),~if_else(!is.na(kgGHGnew),kgGHGnew,.))
    coicop_CO2_reduce <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,FACTOR,CODIGOd3,kgGHG) %>% group_by(ANOENC,CODIGOd3) %>% 
    summarize_at(c("kgGHG"),~sum(.*FACTOR,na.rm=TRUE)/1e06) %>% left_join(budget_hh_CO2_new %>% 
    distinct(ANOENC,NUMERO,FACTOR,CODIGOd3,kgGHG) %>% group_by(ANOENC,CODIGOd3) %>% rename("kgGHGnew"="kgGHG") %>%
    summarize_at(c("kgGHGnew"),~sum(.*FACTOR,na.rm=TRUE)/1e06),by=c("ANOENC","CODIGOd3"))
    total_CO2_reduce <- budget_survey_hh_city_GHG %>% distinct(ANOENC,NUMERO,FACTOR,kgGHGTOT) %>% group_by(ANOENC) %>% 
    summarize_at(c("kgGHGTOT"),~sum(.*FACTOR,na.rm=TRUE)/1e06) %>% left_join(budget_hh_CO2_new %>% 
    distinct(ANOENC,NUMERO,FACTOR,kgGHGTOT) %>% group_by(ANOENC) %>% rename("kgGHGTOTnew"="kgGHGTOT") %>%
    summarize_at(c("kgGHGTOTnew"),~sum(.*FACTOR,na.rm=TRUE)/1e06),by=c("ANOENC"))
    #### [d] compute totals and ratios of mitigation 
    temp_emissions_cut <- coicop_CO2_reduce %>% left_join(total_CO2_reduce,by=c("ANOENC")) %>% mutate(group=group_n)
    emissions_spending_sim %<>% bind_rows(temp_emissions_cut)
  }
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
    coicop_reduction_top50_tota <- as.vector(unlist(emissions_spending_sim %>% 
    filter(ANOENC==2019&group==5) %>% distinct(ANOENC,kgGHGTOT) %>% select(-ANOENC)))
    coicop_reduction_top50_totb <- as.vector(unlist(emissions_spending_sim %>% 
    filter(ANOENC==2019&group==5) %>% distinct(ANOENC,kgGHGTOTnew) %>% select(-ANOENC)))
    coicop_reduction_top50_totc <- as.vector(unlist(readRDS(file.path(datasets_path,
    "city_emissions_coicop_gva_sim.rds")) %>% as_tibble() %>% filter(shock==0.5) %>% 
    group_by(code) %>% transmute(kgGHG_sim=rowSums(across(`AR_A`:`ZA_T`),na.rm=TRUE)) %>% 
    ungroup %>% mutate(CODIGOd2=stringr::str_sub(code,1,2)) %>% 
    summarise_at(c("kgGHG_sim"),~sum(.,na.rm=TRUE))))
    
    coicop_reduction_top50 <- readRDS(file.path(datasets_path,
    "city_emissions_coicop_gva_sim.rds")) %>% filter(shock==0.5) %>% group_by(code) %>%
    transmute(kgGHG_sim=rowSums(across(`AR_A`:`ZA_T`),na.rm=TRUE)) %>%
    mutate(CODIGOd2=stringr::str_sub(code,1,2)) %>% group_by(CODIGOd2) %>% 
    summarise_at(c("kgGHG_sim"),~sum(.,na.rm=TRUE)) %>% left_join(emissions_spending_sim %>% 
    filter(ANOENC==2019&group==5) %>% mutate(CODIGOd2=stringr::str_sub(CODIGOd3,1,2)) %>%
    group_by(CODIGOd2) %>% summarise_at(c("kgGHG","kgGHGnew"),~sum(.,na.rm=TRUE)),by=c("CODIGOd2")) %>%
    left_join(code_coicop_d2 %>% distinct(coicop_g2d,coicop_g2d_heading_short) %>%
    rename("heading"="coicop_g2d_heading_short"),by=c("CODIGOd2"="coicop_g2d")) %>%
    pivot_longer(`kgGHG_sim`:`kgGHGnew`,names_to = "type",values_to = "kgGHG") %>%
    mutate_at(c("type"),~case_when(.=="kgGHG"~"actual",.=="kgGHGnew"~"projected",
    .=="kgGHG_sim"~"gvc")) 
    
    #### [a] food
    coicop_reduction_top50_01 <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="01") %>%
    filter(type=="projected") %>% select(kgGHG)))
    coicop_reduction_top50_01_actual <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="01") %>%
    filter(type=="actual") %>% select(kgGHG)))
    coicop_reduction_top50_01_gvc <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="01") %>%
    filter(type=="gvc") %>% select(kgGHG)))
    #### [b] transport
    coicop_reduction_top50_07 <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="07") %>%
    filter(type=="projected") %>% select(kgGHG)))
    coicop_reduction_top50_07_actual <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="07") %>%
    filter(type=="actual") %>% select(kgGHG)))
    coicop_reduction_top50_07_gvc <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="07") %>%
    filter(type=="gvc") %>% select(kgGHG)))
    #### [c] recreation
    coicop_reduction_top50_09 <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="09") %>%
    filter(type=="projected") %>% select(kgGHG)))
    coicop_reduction_top50_09_actual <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="09") %>%
    filter(type=="actual") %>% select(kgGHG)))
    coicop_reduction_top50_09_gvc <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="09") %>%
    filter(type=="gvc") %>% select(kgGHG)))
    #### [d] restaurants
    coicop_reduction_top50_11 <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="11") %>%
    filter(type=="projected") %>% select(kgGHG)))
    coicop_reduction_top50_11_actual <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="11") %>%
    filter(type=="actual") %>% select(kgGHG)))
    coicop_reduction_top50_11_gvc <- as.vector(unlist(coicop_reduction_top50 %>% filter(CODIGOd2=="11") %>%
    filter(type=="gvc") %>% select(kgGHG)))
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
sim_co2_p3_s14_WEST <- readRDS(file.path(datasets_path,"sim_co2_p3_s14_WEST.rds")) %>% filter(cou=="ES30")
sim_co2_p3_s14_ES30 <- readRDS(file.path(datasets_path,"sim_co2_p3_s14_EU_ES30.rds")) %>% filter(cou=="ES30")
sim_co2_p3_s14_EU   <- readRDS(file.path(datasets_path,"sim_co2_p3_s14_EU.rds")) %>% filter(cou=="ES30")
sim_co2_p3_s14_US   <- readRDS(file.path(datasets_path,"sim_co2_p3_s14_US.rds")) %>% filter(cou=="ES30")
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
results_west_05 <- sim_co2_p3_s14_WEST %>% filter(year==2019&shock%in%c(1,0.5)) %>% 
group_by(shock) %>% summarize_at(c("kgC02_eq"),~sum(.,na.rm=TRUE)) %>% 
pivot_wider(names_from="shock",values_from="kgC02_eq") %>% set_names(c("shock","initial")) %>%
mutate(ratio=(`shock`-`initial`)/`initial`)

results_eu_05 <- sim_co2_p3_s14_EU %>% filter(year==2019&shock%in%c(1,0.5)) %>% 
group_by(shock) %>% summarize_at(c("kgC02_eq"),~sum(.,na.rm=TRUE)) %>% 
pivot_wider(names_from="shock",values_from="kgC02_eq") %>% set_names(c("shock","initial")) %>%
mutate(ratio=(`shock`-`initial`)/`initial`)

results_us_05 <- sim_co2_p3_s14_US %>% filter(year==2019&shock%in%c(1,0.5)) %>% 
group_by(shock) %>% summarize_at(c("kgC02_eq"),~sum(.,na.rm=TRUE)) %>% 
pivot_wider(names_from="shock",values_from="kgC02_eq") %>% set_names(c("shock","initial")) %>%
mutate(ratio=(`shock`-`initial`)/`initial`)
```

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
results_west_05_code <- sim_co2_p3_s14_WEST %>% filter(year==2019&shock%in%c(1,0.5)) %>% 
group_by(shock,code) %>% summarize_at(c("kgC02_eq"),~sum(.,na.rm=TRUE)) %>% ungroup %>%
pivot_wider(names_from="shock",values_from="kgC02_eq") %>% set_names(c("code","shock","initial")) %>%
mutate(ratio=(`shock`-`initial`)/`initial`) %>% mutate(share=shock/sum(shock,na.rm=TRUE)) %>%
mutate(cont=ratio*share) %>%
      left_join(readxl::read_xlsx(file.path(datasets_path,"classification_iots_mad.xlsx"),sheet = "City") %>%
      filter(digits_full>2) %>% distinct(nace_code,Definition_short_en),by=c("code"="nace_code")) %>% 
      mutate_at(c("Definition_short_en"),~if_else(code=="Total","Total",.)) %>%
      mutate_at(c("Definition_short_en"),~stringr::str_to_lower(.))

results_eu_05_code <- sim_co2_p3_s14_EU %>% filter(year==2019&shock%in%c(1,0.5)) %>% 
group_by(shock,code) %>% summarize_at(c("kgC02_eq"),~sum(.,na.rm=TRUE)) %>% ungroup %>%
pivot_wider(names_from="shock",values_from="kgC02_eq") %>% set_names(c("code","shock","initial")) %>%
mutate(ratio=(`shock`-`initial`)/`initial`) %>% mutate(share=shock/sum(shock,na.rm=TRUE)) %>%
mutate(cont=ratio*share) %>%
      left_join(readxl::read_xlsx(file.path(datasets_path,"classification_iots_mad.xlsx"),sheet = "City") %>%
      filter(digits_full>2) %>% distinct(nace_code,Definition_short_en),by=c("code"="nace_code")) %>% 
      mutate_at(c("Definition_short_en"),~if_else(code=="Total","Total",.)) %>%
      mutate_at(c("Definition_short_en"),~stringr::str_to_lower(.))

results_us_05_code <- sim_co2_p3_s14_US %>% filter(year==2019&shock%in%c(1,0.5)) %>% 
group_by(shock,code) %>% summarize_at(c("kgC02_eq"),~sum(.,na.rm=TRUE)) %>% ungroup %>%
pivot_wider(names_from="shock",values_from="kgC02_eq") %>% set_names(c("code","shock","initial")) %>%
mutate(ratio=(`shock`-`initial`)/`initial`) %>% mutate(share=shock/sum(shock,na.rm=TRUE)) %>%
mutate(cont=ratio*share) %>%
      left_join(readxl::read_xlsx(file.path(datasets_path,"classification_iots_mad.xlsx"),sheet = "City") %>%
      filter(digits_full>2) %>% distinct(nace_code,Definition_short_en),by=c("code"="nace_code")) %>% 
      mutate_at(c("Definition_short_en"),~if_else(code=="Total","Total",.)) %>%
      mutate_at(c("Definition_short_en"),~stringr::str_to_lower(.))
```

For the first scenario, we obtain an `r format(round(as.vector(unlist(results_west_05$ratio))*100,2), scientific=FALSE)`% decline in emissions when applying a 50% shock to supplies from non Western countries, from `r format(round(as.vector(unlist(results_west_05$initial)),1), scientific=FALSE)` `r ktco2vec` to `r format(round(as.vector(unlist(results_west_05$shock)),1), scientific=FALSE)` `r ktco2vec`. The main industries contributing to this decline are `r format(names_list(as.vector(unlist(results_west_05_code %>% top_n(4,abs(cont)) %>% arrange(-cont) %>% select(Definition_short_en)))),scientific=FALSE)`, with a `r format(names_list(paste0(round(as.vector(unlist(results_west_05_code %>% top_n(4,abs(cont)) %>% arrange(-cont) %>% select(ratio)))*100,1),"%")), scientific=FALSE)`. For the second scenario, total emissions fall down to `r format(round(as.vector(unlist(results_eu_05$shock)),1), scientific=FALSE)` `r ktco2vec`, which is `r format(round(as.vector(unlist(results_eu_05$shock*100/results_west_05$shock)),1), scientific=FALSE)`% of the first scenario. We find the same sectors driving the reduction in emissions, with a `r format(names_list(paste0(round(as.vector(unlist(results_eu_05_code %>% top_n(4,abs(cont)) %>% arrange(-cont) %>% select(ratio)))*100,1),"%")), scientific=FALSE)`, respectively. Lastly, we find that a 50% shock to trade from China filled in by the United States has almost no effect with a `r format(round(as.vector(unlist(results_us_05$ratio))*100,2), scientific=FALSE)`% decline down to `r format(round(as.vector(unlist(results_us_05$shock)),1), scientific=FALSE)` `r ktco2vec`. There is no difference at the sectoral level to highlight. In general, the simulation exercises suggest that the ability of trade policy to have a meaningful impact on total emissions, even when drastic measures are taken, is very limited. Notwithstanding this, trade compounds with the evolution of technology and efficiency in the exporter countries, so it is possible that this may change in the future. 

For the purpose of this simulation using data from `r format(year_end_city, scientific=FALSE)`, the results underscore the overwhelming importance of consumption in determining the slow pace of emissions reduction despite the outstanding gains in efficiency. In this sense, @fig-cf-coicopCO2 shows how many `r ktco2vec` would the city save if we impose the median consumption structure on the top 50% of the equivalized spending distribution. To compare this result with the impact from trade restructuring, we also include one additional simulation scenario in which we reduce by 50% the supplies from all non-EU countries to Madrid and, conversely, fill the gap with imports from the EU alone.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  results_comparison_barplot <- readRDS(file.path(datasets_path,
    "city_emissions_coicop_gva_sim.rds")) %>% filter(shock==0.5) %>% 
    group_by(code) %>% transmute(kgGHG_sim=rowSums(across(`AR_A`:`ZA_T`),na.rm=TRUE)) %>%
    mutate(CODIGOd2=stringr::str_sub(code,1,2)) %>% group_by(CODIGOd2) %>% 
    summarise_at(c("kgGHG_sim"),~sum(.,na.rm=TRUE)) %>% left_join(emissions_spending_sim %>% 
    filter(ANOENC==2019&group==5) %>% mutate(CODIGOd2=stringr::str_sub(CODIGOd3,1,2)) %>%
    group_by(CODIGOd2) %>% summarise_at(c("kgGHG","kgGHGnew"),~sum(.,na.rm=TRUE)),by=c("CODIGOd2")) %>%
    left_join(code_coicop_d2 %>% distinct(coicop_g2d,coicop_g2d_heading_short) %>%
    rename("heading"="coicop_g2d_heading_short"),by=c("CODIGOd2"="coicop_g2d"))

  results_comparison_barplot_3d <- readRDS(file.path(datasets_path,
    "city_emissions_coicop_gva_sim.rds")) %>% filter(shock==0.5) %>% 
    group_by(code) %>% transmute(kgGHG_sim=rowSums(across(`AR_A`:`ZA_T`),na.rm=TRUE)) %>%
    mutate(CODIGOd3=stringr::str_sub(code,1,3)) %>% group_by(CODIGOd3) %>% 
    summarise_at(c("kgGHG_sim"),~sum(.,na.rm=TRUE)) %>% left_join(emissions_spending_sim %>% 
    filter(ANOENC==2019&group==5) %>% mutate(CODIGOd3=stringr::str_sub(CODIGOd3,1,3)) %>%
    group_by(CODIGOd3) %>% summarise_at(c("kgGHG","kgGHGnew"),~sum(.,na.rm=TRUE)),by=c("CODIGOd3")) %>%
    left_join(code_coicop_d3 %>% select(coicop_g3d,ecoicop_g3d_heading) %>% 
    filter(!is.na(ecoicop_g3d_heading)) %>% rename("heading"="ecoicop_g3d_heading"),
    by=c("CODIGOd3"="coicop_g3d")) %>% mutate(CODIGOd2=stringr::str_sub(CODIGOd3,1,2))
```
<!---->

# Discussion and implications {#sec-implications}
By projecting urban-level SUTs and deriving an AEA out of the local inventory we have verified that the speed of the reduction in direct `r co2vec` emissions in the city of Madrid has remained unmatched by the evolution of scope-3 emissions during the period `r format(year_str_io, scientific=FALSE)`-`r format(year_end_city, scientific=FALSE)`. Under the assumption that the regional proportion of imports plus the national distribution of international demand constitute a reasonable approximation to the economic relationship of the city with the outside world, this paper has quantified the city's consumption-based CF in the order of `r format(cf_gdp_tot_2021, scientific=FALSE)` `r ktco2vec` for the city's GDP, from which `r format(cf_gdp_dir_2021, scientific=FALSE)` `r ktco2vec` are direct emissions. We have also estimated the CF from the perspective of the residents' total expenditure and direct activities at `r format(round(house_co2_tot_2021,1), scientific=FALSE)` `r ktco2vec`. In per capita terms, the average city resident emitted `r format(round(house_co2_pc_2021,1), scientific=FALSE)` `r kgGHGvec` in `r format(year_end_city, scientific=FALSE)`. 

These magnitudes differ from but fall in line with the very few available estimations. @andradeImplementingCitylevelCarbon2018, using the PAS2070-DPSC methodology, estimated Madrid's total `r co2vec` emissions in 2010 at 28160 `r ktco2vec` and 8610 `r kgGHGvec` per capita. Whereas direct emissions amount to 7330 `r ktco2vec`, Scope-2 and -3 add up to 4740 `r ktco2vec` and 16080 `r ktco2vec`, respectively. For 2010, using our approach, we find wery similar estimations: `r format(cf_gdp_tot_2010, scientific=FALSE)` `r ktco2vec` for the city's GDP. On the other hand, C40 Cities quantified the total consumption-based greenhouse gas emissions for Madrid in 2011 at 47230 `r ktco2vec` and 14770 `r kgGHGvec` per capita. However, in this case we find a substantially lower estimation of `r format(round(house_co2_tot_2010,1), scientific=FALSE)` `r ktco2vec` driven by household final consumption expenditure. Nonetheless, at a more disaggregated level distributions are similar. @andradeImplementingCitylevelCarbon2018 find that all combined transport industries emit the most at 11440 `r ktco2vec`, but they include also direct emissions by private transport. The industry of food and drinks is estimated at 3550 `r ktco2vec` and construction similarly at 3380 `r ktco2vec`. Instead of looking at industries, C40 provides information by consumption purpose. The ranking of sectors is very similar at 2 digits, but the values are twice as large on average. The available estimations are few, but, more importantly, considerably outdated. Comparatively, this paper presents a whole series groing from `r format(year_str_io, scientific=FALSE)` to `r format(year_end_city, scientific=FALSE)`, in addition to an improved methodology benefitting from more up to date methodology, an GMRIO framework, and a formal process of conversion of the local AEI into a fully-fledged AEA.

Hence, we argue that our estimation improves not only the timeliness but the precision of previous contributions. First, the development of FIGARO's GMRIO database [@remond-tiedrez_eu_2019] and the methodological progress made in the literature [@cazcarro_linking_2022;@wiedmann_concept_2016;@corcoles_carbon_2024] have refined the estimation method and reduced several sources of bias, such as the more rigorous derivation of the final consumption vector or international demand from several regions of the world. Crucially, by parting with the national technology assumption, we have reduced the weight of some overrepresented carbon-intensive industries, such as manufacturing, from direct and indirect emissions [@eea_environmental_2013]. Second, the construction of an AEA for Madrid have fine-tuned our quantification of consumption-based emissions and improved our understanding of emissions derived from household activities. Third, our ability to compute more consistent results for Madrid creates the opportunity for improving the coherence, granularity, and precision of the estimates such that they may enhance local mitigation planning. We consider these improvements a definite step closer to a state of the art CF estimation of the city of Madrid, which should contribute to the design of credible and effective decarbonization commitments by the City Council.

In this regard, we derive three main conclusions from Sections [-@sec-subsec-results-gdp] and [-@sec-subsec-results-households]. First, the geographical distribution of emission sources problematizes the national assumption used in previous estimations. In `r format(year_end_city, scientific=FALSE)`, only `r format(round(cf_2021_Mad*100/cf_gdp_tot_2021,0), scientific=FALSE)`% of emissions came from within the city, while the rest of the nation and the rest of the world contributed `r format(round(cf_2021_RoN*100/cf_gdp_tot_2021,1), scientific=FALSE)`% and `r format(round(cf_2021_RoW*100/cf_gdp_tot_2021,1), scientific=FALSE)`%, respectively. The distribution has shifted slightly since `r format(year_str_io, scientific=FALSE)`, with the rest of the world increasing its share from `r format(round(cf_2010_RoW*100/cf_gdp_tot_2010,1), scientific=FALSE)`% to `r format(round(cf_2021_RoW*100/cf_gdp_tot_2021,1), scientific=FALSE)`% at the expense of the rest of the nation, which accounted for `r format(round(cf_2010_RoN*100/cf_gdp_tot_2010,1), scientific=FALSE)`% of all emissions in 2010. Furthermore, the ability to break indirect emissions down by industries and countries reveals both supply chain reconfiguration dynamics, such as a potentially problematic substitution of imports from China to the United States, and mitigation bottlenecks in the strong dependence from certain country's industrial production.

```{r, eval=TRUE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
table_full_co2_age <- table_full_co2 %>% select(COICOP,`15-34`:`coicop_g2d_heading_short`)
age_50_70_co2_kg <- as.vector(unlist(table_full_co2_age %>% filter(grepl("kg",COICOP)) %>% select(`55-70`)))
age_71_co2_kg <- as.vector(unlist(table_full_co2_age %>% filter(grepl("kg",COICOP)) %>% select(`+71`)))
```

Second, our analysis reveals significant emissions inequality among Madrid's residents, with age, gender, and income quintile playing crucial roles. The top 20% of the spending distribution emitted on average `r format(round(CO2_q5_2021,1), scientific=FALSE)` equivalized `r kgGHGvec` in `r format(year_end_city, scientific=FALSE)`, which is `r format(round(CO2_q5_2021/CO2_q1_2021,1), scientific=FALSE)` times as much as the `r format(round(CO2_q1_2021,0), scientific=FALSE)` `r kgGHGvec` emitted by the bottom 20%. This distributional gap is due to both level and composition changes in consumption patterns across income groups. While healthcare and miscellaneous items show the largest quintile gap, food products and heating have the lowest. In general, we don't find strong differences by demographics, with the exception of the education level and partially the age group of the reference person of the household. Those groupings that overlap with income differentials tend to display larger variation. For the most part, emissions inequality is strongly correlated with income and expenditure inequality. <!--Households with male heads emit on average `r format(ma_co2_kg, scientific=FALSE)` `r kgGHGvec`, which is `r format(round(ma_co2_kg*100/fe_co2_kg,1), scientific=FALSE)`% more than those where the main breadwinner is female. It reflects not only an income gender gap but also differences in consumption patterns, particularly in transport-related emissions. Age groups also show varying emission-causing patterns, with the 55-70 age group having the highest average emissions at `r format(age_50_70_co2_kg, scientific=FALSE)` `r kgGHGvec`, while those over 71 have the lowest at `r format(age_71_co2_kg, scientific=FALSE)` `r kgGHGvec`.-->These findings highlight the need for climate policies that remain sensitive to socio-economic inequalities, gender differences, and age-shapped consumption patterns.

Third, as shown by our two simulation scenarios for consumption expenditure and direct household transport emissions, there is a substantial margin to shrink Madrid's CF by addressing the consumption and mobility choices of high-income households. Instead of focusing on the emissions intensity of foreing-supplied goods, our analysis has highlighted the outstanding potential of domestic policies without targetting consumption *levels*. For instance, we showed that by fixing the median consumption structure above the $50^{th}$ percentile would produce a total emissions savings of `r format(round(coicop_reduction_top50_tota-coicop_reduction_top50_totb,1), scientific=FALSE)` `r ktco2vec` in `r format(year_end_city, scientific=FALSE)`. This is due to the counter-intuitive result that high-income groups spend way more on recreational and personal services that poorer households, which have a considerble indirect emissions footprint. At the same time, we considered the potential of direct mobility policies for emissions curbing. If one in every two households in the top five deciles suppresed their use of private motor vehicles in exchange for carbon-neutral options for travel, we would save `r format(round(emissions_tra_tot_year_end_city-emissions_tra_tot_year_end_city_d5,0), scientific=FALSE)` `r ktco2vec` (`r format(-1*(100-round(emissions_tra_tot_year_end_city_d5*100/emissions_tra_tot_year_end_city,1)), scientific=FALSE)`%). In the extreme and, unfortunately, unrealistic case that this two policies come to fruition simultaneously, the city's CF will decline from `r format(round(house_co2_tot_2021,0), scientific=FALSE)` `r ktco2vec` to  `r format(round(house_co2_tot_2021-emissions_tra_tot_year_end_city_d5-(coicop_reduction_top50_tota-coicop_reduction_top50_totb),0), scientific=FALSE)` `r ktco2vec`, or by `r format(round((1-((house_co2_tot_2021-emissions_tra_tot_year_end_city_d5-(coicop_reduction_top50_tota-coicop_reduction_top50_totb))/house_co2_tot_2021))*100,1), scientific=FALSE)`%.

<!---->
Third, our structural decomposition analysis underscores that consumption is the primary driver of emissions growth, offsetting gains made through efficiency improvements and technological advancements. Between 2013 and 2019, Madrid experienced a decline in total emissions of `r format(round(as.vector(unlist(str_decomposition_plot %>% filter(code=="Total") %>% select(Total))),1), scientific=FALSE)` `r ktco2vec`. This result is driven by a `r format(round(as.vector(unlist(str_decomposition_plot %>% filter(code=="Total") %>% select(Consumption))),1), scientific=FALSE)` `r ktco2vec` increase of final consumption, offset by decreases of `r format(as.vector(unlist(str_decomposition_prct %>% filter(code=="Total") %>% select(Intensity))), scientific=FALSE)`%, `r format(as.vector(unlist(str_decomposition_prct %>% filter(code=="Total") %>% select(Trade))), scientific=FALSE)`%, and `r format(as.vector(unlist(str_decomposition_prct %>% filter(code=="Total") %>% select(Technology))), scientific=FALSE)`%, which are driven by efficiency improvements, changes in trade structure, and technological advancements, respectively. While the smallest contribution comes from changes to the technique of production, the larger emissions savings are realized thanks to efficiency gains. However, these gains are being largely offset by increases in consumption, particularly among higher-income groups. This underscores the need for policies that do not only promote technological progress and efficiency gains but also address consumption patterns. Our simulation exercises further support this, showing that imposing the median consumption structure on the top 50% of the equivalized spending distribution would amount to a reduction of `r format(round(coicop_reduction_top50_tota-coicop_reduction_top50_totb,1), scientific=FALSE)` `r ktco2vec` (`r format(round(abs(coicop_reduction_top50_totb-coicop_reduction_top50_tota)*100/coicop_reduction_top50_tota,1), scientific=FALSE)`%) in 2019, with the largest reductions in transport services, hotels and restaurants, and recreation and culture.
<!---->

We find that these conclusions bear two main policy implications for city decarbonization plans. On the one hand, the global nature of Madrid's CF, whose trans-bordering emissions reached `r format(round(((cf_2021_RoN*100)+(cf_2021_RoW*100))/cf_gdp_tot_2021,0), scientific=FALSE)`% in `r format(year_end_city, scientific=FALSE)`, highlights the need to consider the constraints imposed by global supply chains on emissions curbing plans. Policymakers should promote sustainable procurement practices by encouraging decarbonization efforts of key suppliers, even if the ability to enforce regulation on foreign firms might prove limited and the emissions savings low to moderate. Conversely, the observed shift in emissions from China to the United States between `r format(year_str_io, scientific=FALSE)` and `r format(year_end_city, scientific=FALSE)`, coupled with the outstanding fall in Chinese emission factors, calls into question any long-term plans that do not monitor decarbonization strategies across the world. Particularly if it tries to make virtue out of necessity from emerging geopolitical rivalries between blocks. For the most part, any serious attempt at targeted mitigation policy needs to weigh in on the complicated balance between carbon intensity and growth-pulling industries in highly tertiarized economies. Hotels and restaurants is a case in point. <!--Lastly, the paper provides a methodology for simulating sector- and country-specific interventions that can cast light into local mitigation choke points and project potential gains from suppliers' carbon reductions. We encourage the policy maker to include this projections as part of their plan-monitoring and procurement tools.-->

On the other, we emphasize the need to prioritize consumption in Madrid's mitigation efforts, with a particular focus on high-income households. Our analysis reveals that these groups generate significantly more emissions, especially due to their intense use of private transportation and recreational spending. Targeted policies aimed at reducing emissions from private vehicle use among these high-emitting groups could yield substantial reductions. This could involve a combination of incentives for electric vehicle adoption, improvements in public transport infrastructure, and measures to discourage private car use in urban centers. Additionally, policies addressing consumption patterns of high-income households could lead to significant emissions reductions. Our simulation shows that imposing the median consumption structure on the top 50% of households could reduce emissions by 11.9%, which illustrates the potential impact of such targeted interventions. Furthermore, the city's ability to enforce and implement these policies is crucial. Given the significant emissions inequalities observed, policies should be designed with social equity in mind. Measures that disproportionately burden low-income groups or fail to address the outsized contributions of high-income groups are likely to be both less effective and less socially acceptable. This calls for a nuanced approach that could involved a combination of awareness campaigns, education programs, and fiscal policies to discourage carbon-intensive consumption choices, particularly among high-income groups. While our analysis shows that efficiency improvements and technological advancements are contributing to emissions reductions, these gains are being largely offset by increases in consumption. Our main recommendation for Madrid's mitigation policies is to go beyond traditional supply-side measures and actively address household consumption patterns, which seem to stirr in the opposite direction of decarbonization.

# Conclusions {#sec-conclusions}

This paper has presented the most rigorous quantification of the 3-scope CF of the city of Madrid to date, which is a crucial input to mitigation planning that has been missing. Additionally, it lays down relevant implications for specific policy designs. We provide sectoral data and household distributional information that opens the space for targeted and more sensitive interventions. The empirical results developed in the paper showed the importance of global supply chain constraints and possible trade shocks in monitoring progress of climate change mitigation. <!--By the same token, we have shown that there is a small to null upside benefit from procurement policies at city scale. -->Nonetheless, the evidence collected leads to the recommendation to focus on consumption demand and, from the perspective of households' direct emissions, on private mobility. The latter can be seen to yield a disproportionate amount of emissions reduction, but  consumption demand interventions emerge also as a potentially fruitful policy avenue. In this sense, a primary target for maximum emission savings should be high-emitting groups, which are strongly correlated with high-income households. Most importantly, our methodology and data compilation process lend themselves easily to periodic updates of the main estimates as new information becomes available, potentially becoming part of a timely monitoring dashboard for interested stakeholders.

These results show four main limitations, which create several research opportunities. Firstly, the regional series is limited to a six-year period from 2013 to 2019, which we extend using non-survey techniques to a longer series (`r format(year_str_io, scientific=FALSE)`-`r format(year_end_city, scientific=FALSE)`), mostly limited by the availability of the local emissions inventory. While RSUTs are published with a four-year gap, FIGARO is released with a narrower two-year one. Although coefficient projections add uncertainty, extending the time seires aligns with the recent emphasis on timeliness in statistical production [@oecdOECDHandbookCompilation2024, p. 190]. Secondly, urban economies have a few distinct structural characteristics whose further study could improve the projections made to derive the AEA and IOTs. Specifically, properly representing a highly tertiarized economy, with minimal agricultural production, may benefit from the inclusion of additional information and estimation techniques [@zheng_entropy-based_2022]. Thirdly, more research is needed to understand the possibilities to exploit the distributional carbon gaps identified in @sec-subsec-results-households for mitigation policy. Consumption was identified as a more relevant driver of total emissions than the trade structure, but carbon inequality and transportation are not only the two most important mitigation vectors, but probably the two least difficult to enforce. Lastly, uncertainty evaluation has remained mostly unaddressed in the literature and the official estimations made by the designated statistical agencies [@eea_environmental_2013]. Although challenging, additional sensitivity analysis and uncertainty calculations could increase the reliability of the results presented in this paper, which we seek to continue developing.

**Authorship contribution statement**: 
**Jacobo Ferrer**: conceptualization, research, programming, writing, review & editing, visualization, formal analysis, validation, methodology, data curation. **Sergio Alvarez**: funding acquisition, review & editing, climate science validation.

\newpage
# References {-}
::: {#refs}
:::

\newpage
# Appendix{.appendix .unnumbered}
```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  library(kableExtra)
  code_iots_city %>% filter(type=="sector") %>% distinct(nace_code,Definition_short_en) %>% 
  mutate_at(c("Definition_short_en"),~if_else(grepl("C",nace_code),paste0("Manufacturing of ",
  stringr::str_to_lower(.)),.)) %>% set_names(c("NACE (rev.2)","Industry definition")) %>%
  kbl(booktabs = T,"latex",linesep = "") %>% kable_styling(latex_options = c("hold_position"),
  font_size = 10,full_width = F)
```
\begin{table}[!ht]
\centering\begingroup\fontsize{10}{12}\selectfont
\vspace{-0.25cm}
\begin{tabular}[t]{cl}
\toprule
NACE (rev.2) & Industry definition\\
\midrule
A & Primary activities\\
B\_E & Mining and energy\\
C10\_C12 & Manufacturing of food and beverages\\
C13\_C15 & Manufacturing of clothing and foorwear\\
C16\_C18 & Manufacturing of wood and paper\\
C19\_C21 & Manufacturing of chemical industry\\
C22\_C23 & Manufacturing of plastics \& non-metallics\\
C24\_C25 & Manufacturing of metal and machinery\\
C26\_C27 & Manufacturing of electronics\\
C28 & Manufacturing of other machinery\\
C29\_C30 & Manufacturing of transport equipement\\
C31\_C33 & Manufacturing of furniture and repairs\\
F & Construction\\
G46 & Wholesale\\
G45YG47 & Retail and motor repair\\
H49\_H53 & Transport and storage\\
I & Hotels and restaurants\\
J58\_J63 & ICT activities\\
K64\_K66 & Finance\\
L & Real state\\
M69\_M75 & Professional services\\
N77\_N82 & Administrative services\\
O84 & Public administration\\
P85 & Education\\
Q86\_Q88 & Healthcare\\
R90\_R93 & Culture and recreation\\
S94\_S96 & Other services\\
T & Domestic services\\
\bottomrule
\end{tabular}
\endgroup{}
\vspace{-0.25cm}
\caption{Industry classification adapted to city aggregation (NACE rev.2).}
\end{table}

```{r, eval=FALSE,include=FALSE,message=FALSE,warning=FALSE,cache=TRUE}
  library(kableExtra)
  readxl::read_xlsx(file.path(getwd(),"datasets","hbs_emissions_table.xlsx"),
  col_names = TRUE) %>% mutate_at(c("CODIGOd3","CODIGOd4","CODIGO"),~stringr::str_remove_all(.,fixed("."))) %>%
  pivot_longer(`2007`:`2022`,names_to = "ANOENC",values_to = "INTENSRATIO") %>%
  distinct(ANOENC,CODIGO,CATEGORIA_en,unit,INTENSRATIO) %>% filter(!is.na(CODIGO)) %>%
  mutate_at(c("ANOENC"),~as.double(.)) %>% filter(ANOENC==2021) %>%
  set_names(c("Year","ECOICOP","Heading","unit","Emissions factor")) %>% select(-Year) %>%
  mutate_at(c("Emissions factor"),~round(.,3)) %>% kbl(booktabs = T,"latex") %>% 
  kable_styling(latex_options = c("hold_position"),font_size = 10)
```
\begin{table}[!ht]
\centering\begingroup\fontsize{10}{12}\selectfont
\vspace{-0.25cm}
\begin{tabular}[t]{lllcc}
\toprule
Code & Heading & Unit & Factor\\
\midrule
04521 & Gas (main dwelling) & $m^3$ & 1.919\\
04522 & Gas (other dwellings) & $m^3$ & 1.919\\
04523 & Liquefied gas (main dwelling) & kg & 2.966\\
04524 & Liquefied gas (other dwellings) & kg & 2.966\\
04531 & Liquid fuel (main dwelling) & l & 2.855\\
04532 & Liquid fuel (other dwellings) & l & 2.855\\
04541 & Coal (main dwelling) & kg & 2.239\\
04542 & Coal (other dwellings) & kg & 2.239\\
04548 & Other solid fuels (main dwelling) & kg & 3.109\\
04549 & Other solid fuels (other dwellings) & kg & 3.109\\
07221 & Diesel & l & 2.520\\
07222 & Gasoline & l & 2.249\\
07223 & Other fuels & l & 2.213\\
\bottomrule
\end{tabular}
\endgroup{}
\vspace{-0.25cm}
\caption{Direct emissions factors in $kgCO_2$ per unit of energy good generated by household activities (5-digit ECOICOP). \textit{Source}: Direct emissions factors and conversion of $m^3$ into kWh obtained from MITECO (2023).}
\end{table}